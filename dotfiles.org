#+TITLE: Dotfiles Configuration
#+AUTHOR: James
#+PROPERTY: header-args :mkdirp yes :noweb yes
#+STARTUP: overview

* Shared Configuration
Shared variables and color schemes used across all configurations via noweb syntax.

** Colours
#+name: colours
#+begin_src conf
# Fallback color scheme (Tokyo Night inspired)
set $bg #1a1b26
set $fg #c0caf5
set $accent #7aa2f7
set $urgent #f7768e
set $primary #7aa2f7
set $on_primary #1a1b26
set $primary_container #3d59a1
set $on_primary_container #c0caf5
set $secondary #9d7cd8
set $on_secondary #1a1b26
set $surface #1a1b26
set $on_surface #c0caf5
set $surface_variant #292e42
set $on_surface_variant #a9b1d6
set $surface_dim #16161e
set $error #f7768e
set $on_error #1a1b26
#+end_src
** Variables
#+name: terminal
#+begin_src text
foot
#+end_src

#+name: terminal-float
#+begin_src text
foot --app-id foot-float
#+end_src

#+name: font
#+begin_src text
JetBrainsMono Nerd Font
#+end_src

#+name: font-serif
#+begin_src text
Noto Serif CJK SC
#+end_src

#+name: font-sans
#+begin_src text
Noto Sans CJK SC
#+end_src

#+name: wallpaper
#+begin_src text
~/dotfile/wallpapers/default.jpg
#+end_src
* Window Managers
** Hyprland
Primary Wayland compositor with smooth animations, modern features, and extensive customization.
*** Configuration
**** Variables
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Hyprland Configuration
# See https://wiki.hypr.land/ for more

$mainMod = SUPER
$terminal = <<terminal>>
$terminal-float = <<terminal-float>>
$terminal-float-id = foot-float
$menu = fuzzel
$browser = qutebrowser
$fileManager = foot -e yazi
#+end_src

**** Matugen Colours
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Source Material You colors from matugen
source = ~/.cache/matugen/colors-hyprland.conf
#+end_src

**** Monitor
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Monitor configuration
monitor = eDP-1, 1920x1080@60, 0x0, 1
#+end_src

**** Auto-start
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Execute on launch
exec-once = waybar
exec-once = mako
exec-once = hyprpaper
exec-once = hypridle
exec-once = hyprlock
exec-once = fcitx5
exec-once = light -N 5
exec-once = hyprsunset
exec-once = udiskie
exec-once = wluma
exec-once = kdeconnectd
exec-once = kdeconnect-indicator
exec-once = emacs --daemon &
exec-once = systemctl --user start hyprpolkitagent
exec-once = wl-paste --type text --watch cliphist store
exec-once = wl-paste --type image --watch cliphist store
#+end_src

**** Environment Variables
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Environment variables
env = XCURSOR_SIZE,24
env = XCURSOR_THEME,Human
env = HYPRCURSOR_SIZE,24
env = QT_QPA_PLATFORMTHEME,qt6ct
env = QT_QPA_PLATFORM,wayland
env = EDITOR,emacsclient -c -nw

# Fcitx5
# env = GTK_IM_MODULE,fcitx
env = QT_IM_MODULE,fcitx
env = XMODIFIERS,@im=fcitx
#+end_src

**** Input
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
input {
    kb_layout = us
    kb_options = ctrl:swapcaps

    follow_mouse = 1
    float_switch_override_focus = 1

    touchpad {
        disable_while_typing = true
        natural_scroll = true
        scroll_factor = 0.7
        middle_button_emulation = true
    }

    sensitivity = 0
}
#+end_src

**** General
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
general {
    border_size = 3

    gaps_in = 3
    gaps_out = 5

    layout = dwindle
    allow_tearing = false
    resize_on_border = true
    hover_icon_on_border = true

    snap {
        enabled = true
    }
}
#+end_src
**** Decoration
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
decoration {
    rounding = 0

    active_opacity = 1
    inactive_opacity = 0.75

    dim_modal = false
    dim_special = 0.2

    blur {
        enabled = true
        special = true
        popups = true
        size = 5
        passes = 1
        noise = 0.03
    }

    shadow {
        enabled = false
    }
}
#+end_src
**** Colours
These will be set by Matugen
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
general {
    col.active_border = $primary
    col.inactive_border = $background
}

group {
    col.border_active = $secondary
    col.border_inactive = $secondary_container
    col.border_locked_active = $tertiary
    col.border_locked_inactive = $tertiary_container

    groupbar {
        text_color = $on_secondary
        text_color_inactive = $on_primary_container
        col.active = $secondary
        col.inactive = $secondary_container
        col.locked_active = $tertiary
        col.locked_inactive = $tertiary_container
    }
}
#+end_src
**** Animations
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
animations {
    enabled = true

    # Smooth bezier curves (Material Design inspired)
    bezier = smoothOut, 0.36, 0, 0.66, -0.56
    bezier = smoothIn, 0.25, 1, 0.5, 1
    bezier = overshot, 0.05, 0.9, 0.1, 1.1
    bezier = linear, 0, 0, 1, 1

    # Window animations
    animation = windows, 1, 4, smoothIn, slide
    animation = windowsOut, 1, 4, smoothOut, slide
    animation = windowsMove, 1, 4, smoothIn, slide

    # Border and fade
    animation = border, 1, 10, default
    animation = borderangle, 1, 100, linear, loop
    animation = fade, 1, 4, smoothIn
    animation = fadeOut, 1, 4, smoothOut

    # Workspace animations with slide
    animation = workspaces, 1, 5, overshot, slide

    # Special workspace animations (slide from bottom)
    animation = specialWorkspace, 1, 5, smoothIn, slidevert
}
#+end_src

**** Group
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
group {
    groupbar {
        render_titles = false
        font_family = "<<font>>"
        font_size = 12
        rounding = 0
        indicator_height = 6
        gaps_in = 2
        gaps_out = 3
        keep_upper_gap = false
    }
}
#+end_src
**** Layouts
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
dwindle {
    # pseudotile = true
    # preserve_split = false
    # smart_split = false
    # smart_resizing = true
}

master {
}
#+end_src
**** Gesture
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
gestures {
}
#+end_src
**** Rules
***** Window
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Floating terminal
windowrule = float, class:($terminal-float-id)
windowrule = size 30% 30%, class:($terminal-float-id)
windowrule = move 20 100%-w-20, class:($terminal-float-id)

# # Terminal blur
# windowrulev2 = opacity 0.75 override 0.75 override 1.0 override, class:$terminal # Set opacity to 0.75 active, 0.75 inactive and 1.0 fullscreen for terminal
# windowrule = opacity 0.75 override 0.75 override 1.0 override, class:$terminal-float-id

# Picture-in-Picture
windowrule = float, title:^(Picture-in-Picture)$
windowrule = pin, title:^(Picture-in-Picture)$
windowrule = move 100%-w-20, title:^(Picture-in-Picture)$
windowrule = move 100%-h-20, title:^(Picture-in-Picture)$
windowrule = size 30% 30%, title:^(Picture-in-Picture)$
windowrule = noborder, title:^(Picture-in-Picture)$
windowrule = opacity 1.0 override 1.0 override 1.0 override, title:^(Picture-in-Picture)$

# Floating windows
windowrule = float, class:(blueman-manager)
windowrule = float, class:(pavucontrol)
windowrule = float, class:(Wiremix)
windowrule = size 50% 50%, class:(Wiremix)
windowrule = center, class:(Wiremix)
windowrule = float, class:(nm-connection-editor)
windowrule = float, class:(kdeconnect.*)
windowrule = float, title:(Volume Control)
windowrule = float, class:(blueberry.py)
windowrule = float, class:(org.kde.kdeconnect.daemon)
windowrule = float, title:(File Operation Progress)

# Inhibit idle for fullscreen
windowrule = idleinhibit fullscreen, class:.*

# No focus stealing
windowrule = noinitialfocus, class:(mako)
windowrule = noinitialfocus, title:^(Picture-in-Picture)$

# No transparency
windowrule = opacity 1.0 override 1.0 override 1.0 override, class:(.*)(.exe)
#+end_src

***** Workspace
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Gaps for special workspace (all special workspaces)
workspace = s[yes], gapsin:10, gapsout:20
#+end_src
***** Layer
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Waybar
# layerrule = blur, waybar
# layerrule = blurpopups, waybar
# layerrule = ignorealpha, 1, waybar
#+end_src
**** Keybinding
***** Applications
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Applications
bind = $mainMod, Return, exec, $terminal
# Disabled: Spawning directly to special workspace bypasses waybar toggle, causing inconsistent visibility
# bind = $mainMod SHIFT, Return, exec, [workspace special silent] $terminal
bind = $mainMod SHIFT, Return, exec, $terminal-float
bind = $mainMod, D, exec, $menu
bind = $mainMod, B, exec, $browser
bind = $mainMod SHIFT, B, exec, ~/.local/bin/bitwarden-fuzzel
bind = $mainMod, E, exec, $fileManager
bind = $mainMod, N, exec, emacsclient -c
bind = $mainMod SHIFT, N, exec, emacs
bind = $mainMod CTRL SHIFT, N, exec, killall emacs && emacs --daemon && notify-send "Emacs" "Emacs reloaded successfully."
bind = $mainMod SHIFT, P, exec, ~/.local/bin/select-wallpaper.sh
#+end_src

***** Window Management
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Window management
bind = $mainMod, Q, killactive
bind = $mainMod CTRL, F, fullscreen, 0
bind = $mainMod SHIFT, F, fullscreen, 1
bind = $mainMod, F, togglefloating
bind = $mainMod, Tab, focuscurrentorlast
bind = $mainMod ALT, S, pin

# Layout modes
bind = $mainMod, G, togglegroup
bind = $mainMod SHIFT, G, moveoutofgroup
bind = $mainMod CTRL, G, lockactivegroup, toggle
bind = $mainMod, S, changegroupactive, f
bind = $mainMod, T, cyclenext

# Pseudo-tiling
bind = $mainMod, P, pseudo
#+end_src

***** Navigation
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Focus windows
bind = $mainMod, H, movefocus, l
bind = $mainMod, J, movefocus, d
bind = $mainMod, K, movefocus, u
bind = $mainMod, L, movefocus, r
bind = $mainMod, Left, movefocus, l
bind = $mainMod, Down, movefocus, d
bind = $mainMod, Up, movefocus, u
bind = $mainMod, Right, movefocus, r
#+end_src

***** Moving Windows
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Move windows
bind = $mainMod SHIFT, H, movewindow, l
bind = $mainMod SHIFT, J, movewindow, d
bind = $mainMod SHIFT, K, movewindow, u
bind = $mainMod SHIFT, L, movewindow, r
bind = $mainMod SHIFT, Left, movewindow, l
bind = $mainMod SHIFT, Down, movewindow, d
bind = $mainMod SHIFT, Up, movewindow, u
bind = $mainMod SHIFT, Right, movewindow, r

bind = $mainMod CTRL, H, movewindoworgroup, l
bind = $mainMod CTRL, J, movewindoworgroup, d
bind = $mainMod CTRL, K, movewindoworgroup, u
bind = $mainMod CTRL, L, movewindoworgroup, r
bind = $mainMod CTRL, Left, movewindoworgroup, l
bind = $mainMod CTRL, Down, movewindoworgroup, d
bind = $mainMod CTRL, Up, movewindoworgroup, u
bind = $mainMod CTRL, Right, movewindoworgroup, r

# Move window to output
bind = $mainMod CTRL SHIFT, H, movewindow, mon:l
bind = $mainMod CTRL SHIFT, J, movewindow, mon:d
bind = $mainMod CTRL SHIFT, K, movewindow, mon:u
bind = $mainMod CTRL SHIFT, L, movewindow, mon:r
#+end_src

***** Workspaces
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Switch workspaces
bind = $mainMod, 1, workspace, 1
bind = $mainMod, 2, workspace, 2
bind = $mainMod, 3, workspace, 3
bind = $mainMod, 4, workspace, 4
bind = $mainMod, 5, workspace, 5
bind = $mainMod, 6, workspace, 6
bind = $mainMod, 7, workspace, 7
bind = $mainMod, 8, workspace, 8
bind = $mainMod, 9, workspace, 9

# Move to workspace (without switching)
bind = $mainMod SHIFT, 1, movetoworkspacesilent, 1
bind = $mainMod SHIFT, 2, movetoworkspacesilent, 2
bind = $mainMod SHIFT, 3, movetoworkspacesilent, 3
bind = $mainMod SHIFT, 4, movetoworkspacesilent, 4
bind = $mainMod SHIFT, 5, movetoworkspacesilent, 5
bind = $mainMod SHIFT, 6, movetoworkspacesilent, 6
bind = $mainMod SHIFT, 7, movetoworkspacesilent, 7
bind = $mainMod SHIFT, 8, movetoworkspacesilent, 8
bind = $mainMod SHIFT, 9, movetoworkspacesilent, 9

# Move to workspace and switch
bind = $mainMod CTRL, 1, movetoworkspace, 1
bind = $mainMod CTRL, 2, movetoworkspace, 2
bind = $mainMod CTRL, 3, movetoworkspace, 3
bind = $mainMod CTRL, 4, movetoworkspace, 4
bind = $mainMod CTRL, 5, movetoworkspace, 5
bind = $mainMod CTRL, 6, movetoworkspace, 6
bind = $mainMod CTRL, 7, movetoworkspace, 7
bind = $mainMod CTRL, 8, movetoworkspace, 8
bind = $mainMod CTRL, 9, movetoworkspace, 9

# Special workspace (scratchpad replacement)
# Toggle special workspace and hide/show waybar (SIGUSR1 signal)
bind = $mainMod, w, togglespecialworkspace
bind = $mainMod, w, exec, pkill -SIGUSR1 waybar
# Move window to special and toggle waybar
bind = $mainMod SHIFT, w, movetoworkspace, special
bind = $mainMod SHIFT, w, exec, pkill -SIGUSR1 waybar
#+end_src

***** Hardware
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Volume controls
bind = , XF86AudioRaiseVolume, exec, ~/.local/bin/volume-notify up
bind = , XF86AudioLowerVolume, exec, ~/.local/bin/volume-notify down
bind = , XF86AudioMute, exec, ~/.local/bin/volume-notify mute
bind = , XF86AudioMicMute, exec, pamixer --default-source -t

# Brightness controls
bind = , XF86MonBrightnessUp, exec, ~/.local/bin/brightness-notify up
bind = , XF86MonBrightnessDown, exec, ~/.local/bin/brightness-notify down

# Screenshots
bind = , Print, exec, ~/.local/bin/screenshot.sh
bind = $mainMod SHIFT, S, exec, ~/.local/bin/screenshot.sh
bind = SHIFT, Print, exec, ~/.local/bin/screenshot.sh screen
bind = $mainMod SHIFT CTRL, S, exec, ~/.local/bin/screenshot.sh screen

# Laptop Lid
bindl = , switch:on:[Lid Switch], exec, systemctl suspend
#+end_src

***** Utilities
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Lock screen (clears Bitwarden session and cache before locking)
bind = $mainMod, Escape, exec, rm -f ${XDG_RUNTIME_DIR:-/tmp}/bw_session ${XDG_RUNTIME_DIR:-/tmp}/bw_cache && loginctl lock-session

# Notifications
bind = $mainMod, M, exec, makoctl restore
bind = $mainMod CTRL, M, exec, makoctl dismiss
bind = $mainMod SHIFT, M, exec, ~/.local/bin/mako-actions
bind = $mainMod CTRL SHIFT, M, exec, makoctl list

# Network manager
bind = $mainMod SHIFT, I, exec, networkmanager_dmenu

# Colour picker
bind = $mainMod, C, exec, hyprpicker -a

# Color temperature
bind = $mainMod SHIFT, T, exec, ~/.local/bin/hyprsunset-menu

# Clipboard manager
bind = $mainMod SHIFT, V, exec, cliphist list | fuzzel --dmenu --width 50 --placeholder "Search in clipboard" | cliphist decode | wl-copy
bind = $mainMod CTRL SHIFT, V, exec, cliphist wipe | notify-send "Cliboard" "Clipboard history has been cleared."

# Help menu
bind = $mainMod, slash, exec, ~/.local/bin/help-menu
#+end_src

***** Resizing
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Resize mode
bind = $mainMod, R, submap, resize
submap = resize

binde = , H, resizeactive, -15 0
binde = , J, resizeactive, 0 15
binde = , K, resizeactive, 0 -15
binde = , L, resizeactive, 15 0
binde = , Left, resizeactive, -15 0
binde = , Down, resizeactive, 0 15
binde = , Up, resizeactive, 0 -15
binde = , Right, resizeactive, 15 0

bind = , Return, submap, reset
bind = , Escape, submap, reset

submap = reset
#+end_src

***** Gestures
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Horizontal swipe for workspace navigation
gesture = 3, horizontal, workspace

# Vertical swipe for special workspace
gesture = 3, down, dispatcher, exec, hyprctl dispatch togglespecialworkspace && pkill -SIGUSR1 waybar
#+end_src

***** System
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# System controls
bind = $mainMod SHIFT, C, exec, ~/.local/bin/hyprland-reload
bind = $mainMod SHIFT, Q, exit
bind = $mainMod SHIFT, R, exec, ~/dotfile/scripts/tangle.sh & notify-send "Dotfiles" "Dotfiles tangled successfully!"
#+end_src

***** Mouse
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
# Mouse bindings
bindm = $mainMod, mouse:272, movewindow
bindm = $mainMod, mouse:273, resizewindow
bindm = $mainMod, z, resizewindow
#+end_src

**** Misc
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprland.conf
misc {
    force_default_wallpaper = 0
    disable_hyprland_logo = true
    disable_splash_rendering = true
    mouse_move_enables_dpms = true
    key_press_enables_dpms = true
    # Keep special workspace open when empty (prevents returning to normal workspace without waybar)
    close_special_on_empty = false
    vrr = 0
}

cursor {
    # Warp cursor when toggling special workspace for better UX
    warp_on_toggle_special = 1
}

ecosystem {
    no_donation_nag = true
}
#+end_src

*** Hyprland Ecosystem
**** Hyprpaper
Wallpaper manager for Hyprland.
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprpaper.conf
# Hyprpaper Configuration
# Wallpaper daemon for Hyprland

preload = <<wallpaper>>
wallpaper = , <<wallpaper>>

splash = false
ipc = on
#+end_src

**** Hypridle
Idle management daemon for Hyprland.
#+begin_src conf :tangle packages/hyprland/.config/hypr/hypridle.conf
# Hypridle Configuration
# Idle management daemon for Hyprland

general {
    lock_cmd = pidof hyprlock || hyprlock
    before_sleep_cmd = loginctl lock-session && rm -f ${XDG_RUNTIME_DIR:-/tmp}/bw_session ${XDG_RUNTIME_DIR:-/tmp}/bw_cache
    after_sleep_cmd = hyprctl dispatch dpms on
    ignore_dbus_inhibit = false
}

# Screen off (5 minutes on battery, 10 minutes on AC)
listener {
    timeout = 300
    on-timeout = hyprctl dispatch dpms off
    on-resume = hyprctl dispatch dpms on
}

# Lock screen (10 minutes on battery, 15 minutes on AC)
listener {
    timeout = 600
    on-timeout = loginctl lock-session && rm -f ${XDG_RUNTIME_DIR:-/tmp}/bw_session ${XDG_RUNTIME_DIR:-/tmp}/bw_cache
}

# Suspend then hibernate (30 minutes on battery, 60 minutes on AC)
# Will suspend immediately, then automatically hibernate after 2 hours
# This provides fast wake for short suspends, zero power drain for long suspends
listener {
    timeout = 1800
    on-timeout = systemctl suspend-then-hibernate
}
#+end_src
**** Hyprlock
Lock screen utility for Hyprland.
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprlock.conf
# Hyprlock Configuration
# Screen lock for Hyprland

# Source Material You colors
source = ~/.cache/matugen/colors-hyprlock.conf

general {
    hide_cursor = true
    disable_loading_bar = false
    grace = 0
}

background {
    monitor =
    path = <<wallpaper>>
    zindex = -1
}

input-field {
    monitor =
    size = 150, 50
    outline_thickness = 3

    dots_size = 0.25
    dots_spacing = 0.75
    dots_rounding = 0

    outer_color = $primary
    inner_color = $surface
    font_color = $on_surface
    font_family = <<font>>

    fade_on_empty = false

    placeholder_text = ENTER PIN

    rounding = 0

    check_color = $tertiary
    fail_color = $error
    fail_text = Authentication Failed

    position = 0, 0
    halign = center
    valign = center

    zindex = 1
}
#+end_src
**** Hyprsunset
Blue light filter / color temperature control for Hyprland.
#+begin_src conf :tangle packages/hyprland/.config/hypr/hyprsunset.conf
profile {
    time = 7:30
    identity = true
}

profile {
    time = 14:00
    temperature = 5500
}

profile {
    time = 16:00
    temperature = 4500
}

profile {
    time = 18:00
    temperature = 3500
}

profile {
    time = 20:00
    temperature = 2500
}
#+end_src
** Sway
Alternative i3-compatible Wayland compositor with mature stability and broad support.
*** Variables
#+begin_src conf :tangle packages/sway/.config/sway/config
set $mod Mod4
set $term <<terminal>>

# Fallback colors (defined first, will be overridden by matugen)
<<colors>>

# Source matugen colors if available (overrides fallback)
include /home/james/.cache/matugen/colors-sway
#+end_src

*** Input
#+begin_src conf :tangle packages/sway/.config/sway/config
input type:keyboard {
    xkb_layout us
    xkb_options ctrl:swapcaps
}

input type:touchpad {
    tap enabled
    natural_scroll enabled
    scroll_factor 0.7
    accel_profile adaptive
    middle_emulation enabled
    dwt enabled
}

input type:pointer {
    dwt enabled
}
#+end_src

*** Output
#+begin_src conf :tangle packages/sway/.config/sway/config
output eDP-1 mode 1920x1080@60Hz position 0,0
#+end_src

*** Appearance
#+begin_src conf :tangle packages/sway/.config/sway/config
gaps inner 5
gaps outer 0

default_border normal 3
default_floating_border normal 3

# Title bar format showing window info
title_align center
for_window [all] title_format "%title"
titlebar_padding 5 2

# Window colors: border, background, text, indicator, child_border
# The indicator (4th value) shows where new windows will appear
# The child_border (5th value) is the actual border color you see
client.focused $primary $primary $on_primary $accent $primary
client.focused_inactive $surface_variant $surface_variant $on_surface_variant $surface_dim $surface_variant
client.focused_tab_title $primary $primary $on_primary $primary $primary
client.unfocused $surface_dim $surface_dim $on_surface $surface_dim $surface_dim
client.urgent $error $error $on_error $error $error
client.placeholder $surface_dim $surface_dim $on_surface $surface_dim $surface_dim
#+end_src

*** Behaviour
#+begin_src conf :tangle packages/sway/.config/sway/config
# Focus follows mouse
focus_follows_mouse yes
focus_wrapping workspace

# Don't auto-focus certain windows
no_focus [window_type="notification"]
no_focus [title="Picture-in-Picture"]

# Mouse bindings - Mod+drag to move, Mod+right-drag to resize
floating_modifier $mod normal
#+end_src

*** Window Rules
#+begin_src conf :tangle packages/sway/.config/sway/config
# Picture-in-Picture windows
for_window [title="Picture-in-Picture"] floating enable, border none, move position 10 ppt 10 ppt, sticky enable

# Floating scratchpad terminal
for_window [app_id="floating-foot"] floating enable, resize set 50 ppt 50 ppt, move position center, move scratchpad, scratchpad show

# Floating applications
for_window [app_id="blueberry.py"] floating enable
for_window [app_id="blueman-manager"] floating enable
for_window [app_id="pavucontrol"] floating enable
for_window [app_id="fcitx5-config-qt"] floating enable
for_window [class="Bitwarden"] floating enable
for_window [app_id="LanMouse"] floating enable
for_window [app_id="org.kde.kdeconnect.*"] floating enable
for_window [class="prismlauncher"] floating enable
for_window [app_id="nm-connection-editor"] floating enable
#+end_src

*** Auto-start
#+begin_src conf :tangle packages/sway/.config/sway/config
# Wayland essentials
exec swaybg -i <<wallpaper>> -m fill
exec mako
exec waybar

# System utilities
exec fcitx5
exec light -N 5
exec wlsunset -l 51.5 -L 0.1
exec ~/.local/bin/start-swayidle.sh

# Tiling enhancements
exec_always autotiling

# User applications
exec udiskie
exec wluma
exec kdeconnectd
exec kdeconnect-indicator
#+end_src

*** Keybindings
**** Launch Programs
#+begin_src conf :tangle packages/sway/.config/sway/config
bindsym $mod+Return exec $term
bindsym $mod+Shift+Return exec $term --app-id=floating-foot
bindsym $mod+d exec fuzzel
bindsym $mod+b exec qutebrowser
bindsym $mod+Shift+b exec ~/.local/bin/bitwarden-fuzzel
bindsym $mod+y exec $term -e yazi
bindsym $mod+n exec emacsclient -c
bindsym $mod+Shift+n exec emacs
bindsym $mod+p exec ~/.local/bin/select-wallpaper.sh
#+end_src

**** Window Management
#+begin_src conf :tangle packages/sway/.config/sway/config
bindsym $mod+q kill
bindsym $mod+Shift+Ctrl+f fullscreen toggle
bindsym $mod+Shift+f fullscreen toggle global
bindsym $mod+f floating toggle
bindsym $mod+Tab focus mode_toggle
bindsym $mod+Alt+s sticky toggle

# Layout modes (i3 standard)
bindsym $mod+w layout tabbed
bindsym $mod+s layout stacking
bindsym $mod+e layout toggle split
bindsym $mod+t layout toggle all

# Split directions
bindsym $mod+v split vertical
bindsym $mod+minus split horizontal
#+end_src

**** Navigation
#+begin_src conf :tangle packages/sway/.config/sway/config
bindsym $mod+h focus left
bindsym $mod+j focus down
bindsym $mod+k focus up
bindsym $mod+l focus right
bindsym $mod+Left focus left
bindsym $mod+Down focus down
bindsym $mod+Up focus up
bindsym $mod+Right focus right
#+end_src
**** Moving Windows
#+begin_src conf :tangle packages/sway/.config/sway/config
# Move window in direction (i3 standard)
bindsym $mod+Shift+h move left
bindsym $mod+Shift+j move down
bindsym $mod+Shift+k move up
bindsym $mod+Shift+l move right
bindsym $mod+Shift+Left move left
bindsym $mod+Shift+Down move down
bindsym $mod+Shift+Up move up
bindsym $mod+Shift+Right move right

# Move window to output
bindsym $mod+Ctrl+Shift+h move output left
bindsym $mod+Ctrl+Shift+j move output down
bindsym $mod+Ctrl+Shift+k move output up
bindsym $mod+Ctrl+Shift+l move output right
bindsym $mod+Ctrl+Shift+Left move output left
bindsym $mod+Ctrl+Shift+Down move output down
bindsym $mod+Ctrl+Shift+Up move output up
bindsym $mod+Ctrl+Shift+Right move output right
#+end_src

**** Window Swapping (Disabled)
# This section contains alternative window swapping keybindings that were replaced
# by the simpler move keybindings in the previous section. Kept here for reference.
#+begin_src conf :tangle no
# Swap windows in direction (Hyprland-like behavior)
bindsym $mod+Ctrl+h mark --add _swap, focus left, swap container with mark _swap, unmark _swap, focus left
bindsym $mod+Ctrl+j mark --add _swap, focus down, swap container with mark _swap, unmark _swap, focus down
bindsym $mod+Ctrl+k mark --add _swap, focus up, swap container with mark _swap, unmark _swap, focus up
bindsym $mod+Ctrl+l mark --add _swap, focus right, swap container with mark _swap, unmark _swap, focus right
bindsym $mod+Ctrl+Left mark --add _swap, focus left, swap container with mark _swap, unmark _swap, focus left
bindsym $mod+Ctrl+Down mark --add _swap, focus down, swap container with mark _swap, unmark _swap, focus down
bindsym $mod+Ctrl+Up mark --add _swap, focus up, swap container with mark _swap, unmark _swap, focus up
bindsym $mod+Ctrl+Right mark --add _swap, focus right, swap container with mark _swap, unmark _swap, focus right

# Move window to output
bindsym $mod+Ctrl+Shift+h move output left
bindsym $mod+Ctrl+Shift+j move output down
bindsym $mod+Ctrl+Shift+k move output up
bindsym $mod+Ctrl+Shift+l move output right
bindsym $mod+Ctrl+Shift+Left move output left
bindsym $mod+Ctrl+Shift+Down move output down
bindsym $mod+Ctrl+Shift+Up move output up
bindsym $mod+Ctrl+Shift+Right move output right
#+end_src

**** Workspaces
#+begin_src conf :tangle packages/sway/.config/sway/config
# Switch to workspace
bindsym $mod+1 workspace number 1
bindsym $mod+2 workspace number 2
bindsym $mod+3 workspace number 3
bindsym $mod+4 workspace number 4
bindsym $mod+5 workspace number 5
bindsym $mod+6 workspace number 6
bindsym $mod+7 workspace number 7
bindsym $mod+8 workspace number 8
bindsym $mod+9 workspace number 9

# Move to workspace (without switching)
bindsym $mod+Shift+1 move container to workspace number 1
bindsym $mod+Shift+2 move container to workspace number 2
bindsym $mod+Shift+3 move container to workspace number 3
bindsym $mod+Shift+4 move container to workspace number 4
bindsym $mod+Shift+5 move container to workspace number 5
bindsym $mod+Shift+6 move container to workspace number 6
bindsym $mod+Shift+7 move container to workspace number 7
bindsym $mod+Shift+8 move container to workspace number 8
bindsym $mod+Shift+9 move container to workspace number 9

# Move to workspace and switch
bindsym $mod+Ctrl+1 move container to workspace number 1; workspace number 1
bindsym $mod+Ctrl+2 move container to workspace number 2; workspace number 2
bindsym $mod+Ctrl+3 move container to workspace number 3; workspace number 3
bindsym $mod+Ctrl+4 move container to workspace number 4; workspace number 4
bindsym $mod+Ctrl+5 move container to workspace number 5; workspace number 5
bindsym $mod+Ctrl+6 move container to workspace number 6; workspace number 6
bindsym $mod+Ctrl+7 move container to workspace number 7; workspace number 7
bindsym $mod+Ctrl+8 move container to workspace number 8; workspace number 8
bindsym $mod+Ctrl+9 move container to workspace number 9; workspace number 9

# Scratchpad
bindsym $mod+grave scratchpad show
bindsym $mod+Shift+grave move scratchpad
#+end_src

**** Hardware
#+begin_src conf :tangle packages/sway/.config/sway/config
bindsym XF86AudioRaiseVolume exec ~/.local/bin/volume-notify up
bindsym XF86AudioLowerVolume exec ~/.local/bin/volume-notify down
bindsym XF86AudioMute exec ~/.local/bin/volume-notify mute
bindsym XF86AudioMicMute exec pamixer --default-source -t

bindsym XF86MonBrightnessUp exec ~/.local/bin/brightness-notify up
bindsym XF86MonBrightnessDown exec ~/.local/bin/brightness-notify down

# Screenshot with fuzzel menu
bindsym Print exec ~/.local/bin/screenshot.sh
bindsym $mod+Shift+s exec ~/.local/bin/screenshot.sh

# Quick screenshot (full screen, copy & save)
bindsym Shift+Print exec ~/.local/bin/screenshot.sh screen
bindsym $mod+Shift+Ctrl+s exec ~/.local/bin/screenshot.sh screen
#+end_src

**** Notifications
#+begin_src conf :tangle packages/sway/.config/sway/config
bindsym $mod+m exec makoctl invoke
bindsym $mod+Ctrl+m exec makoctl dismiss
bindsym $mod+Shift+m exec makoctl menu fuzzel
#+end_src

**** Utilities
#+begin_src conf :tangle packages/sway/.config/sway/config
# Lock screen
bindsym $mod+Escape exec rm -f ${XDG_RUNTIME_DIR:-/tmp}/bw_session ${XDG_RUNTIME_DIR:-/tmp}/bw_cache && swaylock

# Clipboard history
bindsym $mod+Shift+v exec cliphist list | fuzzel --dmenu | cliphist decode | wl-copy

# Help menu
bindsym $mod+slash exec ~/.local/bin/help-menu
#+end_src

**** Resizing
#+begin_src conf :tangle packages/sway/.config/sway/config
# Resize mode (use Mod+r to enter)
mode "resize" {
    bindsym h resize shrink width 15px
    bindsym j resize grow height 15px
    bindsym k resize shrink height 15px
    bindsym l resize grow width 15px

    bindsym Left resize shrink width 15px
    bindsym Down resize grow height 15px
    bindsym Up resize shrink height 15px
    bindsym Right resize grow width 15px

    bindsym Return mode "default"
    bindsym Escape mode "default"
}

bindsym $mod+r mode "resize"
#+end_src

**** Gestures
#+begin_src conf :tangle packages/sway/.config/sway/config
# Workspace navigation
bindgesture swipe:3:right workspace prev
bindgesture swipe:3:left workspace next

# Scratchpad (down gesture)
bindgesture swipe:3:down scratchpad show
#+end_src

**** System
#+begin_src conf :tangle packages/sway/.config/sway/config
bindsym $mod+Shift+c reload; exec sh -c 'pkill waybar; pkill mako; sleep 0.2; waybar & mako & notify-send "Sway" "Configuration reloaded successfully" -u low'
bindsym $mod+Shift+q exec swaynag -t warning -m 'Exit sway?' -B 'Yes' 'swaymsg exit'
#+end_src

**** Lid Switch
#+begin_src conf :tangle packages/sway/.config/sway/config
# Lid close: turn off screen, lock, and sleep
bindswitch --reload --locked lid:on exec 'swaymsg "output * dpms off" && swaylock && systemctl suspend'

# Lid open: wake screen
bindswitch --reload --locked lid:off exec 'swaymsg "output * dpms on"'
#+end_src


*** Sway Ecosystem

*** Swaylock
Lock screen utility for Sway.

#+begin_src conf :tangle packages/swaylock/.config/swaylock/config
color=1a1b26
#+end_src

*** Swayidle
Idle management daemon for Sway.


**** Swayidle Launcher Script
#+begin_src sh :tangle packages/swayidle/.local/bin/start-swayidle.sh :shebang "#!/usr/bin/env bash"
# Kill any existing swayidle instances
pkill swayidle

# Check if on battery or AC
if [ -d /sys/class/power_supply/AC ] || [ -d /sys/class/power_supply/AC0 ] || [ -d /sys/class/power_supply/ACAD ]; then
    # Find the AC adapter
    AC_PATH=$(find /sys/class/power_supply -name 'AC*' -o -name 'ACAD' | head -n 1)

    if [ -n "$AC_PATH" ] && [ "$(cat $AC_PATH/online)" = "0" ]; then
        # On battery - suspend after 30 min, then hibernate after 2 hours
        swayidle -w \
            timeout 300 'swaymsg "output * dpms off"' \
            resume 'swaymsg "output * dpms on"' \
            timeout 600 'swaylock' \
            timeout 1800 'systemctl suspend-then-hibernate'
    else
        # Plugged in - suspend after 60 min, then hibernate after 2 hours
        swayidle -w \
            timeout 600 'swaymsg "output * dpms off"' \
            resume 'swaymsg "output * dpms on"' \
            timeout 900 'swaylock' \
            timeout 3600 'systemctl suspend-then-hibernate'
    fi
else
    # Fallback if no AC adapter found (desktop)
    swayidle -w \
        timeout 600 'swaymsg "output * dpms off"' \
        resume 'swaymsg "output * dpms on"' \
        timeout 900 'swaylock'
fi
#+end_src

* Applications
** Waybar
Status bar configuration for different window managers.
*** Hyprland
Status bar configured for Hyprland with custom modules and styling.
**** Configuration
#+begin_src json :tangle packages/hyprland/.config/waybar/config
{
    "reload_style_on_change": true,
    "layer": "top",
    "position": "top",
    "height": 30,
    "spacing": 0,
    "margin-top": 0,
    "margin-bottom": 0,
    "margin-left": 0,
    "margin-right": 0,

    "modules-left": ["idle_inhibitor", "hyprland/workspaces", "privacy"],

    "modules-center": ["custom/pomodoro", "clock", "custom/update"],

    "modules-right": [
        "group/tray-expander",
        "cpu",
        "memory",
        "bluetooth",
        "network",
        "pulseaudio",
        "custom/backlight",
        "custom/battery"
    ],

    "idle_inhibitor": {
        "format": "{icon}",
        "format-icons": {
            "activated": "󰅶",
            "deactivated": "󰾪"
        },
        "tooltip-format-activated": "Idle Inhibitor: Active",
        "tooltip-format-deactivated": "Idle Inhibitor: Inactive"
    },

    "hyprland/workspaces": {
        "on-click": "activate",
        "show-special": true,
        "format": "{icon}",
        "format-icons": {
            "default": "",
            "1": "1",
            "2": "2",
            "3": "3",
            "4": "4",
            "5": "5",
            "6": "6",
            "7": "7",
            "8": "8",
            "9": "9",
            "active": "",
            "urgent": "",
            "special": ""
        },
        "persistent-workspaces": {
            "1": [],
            "2": [],
            "3": [],
            "4": [],
            "5": [],
            "6": [],
            "7": [],
            "8": [],
            "9": []
        }
    },

    "privacy": {
        "icon-spacing": 20,
        "icon-size": 10,
        "transition-duration": 250,
        "modules": [
            {
                "type": "screenshare",
                "tooltip": true,
                "tooltip-icon-size": 18
            },
            {
                "type": "audio-in",
                "tooltip": true,
                "tooltip-icon-size": 18
            },
            {
                "type": "audio-out",
                "tooltip": true,
                "tooltip-icon-size": 18
            }
        ]
    },

    "custom/pomodoro": {
        "format": "{alt} {text}",
        "exec": "~/.local/bin/waybar-pomodoro",
        "return-type": "json",
        "interval": 1,
        "on-click": "~/.local/bin/waybar-pomodoro toggle",
        "on-click-right": "~/.local/bin/waybar-pomodoro reset"
    },

    "clock": {
        "format": "{:L%A %H:%M}",
        "format-alt": "{:L%d %B W%V %Y}",
        "tooltip-format": "<tt>{calendar}</tt>",
        "calendar": {
            "mode": "month",
            "mode-mon-col": 3,
            "weeks-pos": "left",
            "on-scroll": 1,
            "on-click-right": "mode",
            "format": {
              "today": "<b><u>{}</u></b>"
            }
        },
        "actions": {
            "on-click-right": "mode",
            "on-scroll-up": "shift_up",
            "on-scroll-down": "shift_down"
        }
    },

    "custom/update": {
        "format": "{}",
        "exec": "~/.local/bin/waybar-updates",
        "on-click": "foot --app-id=floating-foot -e sh -c 'yay -Syu && echo && echo Done! Press Enter to close && read'",
        "return-type": "json",
        "interval": 3600,
        "signal": 7
    },

    "cpu": {
        "interval": 5,
        "format": "󰍛",
        "tooltip-format": "CPU: {usage}%",
        "on-click": "foot --app-id=floating-foot -e btop"
    },

    "memory": {
        "interval": 5,
        "format": "󰘚",
        "tooltip-format": "RAM: {used:0.1f}G / {total:0.1f}G ({percentage}%)",
        "on-click": "foot --app-id=floating-foot -e btop"
    },

    "network": {
        "format-icons": ["󰤯", "󰤟", "󰤢", "󰤥", "󰤨"],
        "format": "{icon}",
        "format-wifi": "{icon}",
        "format-ethernet": "󰀂",
        "format-disconnected": "󰤮",
        "tooltip-format-wifi": "{essid} ({frequency} GHz)\n⇣{bandwidthDownBytes}  ⇡{bandwidthUpBytes}",
        "tooltip-format-ethernet": "Wired\n⇣{bandwidthDownBytes}  ⇡{bandwidthUpBytes}",
        "tooltip-format-disconnected": "Disconnected",
        "interval": 3,
        "on-click": "networkmanager_dmenu"
    },

    "bluetooth": {
        "format": "",
        "format-disabled": "󰂲",
        "format-connected": "",
        // "format-connected-battery": "{icon}",
        // "format-icons": {
        //     "connected-battery": ["󰤾", "󰤿", "󰥀", "󰥁", "󰥂", "󰥃", "󰥄", "󰥅", "󰥆", "󰥈" ]
        // },
        "tooltip-format": "Bluetooth: {num_connections} connected",
        "on-click": "blueman-manager"
    },

    "pulseaudio": {
        "format": "{icon}",
        "format-muted": "",
        "format-icons": {
            "default": ["", "", "", "", "", "", "", "", "", ""]
        },
        "tooltip-format": "Volume: {volume}%",
        "scroll-step": 5,
        "on-click": "<<terminal-float>> wiremix",
        "on-click-right": "pamixer -t"
    },

    "custom/backlight": {
        "format": "{alt}",
        "exec": "~/.local/bin/waybar-backlight",
        "return-type": "json",
        "interval": 2,
        "on-click": "~/.local/bin/hyprsunset-menu"
    },

    "custom/battery": {
        "format": "{}",
        "exec": "~/.local/bin/waybar-battery",
        "return-type": "json",
        "interval": 10
    },

    "group/tray-expander": {
        "orientation": "inherit",
        "drawer": {
            "transition-duration": 600,
            "children-class": "tray-group-item"
        },
        "modules": ["custom/expand-icon", "tray"]
    },

    "custom/expand-icon": {
        "format": "󰇙",
        "tooltip": false
    },

    "tray": {
        "icon-size": 12,
        "spacing": 30
    }
}
#+end_src

**** Styling
#+begin_src css :tangle packages/hyprland/.config/waybar/style.css
. * {
  border: none;
  font-family: <<font>>;
  font-weight: bold;
  font-size: 14px;
  border-radius: 0;
  min-height: 0;
}

@import url("/home/james/.cache/matugen/colors-waybar.css");

window#waybar {
  background: alpha(@background, 0.8);
  color: @foreground;
}

/* Tooltip styling */
#tooltip {
  background: @background;
  border: 2px solid @primary;
  color: @on_surface;
}

#tooltip label {
  color: @on_surface;
}

/* Left section - idle inhibitor and workspaces */
.modules-left {
    margin-left: 5px;
}

#idle_inhibitor {
    margin:0 10px;
}

#idle_inhibitor.activated {
  color: @primary;
}

#workspaces {
    margin-left: 2px;
}

#workspaces button {
  all: initial;
  padding: 0 5px;
  margin: 0 5px;
  color: @foreground;
}

#workspaces button.active {
  color: @primary;
}

#workspaces button.special {
  color: @secondary;
}

#workspaces button.urgent {
  color: @error;
}

#workspaces button:hover {
  color: @primary;
}

#workspaces button.empty {
    opacity: 0.5;
}

#privacy {
    margin: 0 10px;
    color: @error;
}

/* Center section */

#custom-pomodoro {
    margin: 0 10px;
    color: @on_surface;
}

#custom-pomodoro.work {
    color: @primary;
}

#custom-pomodoro.break {
    color: @secondary;
}

#custom-pomodoro.paused {
    color: @on_surface_variant;
    opacity: 0.7;
}

#custom-pomodoro.idle {
    opacity: 0.5;
}

#clock {
  margin: 0 10px;
}

#custom-update {
  margin: 0 10px;
}

#custom-update.updates {
  color: @tertiary;
}

/* Right section - system info modules */
.modules-right {
    margin-right: 5px;
}

#cpu,
#memory,
#network,
#bluetooth,
#pulseaudio,
#backlight,
#custom-backlight,
#custom-battery {
    margin: 0 15px;
}

/* Expandable tray group */
group#tray-expander {
}

#custom-expand-icon {
    margin: 0 15px;
}

#tray {
    margin: 0 15px;
}

#tray > .passive {
  -gtk-icon-effect: dim;
}

#tray > .needs-attention {
  -gtk-icon-effect: highlight;
}

.tray-group-item {
}


/* Battery states */
#custom-battery.charging {
  color: @tertiary;
}

#custom-battery.warning {
  color: @secondary;
}

#custom-battery.critical {
  color: @error;
}

/* Bluetooth states */
#bluetooth.connected {
  color: @secondary;
}

/* Network states */
#network.disconnected {
  color: @error;
}

/* Audio muted state */
#pulseaudio.muted {
  color: @error;
}
#+end_src

*** Sway
Status bar configured for Sway with i3-compatible workspaces module.


**** Configuration
#+begin_src json :tangle packages/sway/.config/waybar/config
{
  "reload_style_on_change": true,
  "layer": "top",
  "position": "top",
    "height": 30,
  "spacing": 0,
  "margin-top": 0,
  "margin-bottom": 0,
  "margin-left": 0,
  "margin-right": 0,

  "modules-left": [
    "idle_inhibitor",
    "sway/workspaces"
  ],

  "modules-center": [
    "custom/pomodoro",
    "clock",
    "custom/update"
  ],

  "modules-right": [
    "group/tray-expander",
    "cpu",
    "memory",
    "bluetooth",
    "network",
    "pulseaudio",
    "custom/backlight",
    "custom/battery"
  ],

  "idle_inhibitor": {
    "format": "{icon}",
    "format-icons": {
      "activated": "󰅶",
      "deactivated": "󰾪"
    },
    "tooltip-format-activated": "Idle Inhibitor: Active",
    "tooltip-format-deactivated": "Idle Inhibitor: Inactive"
  },

  "sway/workspaces": {
    "format": "{icon}",
    "format-icons": {
      "default": "",
      "1": "1",
      "2": "2",
      "3": "3",
      "4": "4",
      "5": "5",
      "6": "6",
      "7": "7",
      "8": "8",
      "9": "9",
      "urgent": ""
    },
    "persistent_workspaces": {
      "1": [],
      "2": [],
      "3": [],
      "4": [],
      "5": [],
      "6": [],
      "7": [],
      "8": [],
      "9": []
    }
  },

  "custom/pomodoro": {
    "format": "{alt} {text}",
    "exec": "~/.local/bin/waybar-pomodoro",
    "return-type": "json",
    "interval": 1,
    "on-click": "~/.local/bin/waybar-pomodoro toggle",
    "on-click-right": "~/.local/bin/waybar-pomodoro reset"
  },

  "clock": {
    "format": "{:L%A %H:%M}",
    "format-alt": "{:L%d %B W%V %Y}",
    "tooltip-format": "<tt>{calendar}</tt>",
    "calendar": {
      "mode": "month",
      "mode-mon-col": 3,
      "weeks-pos": "left",
      "on-scroll": 1,
      "on-click-right": "mode",
    "format": {
        "today": "<b><u>{}</u></b>"
    },
    "actions": {
      "on-click-right": "mode",
      "on-scroll-up": "shift_up",
      "on-scroll-down": "shift_down"
    }
  },

  "custom/update": {
    "format": "{}",
    "exec": "~/.local/bin/waybar-updates",
    "on-click": "foot --app-id=floating-foot -e sh -c 'yay -Syu && echo && echo Done! Press Enter to close && read'",
    "return-type": "json",
    "interval": 3600,
    "signal": 7
  },

  "cpu": {
    "interval": 5,
    "format": "󰍛",
    "tooltip-format": "CPU: {usage}%",
    "on-click": "foot --app-id=floating-foot -e btop"
  },

  "memory": {
    "interval": 5,
    "format": "󰘚",
    "tooltip-format": "RAM: {used:0.1f}G / {total:0.1f}G ({percentage}%)",
    "on-click": "foot --app-id=floating-foot -e btop"
  },

  "network": {
    "format-icons": ["󰤯", "󰤟", "󰤢", "󰤥", "󰤨"],
    "format": "{icon}",
    "format-wifi": "{icon}",
    "format-ethernet": "󰀂",
    "format-disconnected": "󰤮",
    "tooltip-format-wifi": "{essid} ({frequency} GHz)\n⇣{bandwidthDownBytes}  ⇡{bandwidthUpBytes}",
    "tooltip-format-ethernet": "Wired\n⇣{bandwidthDownBytes}  ⇡{bandwidthUpBytes}",
    "tooltip-format-disconnected": "Disconnected",
    "interval": 3,
    "on-click": "networkmanager_dmenu"
  },

  "bluetooth": {
    "format": "",
    "format-disabled": "󰂲",
    "format-connected": "",
      // "format-connected-battery": "{icon}",
      // "format-icons": {
      //     "connected-battery": ["󰤾", "󰤿", "󰥀", "󰥁", "󰥂", "󰥃", "󰥄", "󰥅", "󰥆", "󰥈" ]
      // },
    "tooltip-format": "Bluetooth: {num_connections} connected",
    "on-click": "blueman-manager"
  },

  "pulseaudio": {
    "format": "{icon}",
    "format-muted": "",
    "format-icons": {
      "default": ["", "", "", "", "", "", "", "", "", ""],
    },
    "tooltip-format": "Volume: {volume}%",
    "scroll-step": 5,
    "on-click": "foot --class=Wiremix -e wiremix",
    "on-click-right": "pamixer -t"
  },

  "custom/backlight": {
    "format": "{alt}",
    "exec": "~/.local/bin/waybar-backlight",
    "return-type": "json",
    "interval": 2,
    "on-click": "~/.local/bin/hyprsunset-menu"
  },

  "custom/battery": {
    "format": "{}",
    "exec": "~/.local/bin/waybar-battery",
    "return-type": "json",
    "interval": 10
  },

  "group/tray-expander": {
    "orientation": "inherit",
    "drawer": {
      "transition-duration": 600,
      "children-class": "tray-group-item"
    },
    "modules": ["custom/expand-icon", "tray"]
  },

  "custom/expand-icon": {
    "format": "󰇙",
    "tooltip": false
  },

  "tray": {
    "icon-size": 12,
    "spacing": 30
  }
}
#+end_src

**** Styling
#+begin_src css :tangle packages/sway/.config/waybar/style.css
. * {
  border: none;
  font-family: <<font>>;
  font-weight: bold;
  font-size: 13px;
  min-height: 0;
}

window#waybar {
  background-color: alpha(@background, 0.85);
}

tooltip {
  background-color: @background;
  border: 2px solid @primary;
  border-radius: 10px;
  opacity: 0.9;
}

tooltip * {
  color: @foreground;
}

/* Left section - idle inhibitor, workspaces */
#idle_inhibitor {
  margin: 0 10px;
}

#workspaces button {
    all: unset;
  padding: 0 10px;
  color: @foreground;
}

#workspaces button:hover {
  color: @primary;
}

#workspaces button.empty {
    opacity: 0.5;
}

/* Center section - pomodoro, clock and update */
#custom-pomodoro {
  margin: 0 10px;
  color: @foreground;
}

#custom-pomodoro.work {
  color: @primary;
}

#custom-pomodoro.break {
  color: @secondary;
}

#custom-pomodoro.paused {
  opacity: 0.7;
}

#custom-pomodoro.idle {
  opacity: 0.5;
}

#clock {
  margin: 0 10px;
}

#custom-update {
  margin: 0 5px;
}

#custom-update.pending {
  color: @primary;
}

/* Right section - tray and system stats */
#tray {
  margin: 0 10px;
}

#custom-expand-icon {
    margin: 0 10px;
}

#cpu,
#memory,
#network,
#pulseaudio,
#bluetooth,
#backlight,
#custom-backlight,
#custom-battery {
  margin: 0 10px;
}

/* Hardware status colors */
#bluetooth.disabled {
  opacity: 0.5;
}

#network.disconnected {
  color: @error;
}

/* Audio muted state */
#pulseaudio.muted {
  color: @error;
}
#+end_src

** Mako
Lightweight notification daemon for Wayland with customizable styling.
#+begin_src conf :tangle packages/mako/.config/mako/config
font=<<font>>
border-size=2
default-timeout=20000
width=400
height=800

outer-margin=15
padding=10
layer=overlay

# Source matugen colors
include=~/.cache/matugen/colors-mako

[category=osd]
anchor=top-center
default-timeout=1500
width=350
height=10
border-size=3
margin=25
#+end_src
** Fuzzel
Application launcher for Wayland with fuzzy matching and keyboard-driven interface.
#+begin_src conf :tangle packages/fuzzel/.config/fuzzel/fuzzel.ini
[main]
# Colour scheme generated by Matugen
include=~/.cache/matugen/colors-fuzzel.ini

font=<<font>>:size=8
use-bold=yes
anchor=top-left
x-margin=20
y-margin=20
width=30
horizontal-pad=10
vertical-pad=10
inner-pad=5
lines=15
icons-enabled=no
minimal-lines=yes
keyboard-focus=exclusive
exit-on-keyboard-focus-loss=no
prompt= ""
placeholder="Search to launch..."

[border]
width=3
radius=0

[key-bindings]
# Unbind default to avoid conflicts
delete-line-forward=none

# Vim-style navigation (Down/Up are already mapped to next/prev by default)
next-with-wrap=Control+j
prev-with-wrap=Control+k

#+end_src
** Network Manager Menu
Dmenu-style network connection manager for NetworkManager.
#+begin_src conf :tangle packages/networkmanager_dmenu/.config/networkmanager-dmenu/config.ini
[dmenu]
dmenu_command = fuzzel --width 35
active_chars = ->
highlight = True
highlight_fg =
highlight_bg =
highlight_bold = True
compact = False
pinentry =
wifi_icons = 󰤯󰤟󰤢󰤥󰤨
# wifi_icons = 󰢿󰢼󰢽󰢾
format = {name:<{max_len_name}s}  {sec:<{max_len_sec}s} {icon:>2}
list_saved = True
prompt = Networks:

[dmenu_passphrase]
obscure = True
# Color managed by matugen template
include = ~/.cache/matugen/networkmanager_dmenu.ini
show_pass = nmcli device wifi show-password

[pinentry]
description = Get network password
prompt =

[editor]
terminal = foot
gui_if_available = True
gui = nm-connection-editor

[nmdm]
rescan_delay = 5
#+end_src
** Foot
Fast, lightweight Wayland-native terminal emulator with excellent performance.
#+begin_src conf :tangle packages/foot/.config/foot/foot.ini
[main]
font=<<font>>:size=12

include=~/.cache/matugen/colors-foot.ini

pad=10x10

[bell]
urgent=yes
notify=yes
# visual=yes

[scrollback]
lines=10000
multiplier=2

[cursor]
unfocused-style=hollow
blink=yes
blink-rate=750
#+end_src
** Yazi
Blazing fast terminal file manager with modern features and vim-like keybindings.
*** Configuration
#+begin_src toml :tangle packages/yazi/.config/yazi/yazi.toml
[manager]
ratio = [1, 4, 3]
#+end_src
*** Chmod
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on   = [ "c", "m" ]
run  = "plugin chmod"
desc = "Chmod on selected files"
#+end_src
*** Media Info
#+begin_src toml :tangle packages/yazi/.config/yazi/yazi.toml
[plugin]
  prepend_preloaders = [
    # Replace magick, image, video with mediainfo
    { mime = "{audio,video,image}/*", run = "mediainfo" },
    { mime = "application/subrip", run = "mediainfo" },
    # Adobe Illustrator, Adobe Photoshop is image/adobe.photoshop, already handled above
    { mime = "application/postscript", run = "mediainfo" },
  ]
  prepend_previewers = [
    # Replace magick, image, video with mediainfo
    { mime = "{audio,video,image}/*", run = "mediainfo"},
    { mime = "application/subrip", run = "mediainfo" },
    # Adobe Illustrator, Adobe Photoshop is image/adobe.photoshop, already handled above
    { mime = "application/postscript", run = "mediainfo" },
  ]
  # There are more extensions which are supported by mediainfo.
  # Just add file's MIME type to `previewers`, `preloaders` above.
  # https://mediaarea.net/en/MediaInfo/Support/Formats

# For a large file like Adobe Illustrator, Adobe Photoshop, etc
# you may need to increase the memory limit if no image is rendered.
# https://yazi-rs.github.io/docs/configuration/yazi#tasks
[tasks]
  image_alloc      = 1073741824        # = 1024*1024*1024 = 1024MB
#+end_src
*** Zoom
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on   = [ "z", "i" ]
run  = "plugin zoom 1"
desc = "Zoom in hovered file"

[[mgr.prepend_keymap]]
on   = [ "z", "o" ]
run  = "plugin zoom -1"
desc = "Zoom out hovered file"
#+end_src
*** Trash Restore
**** Configuration
#+begin_src lua :tangle packages/yazi/.config/yazi/init.lua
require("recycle-bin"):setup({
  -- Optional: Override automatic trash directory discovery
  -- trash_dir = "~/.local/share/Trash/",  -- Uncomment to use specific directory
})
#+end_src
**** Keybinding
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on =  "R"
run = "plugin recycle-bin"
desc = "Open Recycle Bin menu"
#+end_src
*** Kdeconnect-send
**** Configuration (optional)
Un-comment/enable this to always show a prompt for selecting a target device, even when there's only one device connected.
#+begin_src lua :tangle packages/yazi/.config/yazi/init.lua
-- Always show device selection
-- require("kdeconnect-send"):setup({
    -- auto_select_single = false,
-- })
#+end_src
**** Keybinding
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on   = [ "<C-s>" ]
run  = "plugin kdeconnect-send"
desc = "Send selected files via KDE Connect"
#+end_src
*** Git Status
**** Configuration
#+begin_src lua :tangle packages/yazi/.config/yazi/init.lua
-- Custom status signs
th.git = th.git or {}
th.git.modified_sign = "M"
th.git.added_sign = "A"
th.git.untracked_sign = "U"
th.git.ignored_sign = "I"
th.git.deleted_sign = "D"
th.git.updated_sign = "U"

-- Init
require("git"):setup()
#+end_src
**** Setup
#+begin_src toml :tangle packages/yazi/.config/yazi/yazi.toml
[[plugin.prepend_fetchers]]
id   = "git"
name = "*"
run  = "git"

[[plugin.prepend_fetchers]]
id   = "git"
name = "*/"
run  = "git"
#+end_src
*** Lazygit
**** Keybinding
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on   = [ "g", "l" ]
run  = "plugin lazygit"
desc = "run lazygit"
#+end_src
*** Clipboard
**** Keybinding
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on  = "y"
run = [ "yank", 'plugin clipboard -- --action=copy' ]
#+end_src
*** Mount/un-mount
**** Keybinding
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on  = "M"
run = "plugin mount"
#+end_src
*** Yatline
**** Configuration
#+begin_src lua :tangle packages/yazi/.config/yazi/init.lua
require("yatline"):setup({
	--theme = my_theme,
	section_separator = { open = "", close = "" },
	part_separator = { open = "", close = "" },
	inverse_separator = { open = "", close = "" },

	style_a = {
		fg = "black",
		bg_mode = {
			normal = "white",
			select = "brightyellow",
			un_set = "brightred"
		}
	},
	style_b = { bg = "brightblack", fg = "brightwhite" },
	style_c = { bg = "black", fg = "brightwhite" },

	permissions_t_fg = "green",
	permissions_r_fg = "yellow",
	permissions_w_fg = "red",
	permissions_x_fg = "cyan",
	permissions_s_fg = "white",

	tab_width = 20,
	tab_use_inverse = false,

	selected = { icon = "󰻭", fg = "yellow" },
	copied = { icon = "", fg = "green" },
	cut = { icon = "", fg = "red" },

	total = { icon = "󰮍", fg = "yellow" },
	succ = { icon = "", fg = "green" },
	fail = { icon = "", fg = "red" },
	found = { icon = "󰮕", fg = "blue" },
	processed = { icon = "󰐍", fg = "green" },

	show_background = true,

	display_header_line = true,
	display_status_line = true,

	component_positions = { "header", "tab", "status" },

	header_line = {
		left = {
			section_a = {
        			{type = "line", custom = false, name = "tabs", params = {"left"}},
			},
			section_b = {
			},
			section_c = {
			}
		},
		right = {
			section_a = {
        			{type = "string", custom = false, name = "date", params = {"%A, %d %B %Y"}},
			},
			section_b = {
        			{type = "string", custom = false, name = "date", params = {"%X"}},
			},
			section_c = {
			}
		}
	},

	status_line = {
		left = {
			section_a = {
        			{type = "string", custom = false, name = "tab_mode"},
			},
			section_b = {
        			{type = "string", custom = false, name = "hovered_size"},
			},
			section_c = {
        			{type = "string", custom = false, name = "hovered_path"},
        			{type = "coloreds", custom = false, name = "count"},
			}
		},
		right = {
			section_a = {
        			{type = "string", custom = false, name = "cursor_position"},
			},
			section_b = {
        			{type = "string", custom = false, name = "cursor_percentage"},
			},
			section_c = {
        			{type = "string", custom = false, name = "hovered_file_extension", params = {true}},
        			{type = "coloreds", custom = false, name = "permissions"},
			}
		}
	},
})
#+end_src
*** Toggle-pane
**** Keybinding
#+begin_src toml :tangle packages/yazi/.config/yazi/keymap.toml
[[mgr.prepend_keymap]]
on   = "T"
run  = "plugin toggle-pane min-preview"
desc = "Show or hide the preview pane"

[[mgr.prepend_keymap]]
on   = "P"
run  = "plugin toggle-pane max-preview"
desc = "Maximize or restore the preview pane"

#+end_src
** Qutebrowser
Keyboard-driven, Vim-like web browser built on QtWebEngine.

*** Configuration
**** Auto Config
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# Autogenerated config.py
#
# NOTE: config.py is intended for advanced users who are comfortable
# with manually migrating the config file on qutebrowser upgrades. If
# you prefer, you can also configure qutebrowser using the
# :set/:bind/:config-* commands without having to write a config.py
# file.
#
# Documentation:
#   qute://help/configuring.html
#   qute://help/settings.html

# Change the argument to True to still load settings configured via autoconfig.yml
config.load_autoconfig(False)

# Which cookies to accept. With QtWebEngine, this setting also controls
# other features with tracking capabilities similar to those of cookies;
# including IndexedDB, DOM storage, filesystem API, service workers, and
# AppCache. Note that with QtWebKit, only `all` and `never` are
# supported as per-domain values. Setting `no-3rdparty` or `no-
# unknown-3rdparty` per-domain on QtWebKit will have the same effect as
# `all`. If this setting is used with URL patterns, the pattern gets
# applied to the origin/first party URL of the page making the request,
# not the request URL. With QtWebEngine 5.15.0+, paths will be stripped
# from URLs, so URL patterns using paths will not match. With
# QtWebEngine 5.15.2+, subdomains are additionally stripped as well, so
# you will typically need to set this setting for `example.com` when the
# cookie is set on `somesubdomain.example.com` for it to work properly.
# To debug issues with this setting, start qutebrowser with `--debug
# --logfilter network --debug-flag log-cookies` which will show all
# cookies being set.
# Type: String
# Valid values:
#   - all: Accept all cookies.
#   - no-3rdparty: Accept cookies from the same origin only. This is known to break some sites, such as GMail.
#   - no-unknown-3rdparty: Accept cookies from the same origin only, unless a cookie is already set for the domain. On QtWebEngine, this is the same as no-3rdparty.
#   - never: Don't accept cookies at all.
config.set('content.cookies.accept', 'all', 'chrome-devtools://*')

# Which cookies to accept. With QtWebEngine, this setting also controls
# other features with tracking capabilities similar to those of cookies;
# including IndexedDB, DOM storage, filesystem API, service workers, and
# AppCache. Note that with QtWebKit, only `all` and `never` are
# supported as per-domain values. Setting `no-3rdparty` or `no-
# unknown-3rdparty` per-domain on QtWebKit will have the same effect as
# `all`. If this setting is used with URL patterns, the pattern gets
# applied to the origin/first party URL of the page making the request,
# not the request URL. With QtWebEngine 5.15.0+, paths will be stripped
# from URLs, so URL patterns using paths will not match. With
# QtWebEngine 5.15.2+, subdomains are additionally stripped as well, so
# you will typically need to set this setting for `example.com` when the
# cookie is set on `somesubdomain.example.com` for it to work properly.
# To debug issues with this setting, start qutebrowser with `--debug
# --logfilter network --debug-flag log-cookies` which will show all
# cookies being set.
# Type: String
# Valid values:
#   - all: Accept all cookies.
#   - no-3rdparty: Accept cookies from the same origin only. This is known to break some sites, such as GMail.
#   - no-unknown-3rdparty: Accept cookies from the same origin only, unless a cookie is already set for the domain. On QtWebEngine, this is the same as no-3rdparty.
#   - never: Don't accept cookies at all.
config.set('content.cookies.accept', 'all', 'devtools://*')

# Value to send in the `Accept-Language` header. Note that the value
# read from JavaScript is always the global value.
# Type: String
config.set('content.headers.accept_language', '', 'https://matchmaker.krunker.io/*')

# User agent to send.  The following placeholders are defined:  *
# `{os_info}`: Something like "X11; Linux x86_64". * `{webkit_version}`:
# The underlying WebKit version (set to a fixed value   with
# QtWebEngine). * `{qt_key}`: "Qt" for QtWebKit, "QtWebEngine" for
# QtWebEngine. * `{qt_version}`: The underlying Qt version. *
# `{upstream_browser_key}`: "Version" for QtWebKit, "Chrome" for
# QtWebEngine. * `{upstream_browser_version}`: The corresponding
# Safari/Chrome version. * `{qutebrowser_version}`: The currently
# running qutebrowser version.  The default value is equal to the
# unchanged user agent of QtWebKit/QtWebEngine.  Note that the value
# read from JavaScript is always the global value. With QtWebEngine
# between 5.12 and 5.14 (inclusive), changing the value exposed to
# JavaScript requires a restart.
# Type: FormatString
config.set('content.headers.user_agent', 'Mozilla/5.0 ({os_info}) AppleWebKit/{webkit_version} (KHTML, like Gecko) {upstream_browser_key}/{upstream_browser_version} Safari/{webkit_version}', 'https://web.whatsapp.com/')

# User agent to send.  The following placeholders are defined:  *
# `{os_info}`: Something like "X11; Linux x86_64". * `{webkit_version}`:
# The underlying WebKit version (set to a fixed value   with
# QtWebEngine). * `{qt_key}`: "Qt" for QtWebKit, "QtWebEngine" for
# QtWebEngine. * `{qt_version}`: The underlying Qt version. *
# `{upstream_browser_key}`: "Version" for QtWebKit, "Chrome" for
# QtWebEngine. * `{upstream_browser_version}`: The corresponding
# Safari/Chrome version. * `{qutebrowser_version}`: The currently
# running qutebrowser version.  The default value is equal to the
# unchanged user agent of QtWebKit/QtWebEngine.  Note that the value
# read from JavaScript is always the global value. With QtWebEngine
# between 5.12 and 5.14 (inclusive), changing the value exposed to
# JavaScript requires a restart.
# Type: FormatString
config.set('content.headers.user_agent', 'Mozilla/5.0 ({os_info}; rv:90.0) Gecko/20100101 Firefox/90.0', 'https://accounts.google.com/*')

# Load images automatically in web pages.
# Type: Bool
config.set('content.images', True, 'chrome-devtools://*')

# Load images automatically in web pages.
# Type: Bool
config.set('content.images', True, 'devtools://*')

# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'chrome-devtools://*')

# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'devtools://*')

# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'chrome://*/*')

# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'qute://*/*')

# Allow locally loaded documents to access remote URLs.
# Type: Bool
config.set('content.local_content_can_access_remote_urls', True, 'file:///home/james/.local/share/qutebrowser/userscripts/*')

# Allow locally loaded documents to access other local URLs.
# Type: Bool
config.set('content.local_content_can_access_file_urls', False, 'file:///home/james/.local/share/qutebrowser/userscripts/*')

#+end_src

**** General Settings
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# Session management
c.auto_save.session = True
c.session.lazy_restore = True

# Start page
c.url.default_page = 'file:///home/james/.cache/matugen/qutebrowser-startpage.html'
c.url.start_pages = ['file:///home/james/.cache/matugen/qutebrowser-startpage.html']

# Content blocking (requires: python-adblock from extra repo)
c.content.blocking.enabled = True
c.content.blocking.method = 'both'  # Use both hosts and brave's adblock
c.content.blocking.hosts.lists = [
    'https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts',
]
c.content.blocking.adblock.lists = [
    'https://easylist.to/easylist/easylist.txt',
    'https://easylist.to/easylist/easyprivacy.txt',
    'https://secure.fanboy.co.nz/fanboy-annoyance.txt',
    'https://easylist-downloads.adblockplus.org/antiadblockfilters.txt',
]

# Privacy
c.content.cookies.accept = 'no-3rdparty'
c.content.headers.do_not_track = True
c.content.webgl = False

# Smooth scrolling
c.scrolling.smooth = True

# Downloads
c.downloads.location.directory = '~/Downloads'
c.downloads.location.prompt = True
c.downloads.remove_finished = 5000

# Zoom
c.zoom.default = '110%'
#+end_src

**** Fonts
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# Font configuration
c.fonts.default_family = '<<font>>'
c.fonts.default_size = '11pt'
c.fonts.web.family.sans_serif = '<<font-sans>>'
c.fonts.web.family.serif = '<<font-serif>>'
c.fonts.web.family.fixed = '<<font>>'
c.fonts.web.size.default = 18
c.fonts.hints = '<<font>>'
#+end_src

**** Appearance
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# Hints
c.hints.border = '2px solid'
c.hints.padding = {"bottom": 3, "top": 3, "left": 3, "right": 3}
c.hints.radius = 0
c.hints.uppercase = True
c.fonts.hints = 'bold 12pt <<font>>'

# Tabs
c.tabs.position = "top"
c.tabs.background = True
c.tabs.select_on_remove = 'prev'
c.tabs.favicons.show = "always"
c.tabs.show = 'always'
c.tabs.show_switching_delay = 900
c.tabs.width = '25%'
c.tabs.padding = {"bottom": 5, "left": 10, "right": 10, "top": 5}
c.tabs.indicator.padding = {"bottom": 0, "left": 0, "right": 5, "top": 0}
c.tabs.indicator.width = 0
c.tabs.last_close = 'default-page'
c.tabs.min_width = 150

# Status bar
c.statusbar.show = 'in-mode'
c.statusbar.padding = {"bottom": 5, "left": 10, "right": 10, "top": 5}

# Scrollbar
c.scrolling.bar = 'always'

# Completion
c.completion.height = '30%'
c.completion.show = 'always'
c.completion.shrink = True
c.completion.quick = True
#+end_src

**** Editor
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# External editor
c.editor.command = ['emacsclient', '-c', '-a', ' ', '+{line}:{column}', '{}']
#+end_src

**** Search Engines
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# Custom search engines
c.url.searchengines['DEFAULT'] = 'https://duckduckgo.com/?q={}'
c.url.searchengines['gg'] = 'https://www.google.com/search?q={}'
c.url.searchengines['am'] = 'https://www.amazon.co.uk/s?k={}'
c.url.searchengines['yt'] = 'https://www.youtube.com/results?search_query={}'
c.url.searchengines['aur'] = 'https://aur.archlinux.org/packages?O=0&K={}'
c.url.searchengines['arp'] = 'https://archlinux.org/packages/?sort=&q={}&maintainer=&flagged='
c.url.searchengines['ar'] = 'https://wiki.archlinux.org/index.php?search={}'
c.url.searchengines['rd'] = 'https://www.reddit.com/search/?q={}'
c.url.searchengines['ghr'] = 'https://github.com/search?q={}&type=repositories'
c.url.searchengines['ghc'] = 'https://github.com/search?q={}&type=code'
c.url.searchengines['man'] = 'https://man.archlinux.org/search?q={}'
c.url.searchengines['img'] = 'https://www.google.com/search?tbm=isch&q={}'
c.url.searchengines['maps'] = 'https://www.google.com/maps/search/{}'
c.url.searchengines['wiki'] = 'https://en.wikipedia.org/wiki/{}'
c.url.searchengines['trans'] = 'https://translate.google.com/?sl=auto&tl=en&text={}'
#+end_src

**** Keybindings
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# General keybinds
config.bind('t.', 'config-source')
config.bind('pv', 'hint links spawn mpv --title=Picture-in-Picture {hint-url}')
config.bind('pV', 'spawn mpv --title=Picture-in-Picture {url}')
# config.bind('pV', 'hint links spawn mpv {hint-url}')
config.bind('gh', 'home')
config.bind('gp', 'open -p')
config.bind('pp', 'hint links run open -p {hint-url}')

# Tabs
config.bind(',tp', 'config-cycle tabs.position "top" "left"')
config.bind(',ts', 'config-cycle tabs.show "always" "switching"')
config.bind('tt', 'config-cycle tabs.show "always" "switching"')
config.bind('tpo', 'config-cycle tabs.position "top" "left"')

# Dark mode toggle
config.bind('td', 'config-cycle colors.webpage.darkmode.enabled "true" "false"')

# Userscripts
config.bind('zv', 'spawn --userscript video-download')
config.bind('zr', 'spawn --userscript reading-mode')
config.bind('zt', 'spawn --userscript translate-page')
config.bind('za', 'spawn --userscript paywall-bypass')

# Vim-style navigation for completion/prompts
config.bind('<Ctrl-j>', 'completion-item-focus next', mode='command')
config.bind('<Ctrl-k>', 'completion-item-focus prev', mode='command')
config.bind('<Ctrl-j>', 'prompt-item-focus next', mode='prompt')
config.bind('<Ctrl-k>', 'prompt-item-focus prev', mode='prompt')
#+end_src

**** Colours (Matugen)
#+begin_src python :tangle packages/qutebrowser/.config/qutebrowser/config.py
# Source matugen colors
import os

matugen_colors = os.path.expanduser('~/.cache/matugen/colors-qutebrowser.py')
if os.path.exists(matugen_colors):
    config.source(matugen_colors)
#+end_src

*** User-scripts
**** Video Download
#+begin_src bash :tangle packages/qutebrowser/.local/share/qutebrowser/userscripts/video-download :shebang "#!/usr/bin/env bash"
# Download video from current URL using yt-dlp
# Requires: yt-dlp

url="$QUTE_URL"
download_dir="$HOME/Downloads/videos"

mkdir -p "$download_dir"

echo "message-info 'Downloading video from $url...'" >> "$QUTE_FIFO"

# Download in background
(
    cd "$download_dir" || exit
    yt-dlp -f 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best' "$url" 2>&1
    if [ $? -eq 0 ]; then
        notify-send "Video Download" "Successfully downloaded from $url"
    else
        notify-send "Video Download" "Failed to download from $url"
    fi
) &

echo "message-info 'Video download started in background'" >> "$QUTE_FIFO"
#+end_src

**** Reading Mode
#+begin_src bash :tangle packages/qutebrowser/.local/share/qutebrowser/userscripts/reading-mode :shebang "#!/usr/bin/env bash"
# Toggle reading mode using readability
# Requires: python-readability-lxml

url="$QUTE_URL"
tmpfile="/tmp/qutebrowser-reading-$$.html"

# Use python-readability-lxml
if ! python3 -c "import readability" 2>/dev/null; then
    echo "message-error 'Reading mode: Install python-readability-lxml'" >> "$QUTE_FIFO"
    exit 1
fi

python3 << EOF > "$tmpfile"
from readability import Document
import requests
import sys

try:
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
    }
    response = requests.get('$url', headers=headers, timeout=10)
    response.raise_for_status()
    doc = Document(response.text)

    html = f'''<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{doc.title()}</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        body {{
            max-width: 750px;
            margin: 0 auto;
            padding: 3rem 2rem;
            font-family: "Georgia", "Cambria", "Times New Roman", serif;
            font-size: 18px;
            line-height: 1.7;
            color: #333;
            background: #fafafa;
        }}
        h1, h2, h3, h4, h5, h6 {{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-weight: 700;
            line-height: 1.3;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }}
        h1 {{ font-size: 2.5rem; margin-top: 0; }}
        h2 {{ font-size: 2rem; }}
        h3 {{ font-size: 1.5rem; }}
        h4 {{ font-size: 1.25rem; }}
        p {{
            margin-bottom: 1.5rem;
            text-align: justify;
        }}
        a {{
            color: #0066cc;
            text-decoration: none;
            border-bottom: 1px solid #0066cc;
        }}
        a:hover {{ color: #004499; }}
        img {{
            max-width: 100%;
            height: auto;
            display: block;
            margin: 2rem auto;
            border-radius: 4px;
        }}
        pre, code {{
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            background: #f5f5f5;
            border-radius: 3px;
        }}
        pre {{
            padding: 1rem;
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }}
        code {{
            padding: 0.2rem 0.4rem;
            font-size: 0.9em;
        }}
        pre code {{
            padding: 0;
            background: none;
        }}
        blockquote {{
            margin: 1.5rem 0;
            padding-left: 1.5rem;
            border-left: 4px solid #ddd;
            color: #666;
            font-style: italic;
        }}
        ul, ol {{
            margin-bottom: 1.5rem;
            padding-left: 2rem;
        }}
        li {{
            margin-bottom: 0.5rem;
        }}
        hr {{
            border: none;
            border-top: 2px solid #ddd;
            margin: 2rem 0;
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }}
        th, td {{
            padding: 0.75rem;
            border: 1px solid #ddd;
            text-align: left;
        }}
        th {{
            background: #f5f5f5;
            font-weight: 600;
        }}
        @media (prefers-color-scheme: dark) {{
            body {{
                background: #1a1a1a;
                color: #e0e0e0;
            }}
            h1, h2, h3, h4, h5, h6 {{
                color: #f0f0f0;
            }}
            a {{
                color: #6699ff;
                border-bottom-color: #6699ff;
            }}
            a:hover {{ color: #99bbff; }}
            pre, code {{
                background: #2a2a2a;
            }}
            blockquote {{
                border-left-color: #444;
                color: #aaa;
            }}
            hr {{
                border-top-color: #444;
            }}
            th {{
                background: #2a2a2a;
            }}
            th, td {{
                border-color: #444;
            }}
        }}
    </style>
</head>
<body>
{doc.summary()}
</body>
</html>'''

    print(html)
except Exception as e:
    print(f'<html><body style="padding:2rem;font-family:sans-serif;"><h1>Reading Mode Error</h1><p>{str(e)}</p></body></html>')
    sys.exit(1)
EOF

if [ $? -eq 0 ]; then
    echo "open -t file://$tmpfile" >> "$QUTE_FIFO"
    echo "message-info 'Reading mode activated'" >> "$QUTE_FIFO"
else
    echo "message-error 'Reading mode: Failed to process page'" >> "$QUTE_FIFO"
    rm -f "$tmpfile"
fi
#+end_src

**** Translate Page
#+begin_src bash :tangle packages/qutebrowser/.local/share/qutebrowser/userscripts/translate-page :shebang "#!/usr/bin/env bash"
# Translate current page using Google Translate

url="$QUTE_URL"
target_lang="${1:-en}"

# Use Google Translate
translate_url="https://translate.google.com/translate?sl=auto&tl=${target_lang}&u=$(echo "$url" | jq -sRr @uri)"

echo "open -t $translate_url" >> "$QUTE_FIFO"
echo "message-info 'Translating page to $target_lang'" >> "$QUTE_FIFO"
#+end_src

**** Paywall Bypass
#+begin_src bash :tangle packages/qutebrowser/.local/share/qutebrowser/userscripts/paywall-bypass :shebang "#!/usr/bin/env bash"
# Bypass paywalls using archive.is

url="$QUTE_URL"

# Check if already on archive.is
if [[ "$url" == *"archive."* ]]; then
    echo "message-warning 'Already on archive site'" >> "$QUTE_FIFO"
    exit 0
fi

# Try archive.is
archive_url="https://archive.is/newest/$url"

echo "open -t $archive_url" >> "$QUTE_FIFO"
echo "message-info 'Opening archived version'" >> "$QUTE_FIFO"
#+end_src

*** Grease-monkey
Qutebrowser supports Grease-monkey scripts in =~/.local/share/qutebrowser/greasemonkey/=.

To install scripts:
1. Download .js files from greasyfork.org or other sources
2. Place them in =~/.local/share/qutebrowser/greasemonkey/=
3. Run =:greasemonkey-reload= in qutebrowser

Recommended scripts:
- YouTube: *SponsorBlock*, *Return YouTube Dislike*
- Reddit: *Reddit Enhancement Suite (RES)* - Note: Use old.reddit.com redirect instead
- General: *Dark Reader*, *uBlock Origin Extra*

*** Bookmarks
Bookmarks are managed directly by qutebrowser at =~/.config/qutebrowser/bookmarks/urls=.
Initial import (one-time):
#+begin_src sh :tangle no
mkdir -p ~/.config/qutebrowser/bookmarks
cp ~/stow/qutebrowser/.config/qutebrowser/bookmarks/urls ~/.config/qutebrowser/bookmarks/urls
#+end_src

* Theming & Appearance
** GTK
GTK application theming with custom settings and Material You integration.

*** GTK 3.0
#+begin_src ini :tangle packages/matugen/.config/gtk-3.0/settings.ini
[Settings]
gtk-application-prefer-dark-theme=true
gtk-theme-name=adw-gtk3-dark
gtk-icon-theme-name=Papirus
gtk-font-name=Sans 10
gtk-cursor-theme-name=Human
gtk-cursor-theme-size=24
gtk-toolbar-style=GTK_TOOLBAR_BOTH_HORIZ
gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
gtk-button-images=0
gtk-menu-images=0
gtk-enable-event-sounds=1
gtk-enable-input-feedback-sounds=0
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintfull
gtk-xft-rgba=rgb
#+end_src

*** GTK 4.0
#+begin_src ini :tangle packages/matugen/.config/gtk-4.0/settings.ini
[Settings]
gtk-application-prefer-dark-theme=true
gtk-theme-name=adw-gtk3-dark
gtk-icon-theme-name=Papirus
gtk-font-name=Sans 10
gtk-cursor-theme-name=Human
gtk-cursor-theme-size=24
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintfull
gtk-xft-rgba=rgb
#+end_src

** Qt
Qt application theming to match system appearance.

*** Qt6ct
#+begin_src ini :tangle packages/matugen/.config/qt6ct/qt6ct.conf
[Appearance]
color_scheme_path=/home/james/.config/qt6ct/colors/matugen.conf
custom_palette=true
icon_theme=Papirus
standard_dialogs=default
style=Fusion

[Fonts]
fixed="<<font>>,12,-1,5,400,0,0,0,0,0,0,0,0,0,0,1"
general="<<font-sans>>,12,-1,5,400,0,0,0,0,0,0,0,0,0,0,1"

[Interface]
activate_item_on_single_click=1
buttonbox_layout=0
cursor_flash_time=1000
dialog_buttons_have_icons=0
double_click_interval=400
gui_effects=@Invalid()
keyboard_scheme=2
menus_have_icons=true
show_shortcuts_in_context_menus=true
stylesheets=@Invalid()
toolbutton_style=4
underline_shortcut=1
wheel_scroll_lines=3

[SettingsWindow]
geometry=@ByteArray()
#+end_src

*** Qt5ct
#+begin_src ini :tangle packages/matugen/.config/qt5ct/qt5ct.conf
[Appearance]
color_scheme_path=/home/james/.config/qt5ct/colors/matugen.conf
custom_palette=true
icon_theme=Papirus
standard_dialogs=default
style=Fusion

[Fonts]
fixed="<<font>>,12,-1,5,50,0,0,0,0,0"
general="<<font-sans>>,12,-1,5,50,0,0,0,0,0"

[Interface]
activate_item_on_single_click=1
buttonbox_layout=0
cursor_flash_time=1000
dialog_buttons_have_icons=0
double_click_interval=400
gui_effects=@Invalid()
keyboard_scheme=2
menus_have_icons=true
show_shortcuts_in_context_menus=true
stylesheets=@Invalid()
toolbutton_style=4
underline_shortcut=1
wheel_scroll_lines=3

[SettingsWindow]
geometry=@ByteArray()
#+end_src

** Matugen

*** Configuration
#+begin_src toml :tangle packages/matugen/.config/matugen/config.toml
# Matugen Configuration

[config]
reload_apps = true
reload_apps_list = ["hyprland", "waybar"]
# Use scheme-content for better color generation
scheme_type = "content"

[templates.hyprland]
input_path = "~/.config/matugen/templates/hyprland.conf"
output_path = "~/.cache/matugen/colors-hyprland.conf"
post_hook = 'hyprctl reload'

[templates.hyprlock]
input_path = "~/.config/matugen/templates/hyprlock.conf"
output_path = "~/.cache/matugen/colors-hyprlock.conf"

[templates.waybar]
input_path = "~/.config/matugen/templates/waybar.css"
output_path = "~/.cache/matugen/colors-waybar.css"

[templates.foot]
input_path = "~/.config/matugen/templates/foot.ini"
output_path = "~/.cache/matugen/colors-foot.ini"

[templates.mako]
input_path = "~/.config/matugen/templates/mako.conf"
output_path = "~/.cache/matugen/colors-mako"

[templates.fuzzel]
input_path = "~/.config/matugen/templates/fuzzel.ini"
output_path = "~/.cache/matugen/colors-fuzzel.ini"

[templates.networkmanager_dmenu]
input_path = "~/.config/matugen/templates/networkmanager_dmenu.ini"
output_path = "~/.cache/matugen/networkmanager_dmenu.ini"

[templates.sway]
input_path = "~/.config/matugen/templates/sway.conf"
output_path = "~/.cache/matugen/colors-sway"

[templates.qutebrowser]
input_path = "~/.config/matugen/templates/qutebrowser.py"
output_path = "~/.cache/matugen/colors-qutebrowser.py"

[templates.qutebrowser-startpage]
input_path = "~/.config/matugen/templates/qutebrowser-startpage.html"
output_path = "~/.cache/matugen/qutebrowser-startpage.html"

[templates.gtk3]
input_path = "~/.config/matugen/templates/gtk.css"
output_path = "~/.config/gtk-3.0/gtk.css"

[templates.gtk4]
input_path = "~/.config/matugen/templates/gtk.css"
output_path = "~/.config/gtk-4.0/gtk.css"

[templates.qt6ct]
input_path = "~/.config/matugen/templates/qt6ct.conf"
output_path = "~/.config/qt6ct/colors/matugen.conf"

[templates.qt5ct]
input_path = "~/.config/matugen/templates/qt5ct.conf"
output_path = "~/.config/qt5ct/colors/matugen.conf"
#+end_src

*** Templates
**** Sway Template
#+begin_src conf :tangle packages/matugen/.config/matugen/templates/sway.conf
# Generated by matugen

# Sway color variables
set $bg {{colors.surface.default.hex}}
set $fg {{colors.on_surface.default.hex}}
set $accent {{colors.primary.default.hex}}
set $urgent {{colors.error.default.hex}}

# Material You color palette
set $background {{colors.background.default.hex}}
set $foreground {{colors.on_background.default.hex}}
set $primary {{colors.primary.default.hex}}
set $on_primary {{colors.on_primary.default.hex}}
set $primary_container {{colors.primary_container.default.hex}}
set $on_primary_container {{colors.on_primary_container.default.hex}}
set $secondary {{colors.secondary.default.hex}}
set $on_secondary {{colors.on_secondary.default.hex}}
set $tertiary {{colors.tertiary.default.hex}}
set $surface {{colors.surface.default.hex}}
set $on_surface {{colors.on_surface.default.hex}}
set $surface_variant {{colors.surface_variant.default.hex}}
set $on_surface_variant {{colors.on_surface_variant.default.hex}}
set $surface_dim {{colors.surface_dim.default.hex}}
set $error {{colors.error.default.hex}}
set $on_error {{colors.on_error.default.hex}}
#+end_src

**** Hyprland Template
#+begin_src conf :tangle packages/matugen/.config/matugen/templates/hyprland.conf

$background = rgb({{colors.background.default.hex_stripped}})
$foreground = rgb({{colors.on_background.default.hex_stripped}})
$primary = rgb({{colors.primary.default.hex_stripped}})
$on_primary = rgb({{colors.on_primary.default.hex_stripped}})
$primary_container = rgb({{colors.primary_container.default.hex_stripped}})
$on_primary_container = rgb({{colors.on_primary_container.default.hex_stripped}})
$secondary = rgb({{colors.secondary.default.hex_stripped}})
$secondary_container = rgb({{colors.secondary_container.default.hex_stripped}})
$on_secondary = rgb({{colors.on_secondary.default.hex_stripped}})
$tertiary = rgb({{colors.tertiary.default.hex_stripped}})
$tertiary_container = rgb({{colors.tertiary_container.default.hex_stripped}})
$surface = rgb({{colors.surface.default.hex_stripped}})
$on_surface = rgb({{colors.on_surface.default.hex_stripped}})
$surface_variant = rgb({{colors.surface_variant.default.hex_stripped}})
$on_surface_variant = rgb({{colors.on_surface_variant.default.hex_stripped}})
$surface_dim = rgb({{colors.surface_dim.default.hex_stripped}})
$error = rgb({{colors.error.default.hex_stripped}})
$on_error = rgb({{colors.on_error.default.hex_stripped}})
# <* for name, value in colors *>
# $image = {{image}}
# ${{name}} = rgba({{value.default.hex_stripped}}ff)
# <* endfor *>
#+end_src

**** Hyprlock Template
#+begin_src conf :tangle packages/matugen/.config/matugen/templates/hyprlock.conf
# Generated by matugen - Hyprlock colors

$background = rgb({{colors.background.default.hex_stripped}})
$foreground = rgb({{colors.on_background.default.hex_stripped}})
$primary = rgb({{colors.primary.default.hex_stripped}})
$on_primary = rgb({{colors.on_primary.default.hex_stripped}})
$surface = rgb({{colors.surface.default.hex_stripped}})
$on_surface = rgb({{colors.on_surface.default.hex_stripped}})
$surface_variant = rgb({{colors.surface_variant.default.hex_stripped}})
$on_surface_variant = rgb({{colors.on_surface_variant.default.hex_stripped}})
$tertiary = rgb({{colors.tertiary.default.hex_stripped}})
$error = rgb({{colors.error.default.hex_stripped}})
$on_error = rgb({{colors.on_error.default.hex_stripped}})
#+end_src

**** Waybar Template
#+begin_src css :tangle packages/matugen/.config/matugen/templates/waybar.css
/* Generated by matugen */

@define-color background {{colors.background.default.hex}};
@define-color foreground {{colors.on_background.default.hex}};
@define-color surface {{colors.surface.default.hex}};
@define-color on_surface {{colors.on_surface.default.hex}};

@define-color primary {{colors.primary.default.hex}};
@define-color on_primary {{colors.on_primary.default.hex}};
@define-color primary_container {{colors.primary_container.default.hex}};
@define-color on_primary_container {{colors.on_primary_container.default.hex}};

@define-color secondary {{colors.secondary.default.hex}};
@define-color on_secondary {{colors.on_secondary.default.hex}};
@define-color secondary_container {{colors.secondary_container.default.hex}};

@define-color tertiary {{colors.tertiary.default.hex}};
@define-color on_tertiary {{colors.on_tertiary.default.hex}};

@define-color error {{colors.error.default.hex}};
@define-color on_error {{colors.on_error.default.hex}};

@define-color outline {{colors.outline.default.hex}};
@define-color surface_variant {{colors.surface_variant.default.hex}};
@define-color on_surface_variant {{colors.on_surface_variant.default.hex}};

/* Legacy color variables for compatibility */
@define-color color0 {{colors.surface.default.hex}};
@define-color color1 {{colors.error.default.hex}};
@define-color color2 {{colors.tertiary.default.hex}};
@define-color color3 {{colors.secondary.default.hex}};
@define-color color4 {{colors.primary.default.hex}};
@define-color color5 {{colors.primary_container.default.hex}};
#+end_src

**** Foot Template
#+begin_src ini :tangle packages/matugen/.config/matugen/templates/foot.ini
# Generated by matugen

[colors]
foreground={{colors.on_background.default.hex_stripped}}
background={{colors.background.default.hex_stripped}}

regular0={{colors.surface.default.hex_stripped}}
regular1={{colors.error.default.hex_stripped}}
regular2={{colors.tertiary.default.hex_stripped}}
regular3={{colors.secondary.default.hex_stripped}}
regular4={{colors.primary.default.hex_stripped}}
regular5={{colors.primary_container.default.hex_stripped}}
regular6={{colors.secondary_container.default.hex_stripped}}
regular7={{colors.on_background.default.hex_stripped}}

bright0={{colors.surface_variant.default.hex_stripped}}
bright1={{colors.error.default.hex_stripped}}
bright2={{colors.tertiary.default.hex_stripped}}
bright3={{colors.secondary.default.hex_stripped}}
bright4={{colors.primary.default.hex_stripped}}
bright5={{colors.primary_container.default.hex_stripped}}
bright6={{colors.secondary_container.default.hex_stripped}}
bright7={{colors.on_surface.default.hex_stripped}}
#+end_src

**** Mako Template
#+begin_src conf :tangle packages/matugen/.config/matugen/templates/mako.conf
# Generated by matugen

# Material You colors
background-color={{colors.surface.default.hex}}
text-color={{colors.on_surface.default.hex}}
border-color={{colors.primary.default.hex}}
progress-color=over {{colors.primary.default.hex}}

[urgency=high]
border-color={{colors.error.default.hex}}

[category=osd]
background-color={{colors.surface_dim.default.hex}}
text-color={{colors.on_primary.default.hex}}
border-color={{colors.surface_variant.default.hex}}
progress-color=over {{colors.primary.default.hex}}
#+end_src

**** Fuzzel Template
#+begin_src ini :tangle packages/matugen/.config/matugen/templates/fuzzel.ini
# Generated by matugen

[colors]
background={{colors.surface.default.hex}}ff
text={{colors.on_surface.default.hex}}ff
match={{colors.primary.default.hex}}ff
selection={{colors.primary_container.default.hex}}ff
selection-text={{colors.on_primary_container.default.hex}}ff
selection-match={{colors.primary.default.hex}}ff
border={{colors.primary.default.hex}}ff
#+end_src

**** Networkmanager_dmenu Template
#+begin_src ini :tangle packages/matugen/.config/matugen/templates/networkmanager_dmenu.ini
# Generated by matugen - networkmanager_dmenu configuration

[dmenu_passphrase]
obscure_color = {{colors.primary.default.hex}}
#+end_src

**** Qutebrowser Template
#+begin_src python :tangle packages/matugen/.config/matugen/templates/qutebrowser.py
# Generated by matugen - Qutebrowser colors
# This file is sourced by qutebrowser's config.py

# Color palette from matugen
bg = '{{colors.background.default.hex}}'
fg = '{{colors.on_background.default.hex}}'
primary = '{{colors.primary.default.hex}}'
on_primary = '{{colors.on_primary.default.hex}}'
primary_container = '{{colors.primary_container.default.hex}}'
on_primary_container = '{{colors.on_primary_container.default.hex}}'
secondary = '{{colors.secondary.default.hex}}'
on_secondary = '{{colors.on_secondary.default.hex}}'
secondary_container = '{{colors.secondary_container.default.hex}}'
on_secondary_container = '{{colors.on_secondary_container.default.hex}}'
tertiary = '{{colors.tertiary.default.hex}}'
on_tertiary = '{{colors.on_tertiary.default.hex}}'
tertiary_container = '{{colors.tertiary_container.default.hex}}'
on_tertiary_container = '{{colors.on_tertiary_container.default.hex}}'
surface = '{{colors.surface.default.hex}}'
on_surface = '{{colors.on_surface.default.hex}}'
surface_variant = '{{colors.surface_variant.default.hex}}'
on_surface_variant = '{{colors.on_surface_variant.default.hex}}'
surface_dim = '{{colors.surface_dim.default.hex}}'
error = '{{colors.error.default.hex}}'
on_error = '{{colors.on_error.default.hex}}'
outline = '{{colors.outline.default.hex}}'

# Completion (minimal - no alternating stripes, high contrast)
c.colors.completion.category.bg = surface_dim
c.colors.completion.category.border.bottom = outline
c.colors.completion.category.border.top = outline
c.colors.completion.category.fg = primary
c.colors.completion.even.bg = bg
c.colors.completion.odd.bg = bg
c.colors.completion.fg = fg
c.colors.completion.item.selected.bg = primary
c.colors.completion.item.selected.border.bottom = primary
c.colors.completion.item.selected.border.top = primary
c.colors.completion.item.selected.fg = on_primary
c.colors.completion.item.selected.match.fg = tertiary
c.colors.completion.match.fg = primary
c.colors.completion.scrollbar.bg = surface_variant
c.colors.completion.scrollbar.fg = primary

# Context menu
c.colors.contextmenu.disabled.bg = surface_dim
c.colors.contextmenu.disabled.fg = on_surface_variant
c.colors.contextmenu.menu.bg = surface
c.colors.contextmenu.menu.fg = on_surface
c.colors.contextmenu.selected.bg = primary
c.colors.contextmenu.selected.fg = on_primary

# Downloads
c.colors.downloads.bar.bg = surface
c.colors.downloads.error.bg = error
c.colors.downloads.error.fg = on_error
c.colors.downloads.start.bg = primary
c.colors.downloads.start.fg = on_primary
c.colors.downloads.stop.bg = tertiary
c.colors.downloads.stop.fg = on_tertiary

# Hints
c.colors.hints.bg = primary
c.colors.hints.fg = on_primary
c.colors.hints.match.fg = on_primary

# Keyhints
c.colors.keyhint.bg = surface
c.colors.keyhint.fg = on_surface
c.colors.keyhint.suffix.fg = primary

# Messages
c.colors.messages.error.bg = error
c.colors.messages.error.border = error
c.colors.messages.error.fg = on_error
c.colors.messages.info.bg = primary
c.colors.messages.info.border = primary
c.colors.messages.info.fg = on_primary
c.colors.messages.warning.bg = secondary
c.colors.messages.warning.border = secondary
c.colors.messages.warning.fg = on_secondary

# Prompts
c.colors.prompts.bg = surface
c.colors.prompts.border = outline
c.colors.prompts.fg = on_surface
c.colors.prompts.selected.bg = primary
c.colors.prompts.selected.fg = on_primary

# Statusbar (proper contrast for all modes)
c.colors.statusbar.caret.bg = primary
c.colors.statusbar.caret.fg = on_primary
c.colors.statusbar.caret.selection.bg = primary
c.colors.statusbar.caret.selection.fg = on_primary
c.colors.statusbar.command.bg = bg
c.colors.statusbar.command.fg = fg
c.colors.statusbar.command.private.bg = surface_dim
c.colors.statusbar.command.private.fg = fg
c.colors.statusbar.insert.bg = tertiary_container
c.colors.statusbar.insert.fg = on_tertiary_container
c.colors.statusbar.normal.bg = bg
c.colors.statusbar.normal.fg = fg
c.colors.statusbar.passthrough.bg = secondary
c.colors.statusbar.passthrough.fg = on_secondary
c.colors.statusbar.private.bg = surface_dim
c.colors.statusbar.private.fg = fg
c.colors.statusbar.progress.bg = primary
c.colors.statusbar.url.error.fg = error
c.colors.statusbar.url.fg = fg
c.colors.statusbar.url.hover.fg = primary
c.colors.statusbar.url.success.http.fg = fg
c.colors.statusbar.url.success.https.fg = fg
c.colors.statusbar.url.warn.fg = on_secondary_container

# Tabs (matches Hyprland border colors)
c.colors.tabs.bar.bg = surface_dim
c.colors.tabs.even.bg = bg
c.colors.tabs.even.fg = fg
c.colors.tabs.indicator.error = error
c.colors.tabs.indicator.start = primary
c.colors.tabs.indicator.stop = tertiary
c.colors.tabs.odd.bg = bg
c.colors.tabs.odd.fg = fg
c.colors.tabs.pinned.even.bg = surface_variant
c.colors.tabs.pinned.even.fg = on_surface
c.colors.tabs.pinned.odd.bg = surface_variant
c.colors.tabs.pinned.odd.fg = on_surface
c.colors.tabs.pinned.selected.even.bg = primary
c.colors.tabs.pinned.selected.even.fg = on_primary
c.colors.tabs.pinned.selected.odd.bg = primary
c.colors.tabs.pinned.selected.odd.fg = on_primary
c.colors.tabs.selected.even.bg = primary
c.colors.tabs.selected.even.fg = on_primary
c.colors.tabs.selected.odd.bg = primary
c.colors.tabs.selected.odd.fg = on_primary

# Webpage colors (respects site preferences, but provides fallback)
c.colors.webpage.bg = bg
# Convert mode to lowercase (matugen outputs "Dark"/"Light", qutebrowser needs "dark"/"light")
mode = '{{mode}}'
c.colors.webpage.preferred_color_scheme = mode.lower()
# Enable darkmode based on matugen theme
c.colors.webpage.darkmode.enabled = (mode.lower() == 'dark')
#+end_src

**** Qutebrowser Start-page Template
#+begin_src html :tangle packages/matugen/.config/matugen/templates/qutebrowser-startpage.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: monospace;
            background-color: {{colors.background.default.hex}};
            color: {{colors.on_background.default.hex}};
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            text-align: center;
            width: 100%;
            max-width: 600px;
            padding: 2rem;
        }

        h1 {
            color: {{colors.primary.default.hex}};
            font-size: 2rem;
            margin-bottom: 2rem;
            font-weight: normal;
        }

        form {
            width: 100%;
        }

        input[type="search"] {
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-family: monospace;
            background-color: {{colors.surface.default.hex}};
            color: {{colors.on_surface.default.hex}};
            border: 2px solid {{colors.outline.default.hex}};
            border-radius: 0;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="search"]:focus {
            border-color: {{colors.primary.default.hex}};
        }

        input[type="search"]::placeholder {
            color: {{colors.on_surface_variant.default.hex}};
        }
    </style>
    <script>
        function handleSearch(event) {
            event.preventDefault();
            const query = document.getElementById('search-input').value.trim();
            if (query) {
                window.location.href = 'https://duckduckgo.com/?q=' + encodeURIComponent(query);
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>~</h1>
        <form onsubmit="handleSearch(event)">
            <input type="search" id="search-input" placeholder="search" autofocus autocomplete="off">
        </form>
    </div>
</body>
</html>
#+end_src

**** GTK Template
#+begin_src css :tangle packages/matugen/.config/matugen/templates/gtk.css
/* Generated by matugen - GTK 3.0/4.0 Material You theme for adw-gtk3 */
/* This file overrides adw-gtk3 color variables with Material You colors */

/* === ADW-GTK3 COLOR OVERRIDES === */

/* Accent colors (Primary) */
@define-color accent_bg_color {{colors.primary.default.hex}};
@define-color accent_fg_color {{colors.on_primary.default.hex}};
@define-color accent_color {{colors.primary.default.hex}};

/* Window colors (Background) */
@define-color window_bg_color {{colors.background.default.hex}};
@define-color window_fg_color {{colors.on_background.default.hex}};

/* View colors (Surface) */
@define-color view_bg_color {{colors.surface.default.hex}};
@define-color view_fg_color {{colors.on_surface.default.hex}};

/* Headerbar colors (Surface Container) */
@define-color headerbar_bg_color {{colors.surface_container.default.hex}};
@define-color headerbar_fg_color {{colors.on_surface.default.hex}};
@define-color headerbar_backdrop_color {{colors.surface_dim.default.hex}};
@define-color headerbar_shade_color alpha({{colors.shadow.default.hex}}, 0.36);

/* Sidebar colors */
@define-color sidebar_bg_color {{colors.surface_container.default.hex}};
@define-color sidebar_fg_color {{colors.on_surface.default.hex}};
@define-color sidebar_backdrop_color {{colors.surface_dim.default.hex}};
@define-color sidebar_shade_color alpha({{colors.shadow.default.hex}}, 0.25);

/* Card colors (Surface Variant) */
@define-color card_bg_color {{colors.surface_variant.default.hex}};
@define-color card_fg_color {{colors.on_surface_variant.default.hex}};
@define-color card_shade_color alpha({{colors.shadow.default.hex}}, 0.36);

/* Dialog/Popover colors (Surface Container High) */
@define-color dialog_bg_color {{colors.surface_container_high.default.hex}};
@define-color dialog_fg_color {{colors.on_surface.default.hex}};
@define-color popover_bg_color {{colors.surface_container_high.default.hex}};
@define-color popover_fg_color {{colors.on_surface.default.hex}};

/* Destructive colors (Error) */
@define-color destructive_bg_color {{colors.error.default.hex}};
@define-color destructive_fg_color {{colors.on_error.default.hex}};
@define-color destructive_color {{colors.error.default.hex}};

/* Success colors (Tertiary - green-ish in Material You) */
@define-color success_bg_color {{colors.tertiary.default.hex}};
@define-color success_fg_color {{colors.on_tertiary.default.hex}};
@define-color success_color {{colors.tertiary.default.hex}};

/* Warning colors (Secondary) */
@define-color warning_bg_color {{colors.secondary.default.hex}};
@define-color warning_fg_color {{colors.on_secondary.default.hex}};
@define-color warning_color {{colors.secondary.default.hex}};

/* Error colors */
@define-color error_bg_color {{colors.error.default.hex}};
@define-color error_fg_color {{colors.on_error.default.hex}};
@define-color error_color {{colors.error.default.hex}};

/* Legacy GTK theme colors for compatibility */
@define-color theme_bg_color {{colors.background.default.hex}};
@define-color theme_fg_color {{colors.on_background.default.hex}};
@define-color theme_base_color {{colors.surface.default.hex}};
@define-color theme_text_color {{colors.on_surface.default.hex}};
@define-color theme_selected_bg_color {{colors.primary.default.hex}};
@define-color theme_selected_fg_color {{colors.on_primary.default.hex}};

/* Insensitive/disabled colors */
@define-color insensitive_bg_color {{colors.surface_dim.default.hex}};
@define-color insensitive_fg_color alpha({{colors.on_surface.default.hex}}, 0.38);
@define-color insensitive_base_color {{colors.surface_variant.default.hex}};

/* Borders and outlines */
@define-color borders {{colors.outline.default.hex}};
#+end_src

**** Qt6ct Template
#+begin_src conf :tangle packages/matugen/.config/matugen/templates/qt6ct.conf
# Generated by matugen - Qt6ct color scheme

[ColorScheme]
active_colors={{colors.on_background.default.hex}}, {{colors.surface.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_primary.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.background.default.hex}}, {{colors.surface.default.hex}}, {{colors.outline.default.hex}}, {{colors.primary.default.hex}}, {{colors.on_primary.default.hex}}, {{colors.primary.default.hex}}, {{colors.tertiary.default.hex}}, {{colors.surface.default.hex}}, {{colors.on_background.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface.default.hex}}
disabled_colors={{colors.on_surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}
inactive_colors={{colors.on_background.default.hex}}, {{colors.surface.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.background.default.hex}}, {{colors.surface.default.hex}}, {{colors.outline.default.hex}}, {{colors.primary_container.default.hex}}, {{colors.on_primary_container.default.hex}}, {{colors.primary.default.hex}}, {{colors.tertiary.default.hex}}, {{colors.surface.default.hex}}, {{colors.on_background.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface.default.hex}}
#+end_src

**** Qt5ct Template
#+begin_src conf :tangle packages/matugen/.config/matugen/templates/qt5ct.conf
# Generated by matugen - Qt5ct color scheme

[ColorScheme]
active_colors={{colors.on_background.default.hex}}, {{colors.surface.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_primary.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.background.default.hex}}, {{colors.surface.default.hex}}, {{colors.outline.default.hex}}, {{colors.primary.default.hex}}, {{colors.on_primary.default.hex}}, {{colors.primary.default.hex}}, {{colors.tertiary.default.hex}}, {{colors.surface.default.hex}}, {{colors.on_background.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface.default.hex}}
disabled_colors={{colors.on_surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface_variant.default.hex}}
inactive_colors={{colors.on_background.default.hex}}, {{colors.surface.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.surface_dim.default.hex}}, {{colors.outline.default.hex}}, {{colors.outline_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.background.default.hex}}, {{colors.surface.default.hex}}, {{colors.outline.default.hex}}, {{colors.primary_container.default.hex}}, {{colors.on_primary_container.default.hex}}, {{colors.primary.default.hex}}, {{colors.tertiary.default.hex}}, {{colors.surface.default.hex}}, {{colors.on_background.default.hex}}, {{colors.surface_variant.default.hex}}, {{colors.on_surface.default.hex}}, {{colors.on_surface_variant.default.hex}}, {{colors.on_surface.default.hex}}
#+end_src

#+RESULTS:

*** Scripts
**** Waybar
***** Update Checker Script
#+begin_src bash :tangle packages/matugen/.local/bin/waybar-updates :shebang "#!/usr/bin/env bash"
# Check for Arch and AUR updates
# Returns JSON for waybar

set -euo pipefail

# Count official repo updates
official_updates=$(checkupdates 2>/dev/null | wc -l)

# Count AUR updates (yay/paru exit 1 when no updates, handle it)
if command -v yay &>/dev/null; then
    aur_updates=$( (yay -Qua 2>/dev/null || true) | wc -l)
elif command -v paru &>/dev/null; then
    aur_updates=$( (paru -Qua 2>/dev/null || true) | wc -l)
else
    aur_updates=0
fi

# Calculate total
total_updates=$((official_updates + aur_updates))

if [ "$total_updates" -gt 0 ]; then
    # Build tooltip
    tooltip="Updates available:\n"
    tooltip+="Official: $official_updates\n"
    tooltip+="AUR: $aur_updates"

    # Return JSON
    echo "{\"text\":\"󰚰\",\"tooltip\":\"$tooltip\",\"class\":\"updates\"}"
else
    # No updates
    echo "{\"text\":\"\",\"tooltip\":\"System is up to date\",\"class\":\"no-updates\"}"
fi
#+end_src

***** Smart Dual Battery Script
#+begin_src bash :tangle packages/matugen/.local/bin/waybar-battery :shebang "#!/usr/bin/env bash"
# Smart dual battery indicator for Lenovo T480
# Combines BAT0 (internal, 24Wh) and BAT1 (external, 72Wh) into single percentage
# Returns JSON for waybar

set -euo pipefail

# Battery capacities in Wh (adjust these to match your actual batteries)
BAT0_CAPACITY=24  # Internal battery capacity in Wh
BAT1_CAPACITY=72  # External battery capacity in Wh
TOTAL_CAPACITY=$((BAT0_CAPACITY + BAT1_CAPACITY))

# Read battery info
BAT0_PATH="/sys/class/power_supply/BAT0"
BAT1_PATH="/sys/class/power_supply/BAT1"
AC_PATH="/sys/class/power_supply/AC"

# Check if batteries exist
if [[ ! -d "$BAT0_PATH" || ! -d "$BAT1_PATH" ]]; then
    echo "{\"text\":\"󰂑\",\"tooltip\":\"Battery not found\",\"class\":\"missing\"}"
    exit 0
fi

# Read battery percentages
bat0_percent=$(cat "$BAT0_PATH/capacity" 2>/dev/null || echo "0")
bat1_percent=$(cat "$BAT1_PATH/capacity" 2>/dev/null || echo "0")

# Read battery status
bat0_status=$(cat "$BAT0_PATH/status" 2>/dev/null || echo "Unknown")
bat1_status=$(cat "$BAT1_PATH/status" 2>/dev/null || echo "Unknown")

# Read AC status
ac_online=$(cat "$AC_PATH/online" 2>/dev/null || echo "0")

# Calculate energy remaining in Wh
bat0_energy=$(awk "BEGIN {printf \"%.1f\", $bat0_percent * $BAT0_CAPACITY / 100}")
bat1_energy=$(awk "BEGIN {printf \"%.1f\", $bat1_percent * $BAT1_CAPACITY / 100}")
total_energy=$(awk "BEGIN {printf \"%.1f\", $bat0_energy + $bat1_energy}")

# Calculate combined percentage
combined_percent=$(awk "BEGIN {printf \"%d\", ($total_energy / $TOTAL_CAPACITY) * 100}")

# Read power consumption (in µW)
bat0_power=$(cat "$BAT0_PATH/power_now" 2>/dev/null || echo "0")
bat1_power=$(cat "$BAT1_PATH/power_now" 2>/dev/null || echo "0")
total_power_uw=$((bat0_power + bat1_power))
total_power_w=$(awk "BEGIN {printf \"%.2f\", $total_power_uw / 1000000}")  # Convert to W

# Determine charging state
if [[ "$ac_online" == "1" ]]; then
    if [[ "$bat0_status" == "Charging" || "$bat1_status" == "Charging" ]]; then
        charging=true
        state="Charging"
    elif [[ "$bat0_status" == "Full" && "$bat1_status" == "Full" ]]; then
        charging=false
        state="Full"
    else
        charging=false
        state="Plugged"
    fi
else
    charging=false
    state="Discharging"
fi

# Select icon based on combined percentage and charging state
if [[ "$charging" == true ]]; then
    if [[ $combined_percent -ge 90 ]]; then icon="󰂅"
    elif [[ $combined_percent -ge 80 ]]; then icon="󰂋"
    elif [[ $combined_percent -ge 70 ]]; then icon="󰂊"
    elif [[ $combined_percent -ge 60 ]]; then icon="󰢞"
    elif [[ $combined_percent -ge 50 ]]; then icon="󰂉"
    elif [[ $combined_percent -ge 40 ]]; then icon="󰢝"
    elif [[ $combined_percent -ge 30 ]]; then icon="󰂈"
    elif [[ $combined_percent -ge 20 ]]; then icon="󰂇"
    elif [[ $combined_percent -ge 10 ]]; then icon="󰂆"
    else icon="󰢜"
    fi
elif [[ "$state" == "Full" ]]; then
    icon="󰂅"
elif [[ "$state" == "Plugged" ]]; then
    icon="󰚥"
else
    if [[ $combined_percent -ge 90 ]]; then icon="󰁹"
    elif [[ $combined_percent -ge 80 ]]; then icon="󰂂"
    elif [[ $combined_percent -ge 70 ]]; then icon="󰂁"
    elif [[ $combined_percent -ge 60 ]]; then icon="󰂀"
    elif [[ $combined_percent -ge 50 ]]; then icon="󰁿"
    elif [[ $combined_percent -ge 40 ]]; then icon="󰁾"
    elif [[ $combined_percent -ge 30 ]]; then icon="󰁽"
    elif [[ $combined_percent -ge 20 ]]; then icon="󰁼"
    elif [[ $combined_percent -ge 10 ]]; then icon="󰁻"
    else icon="󰁺"
    fi
fi

# Determine CSS class for styling
if [[ $combined_percent -le 10 ]]; then
    class="critical"
elif [[ $combined_percent -le 20 ]]; then
    class="warning"
elif [[ "$charging" == true ]]; then
    class="charging"
else
    class="normal"
fi

# Calculate time remaining
if [[ "$state" == "Discharging" ]] && (( $(echo "$total_power_w > 0.5" | awk '{print ($1 > 0.5)}') )); then
    time_hours=$(awk "BEGIN {printf \"%.2f\", $total_energy / $total_power_w}")
    hours=$(awk "BEGIN {printf \"%d\", int($time_hours)}")
    minutes=$(awk "BEGIN {printf \"%d\", int(($time_hours - $hours) * 60)}")
    time_remaining="${hours}h ${minutes}m remaining"
elif [[ "$state" == "Charging" ]] && (( $(echo "$total_power_w > 0.5" | awk '{print ($1 > 0.5)}') )); then
    energy_to_full=$(awk "BEGIN {printf \"%.2f\", $TOTAL_CAPACITY - $total_energy}")
    time_hours=$(awk "BEGIN {printf \"%.2f\", $energy_to_full / $total_power_w}")
    hours=$(awk "BEGIN {printf \"%d\", int($time_hours)}")
    minutes=$(awk "BEGIN {printf \"%d\", int(($time_hours - $hours) * 60)}")
    time_remaining="${hours}h ${minutes}m until full"
else
    time_remaining=""
fi

# Build tooltip
tooltip="Combined: ${combined_percent}% (${total_energy}Wh)"
[[ -n "$time_remaining" ]] && tooltip+="\n${time_remaining}"
tooltip+="\nPower: ${total_power_w}W\n"
tooltip+="BAT1 (External): ${bat1_percent}% (${bat1_energy}Wh) - ${bat1_status}\n"
tooltip+="BAT0 (Internal): ${bat0_percent}% (${bat0_energy}Wh) - ${bat0_status}\n"
tooltip+="Status: ${state}"

# Return JSON
echo "{\"text\":\"${icon}\",\"tooltip\":\"${tooltip}\",\"class\":\"${class}\",\"percentage\":${combined_percent}}"
#+end_src

***** Pomodoro Timer Script
#+begin_src bash :tangle packages/matugen/.local/bin/waybar-pomodoro :shebang "#!/usr/bin/env bash"
# Minimal pomodoro timer for waybar
# Left click: toggle (start/pause), Right click: reset

set -euo pipefail

STATE_FILE="${XDG_RUNTIME_DIR:-/tmp}/waybar-pomodoro-state"
WORK_TIME=1500    # 25 minutes in seconds
BREAK_TIME=300    # 5 minutes in seconds

# Initialize state file if it doesn't exist
if [[ ! -f "$STATE_FILE" ]]; then
    echo "idle" > "$STATE_FILE"
    echo "0" >> "$STATE_FILE"
    echo "$WORK_TIME" >> "$STATE_FILE"
fi

# Read current state
{
    read -r state
    read -r start_time
    read -r remaining
} < "$STATE_FILE"

# Handle commands
case "${1:-}" in
    toggle)
        if [[ "$state" == "idle" ]]; then
            # Start work session
            echo "work" > "$STATE_FILE"
            echo "$(date +%s)" >> "$STATE_FILE"
            echo "$WORK_TIME" >> "$STATE_FILE"
        elif [[ "$state" == "work" ]] || [[ "$state" == "break" ]]; then
            # Pause
            now=$(date +%s)
            elapsed=$((now - start_time))
            remaining=$((remaining - elapsed))
            if [[ $remaining -lt 0 ]]; then
                remaining=0
            fi
            echo "paused" > "$STATE_FILE"
            echo "$now" >> "$STATE_FILE"
            echo "$remaining" >> "$STATE_FILE"
        elif [[ "$state" == "paused" ]]; then
            # Resume
            mode="work"
            if [[ $remaining -le 0 ]]; then
                mode="break"
                remaining=$BREAK_TIME
            fi
            echo "$mode" > "$STATE_FILE"
            echo "$(date +%s)" >> "$STATE_FILE"
            echo "$remaining" >> "$STATE_FILE"
        fi
        exit 0
        ;;
    reset)
        echo "idle" > "$STATE_FILE"
        echo "0" >> "$STATE_FILE"
        echo "$WORK_TIME" >> "$STATE_FILE"
        exit 0
        ;;
esac

# Calculate remaining time
if [[ "$state" == "work" ]] || [[ "$state" == "break" ]]; then
    now=$(date +%s)
    elapsed=$((now - start_time))
    remaining=$((remaining - elapsed))

    # Check if timer finished
    if [[ $remaining -le 0 ]]; then
        # Auto-switch to break or work
        if [[ "$state" == "work" ]]; then
            # Send notification
            notify-send "Pomodoro" "Work session complete! Take a break." -u normal
            echo "break" > "$STATE_FILE"
            echo "$(date +%s)" >> "$STATE_FILE"
            echo "$BREAK_TIME" >> "$STATE_FILE"
            remaining=$BREAK_TIME
            state="break"
        else
            notify-send "Pomodoro" "Break over! Ready for work?" -u normal
            echo "idle" > "$STATE_FILE"
            echo "0" >> "$STATE_FILE"
            echo "$WORK_TIME" >> "$STATE_FILE"
            remaining=0
            state="idle"
        fi
    fi
fi

# Format time display
minutes=$((remaining / 60))
seconds=$((remaining % 60))
time_str=$(printf "%02d:%02d" $minutes $seconds)

# Determine icon and class
case "$state" in
    work)
        icon="󰔟"  # Focus icon
        class="work"
        tooltip="Work session: $time_str"
        text="$time_str"
        ;;
    break)
        icon="󰾩"  # Coffee icon
        class="break"
        tooltip="Break time: $time_str"
        text="$time_str"
        ;;
    paused)
        icon="󰏤"  # Pause icon
        class="paused"
        tooltip="Paused: $time_str"
        text="$time_str"
        ;;
    idle|*)
        icon="󱫐"  # Timer icon
        class="idle"
        tooltip="Pomodoro (click to start)"
        text=""
        ;;
esac

# Output JSON for waybar
echo "{\"text\":\"$text\",\"tooltip\":\"$tooltip\",\"class\":\"$class\",\"alt\":\"$icon\"}"
#+end_src

***** Hyprsunset Monitor Script
#+begin_src bash :tangle packages/matugen/.local/bin/waybar-hyprsunset :shebang "#!/usr/bin/env bash"
# Monitor hyprsunset temperature for waybar
# Click to open temperature selector menu

set -euo pipefail

STATE_FILE="${XDG_RUNTIME_DIR:-/tmp}/hyprsunset-temp"

# Handle click to open menu
if [[ "${1:-}" == "menu" ]]; then
    ~/.local/bin/hyprsunset-menu
    exit 0
fi

# Function to calculate temperature based on time and profiles
calculate_temp_from_time() {
    local current_time=$(date +%H:%M)
    local current_minutes=$((10#$(date +%H) * 60 + 10#$(date +%M)))

    # Profile times in minutes since midnight
    declare -A profiles=(
        [450]=6500    # 7:30 - identity (6500K)
        [840]=5500    # 14:00
        [960]=4500    # 16:00
        [1080]=3500   # 18:00
        [1200]=2500   # 20:00
    )

    # Sort times and find the active profile
    local active_temp=6500
    for time_min in $(echo "${!profiles[@]}" | tr ' ' '\n' | sort -n); do
        if (( current_minutes >= time_min )); then
            active_temp=${profiles[$time_min]}
        fi
    done

    echo "$active_temp"
}

# Get current temperature (check manual override first, then calculate from time)
if [[ -f "$STATE_FILE" ]]; then
    temp=$(cat "$STATE_FILE")
    manual_override=true
else
    temp=$(calculate_temp_from_time)
    manual_override=false
fi

# Determine icon and class based on temperature
if [[ $temp -ge 6000 ]]; then
    icon="󰛨"  # Sun icon (daylight)
    class="day"
    mode="Day"
elif [[ $temp -ge 4500 ]]; then
    icon="󰖚"  # Sunset icon (evening)
    class="evening"
    mode="Evening"
else
    icon="󰖔"  # Moon icon (night)
    class="night"
    mode="Night"
fi

# Format temperature display
temp_k="${temp}K"
if [[ "$manual_override" == "true" ]]; then
    tooltip="Color Temperature: $temp_k ($mode) [Manual]\nClick to change"
else
    tooltip="Color Temperature: $temp_k ($mode) [Auto]\nClick to change"
fi

# Output JSON for waybar
echo "{\"text\":\"$temp_k\",\"tooltip\":\"$tooltip\",\"class\":\"$class\",\"alt\":\"$icon\"}"
#+end_src

***** Backlight with Temperature Script
#+begin_src bash :tangle packages/matugen/.local/bin/waybar-backlight :shebang "#!/usr/bin/env bash"
# Monitor backlight and hyprsunset temperature for waybar
# Click to open temperature selector menu

set -euo pipefail

STATE_FILE="${XDG_RUNTIME_DIR:-/tmp}/hyprsunset-temp"

# Handle click to open menu
if [[ "${1:-}" == "menu" ]]; then
    ~/.local/bin/hyprsunset-menu
    exit 0
fi

# Get current brightness
if [[ -f /sys/class/backlight/intel_backlight/brightness ]]; then
    current=$(cat /sys/class/backlight/intel_backlight/brightness)
    max=$(cat /sys/class/backlight/intel_backlight/max_brightness)
    percent=$((current * 100 / max))
else
    # Fallback if brightness file doesn't exist
    percent=100
fi

# Determine brightness icon
if [[ $percent -le 33 ]]; then
    icon="󰃞"
elif [[ $percent -le 66 ]]; then
    icon="󰃟"
else
    icon="󰃠"
fi

# Function to calculate temperature based on time and profiles
calculate_temp_from_time() {
    local current_time=$(date +%H:%M)
    local current_minutes=$((10#$(date +%H) * 60 + 10#$(date +%M)))

    # Profile times in minutes since midnight
    declare -A profiles=(
        [450]=6500    # 7:30 - identity (6500K)
        [840]=5500    # 14:00
        [960]=4500    # 16:00
        [1080]=3500   # 18:00
        [1200]=2500   # 20:00
    )

    # Sort times and find the active profile
    local active_temp=6500
    for time_min in $(echo "${!profiles[@]}" | tr ' ' '\n' | sort -n); do
        if (( current_minutes >= time_min )); then
            active_temp=${profiles[$time_min]}
        fi
    done

    echo "$active_temp"
}

# Get current temperature (check manual override first, then calculate from time)
if [[ -f "$STATE_FILE" ]]; then
    temp=$(cat "$STATE_FILE")
    manual_override=true
else
    temp=$(calculate_temp_from_time)
    manual_override=false
fi

# Determine temperature mode
if [[ $temp -ge 6000 ]]; then
    temp_icon="󰛨"
    mode="Day"
elif [[ $temp -ge 4500 ]]; then
    temp_icon="󰖚"
    mode="Evening"
else
    temp_icon="󰖔"
    mode="Night"
fi

# Build tooltip
if [[ "$manual_override" == "true" ]]; then
    tooltip="Brightness: ${percent}%\nColor Temperature: ${temp}K ($mode) [Manual]\n\nClick to adjust temperature"
else
    tooltip="Brightness: ${percent}%\nColor Temperature: ${temp}K ($mode) [Auto]\n\nClick to adjust temperature"
fi

# Output JSON for waybar
echo "{\"text\":\"\",\"tooltip\":\"$tooltip\",\"class\":\"backlight\",\"alt\":\"$icon\"}"
#+end_src

**** OSD Notification Scripts
***** Volume Control with Notifications
#+begin_src bash :tangle packages/matugen/.local/bin/volume-notify :shebang "#!/usr/bin/env bash"
# Volume control with OSD-style notifications

set -euo pipefail

case "${1:-}" in
    up)
        pamixer -i 5
        ;;
    down)
        pamixer -d 5
        ;;
    mute)
        pamixer -t
        ;;
    *)
        echo "Usage: $0 {up|down|mute}"
        exit 1
        ;;
esac

# Get current volume and mute status
volume=$(pamixer --get-volume)
muted=$(pamixer --get-mute)

# Show OSD bar only (no text)
if [ "$muted" = "true" ]; then
    notify-send -c osd \
        -h string:x-canonical-private-synchronous:volume \
        -h int:value:0 \
        -t 1500 ""
else
    notify-send -c osd \
        -h string:x-canonical-private-synchronous:volume \
        -h int:value:"$volume" \
        -t 1500 ""
fi
#+end_src

***** Brightness Control with Notifications
#+begin_src bash :tangle packages/matugen/.local/bin/brightness-notify :shebang "#!/usr/bin/env bash"
# Brightness control with OSD-style notifications

set -euo pipefail

case "${1:-}" in
    up)
        light -A 5
        ;;
    down)
        light -U 5
        ;;
    *)
        echo "Usage: $0 {up|down}"
        exit 1
        ;;
esac

# Get current brightness percentage (integer)
brightness=$(light -G | cut -d'.' -f1)

# Show OSD bar only (no text)
notify-send -c osd \
    -h string:x-canonical-private-synchronous:brightness \
    -h int:value:"$brightness" \
    -t 1500 ""
#+end_src

**** Hyprsunset Fuzzel Menu
#+begin_src bash :tangle packages/matugen/.local/bin/hyprsunset-menu :shebang "#!/usr/bin/env bash"
# Fuzzel menu for selecting hyprsunset color temperature
set -euo pipefail

STATE_FILE="${XDG_RUNTIME_DIR:-/tmp}/hyprsunset-temp"

# Add Auto option first
if [[ -f "$STATE_FILE" ]]; then
    auto_marker="  "
else
    auto_marker="→ "
fi

# Temperature presets with descriptions
declare -A temps=(
    ["󰛨 Daylight (6500K)"]="6500"
    ["󰖨 Bright (5500K)"]="5500"
    ["󰖚 Evening (4500K)"]="4500"
    ["󰖙 Warm (3500K)"]="3500"
    ["󰖔 Night (2500K)"]="2500"
)

# Get current temperature for highlighting
current_temp=6500
if [[ -f "$STATE_FILE" ]]; then
    current_temp=$(cat "$STATE_FILE")
fi

# Build menu options (Auto first, then manual temps)
menu_options="${auto_marker}󰔎 Auto (Scheduled)\n"
for label in "${!temps[@]}"; do
    temp="${temps[$label]}"
    if [[ "$temp" == "$current_temp" ]] && [[ -f "$STATE_FILE" ]]; then
        menu_options+="→ $label\n"
    else
        menu_options+="  $label\n"
    fi
done

# Show fuzzel menu and get selection
selected=$(echo -e "${menu_options}" | fuzzel --dmenu --placeholder="Color Temperature..." --width=20)

# Exit if nothing selected
if [[ -z "$selected" ]]; then
    exit 0
fi

# Remove the → marker if present
selected="${selected#→ }"
selected="${selected#  }"

# Handle Auto mode
if [[ "$selected" == "󰔎 Auto (Scheduled)" ]]; then
    # Remove state file to return to auto mode
    rm -f "$STATE_FILE"

    # Kill existing hyprsunset and restart without arguments (uses config)
    pkill hyprsunset || true
    sleep 0.1
    hyprsunset &

    # Notify user
    notify-send "Color Temperature" "Auto mode enabled (using schedule)" -t 2000
    exit 0
fi

# Get temperature from selection
for label in "${!temps[@]}"; do
    if [[ "$label" == "$selected" ]]; then
        new_temp="${temps[$label]}"
        break
    fi
done

# Apply new temperature
if [[ -n "${new_temp:-}" ]]; then
    # Kill existing hyprsunset and start with new temperature
    pkill hyprsunset || true
    sleep 0.1
    hyprsunset -t "$new_temp" &

    # Save state
    echo "$new_temp" > "$STATE_FILE"

    # Notify user
    notify-send "Color Temperature" "Set to ${new_temp}K" -t 2000
fi
#+end_src

**** Mako Actions Fuzzel Menu
#+begin_src bash :tangle packages/matugen/.local/bin/mako-actions :shebang "#!/usr/bin/env bash"
# Interactive fuzzel menu for mako notification actions
# Supports both quick actions and per-notification action selection

set -euo pipefail

# Check if mako is running
if ! pgrep -x mako >/dev/null; then
    notify-send "Mako" "Mako notification daemon is not running"
    exit 1
fi

# Function to get list of notifications with IDs and summaries
get_notifications() {
    local list_output
    list_output=$(makoctl list 2>/dev/null)

    if [[ -z "$list_output" ]]; then
        return 1
    fi

    # Parse output: "Notification 123: Summary text"
    # Format for display: "123: Summary text (App name)"
    echo "$list_output" | awk '
        /^Notification [0-9]+:/ {
            match($0, /Notification ([0-9]+): (.+)/, arr)
            notif_id = arr[1]
            summary = arr[2]
            getline  # Get "App name: ..." line
            if (/App name:/) {
                match($0, /App name: (.+)/, arr2)
                app = arr2[1]
                printf "%s: %s (%s)\n", notif_id, summary, app
            }
        }
    '
}

# Get latest notification ID and summary
latest_notif_info=$(makoctl list 2>/dev/null | head -2)
latest_notif_id=""
latest_notif_summary=""

if [[ -n "$latest_notif_info" ]]; then
    latest_notif_id=$(echo "$latest_notif_info" | head -1 | grep -oP 'Notification \K\d+')
    latest_notif_summary=$(echo "$latest_notif_info" | head -1 | sed -E 's/^Notification [0-9]+: //')
fi

# Build menu dynamically
actions=()

# If there's a latest notification, get its actions and add to menu
if [[ -n "$latest_notif_id" ]]; then
    # Get actions for latest notification
    latest_actions=$(makoctl list 2>/dev/null | awk -v id="$latest_notif_id" '
        /^Notification [0-9]+:/ {
            match($0, /Notification ([0-9]+)/, arr)
            if (arr[1] == id) {
                in_notif = 1
            } else {
                in_notif = 0
            }
            next
        }
        in_notif && /^  Actions:/ {
            in_actions = 1
            next
        }
        in_notif && in_actions && /^    [a-zA-Z0-9_-]+:/ {
            match($0, /^    ([^:]+): (.+)/, arr)
            print arr[1] "|" arr[2]
        }
        in_notif && in_actions && /^[^ ]/ {
            exit
        }
    ')

    if [[ -n "$latest_actions" ]]; then
        actions+=("Latest: $latest_notif_summary")
        while IFS='|' read -r action_id action_label; do
            actions+=("  󰜎 $action_label")
        done <<< "$latest_actions"
        actions+=("───────────────────────")
    fi
fi

# Add standard menu options
actions+=(
    " Choose notification and action"
    "───────────────────────"
    "󰵅 Invoke default action (latest)"
    "󰎟 Dismiss latest"
    "󰎟 Dismiss all"
    "󰁯 Restore last dismissed"
)

# Show main menu
selected=$(printf '%s\n' "${actions[@]}" | fuzzel --dmenu --width 50 --placeholder "Notification Actions")

# Exit if nothing selected or separator selected
[[ -z "$selected" ]] && exit 0
[[ "$selected" == "───────────────────────" ]] && exit 0
[[ "$selected" =~ ^Latest: ]] && exit 0  # Header, not selectable

# Check if it's a latest notification action
if [[ "$selected" =~ ^"  󰜎 " ]]; then
    # Extract action label and find corresponding action ID
    action_label=$(echo "$selected" | sed 's/^  󰜎 //')
    action_id=$(echo "$latest_actions" | grep -F "|$action_label" | cut -d'|' -f1)

    if [[ -n "$action_id" ]]; then
        makoctl invoke -n "$latest_notif_id" "$action_id"
    fi
    exit 0
fi

# Handle other selections
case "$selected" in
    " Choose notification and action")
        # Get list of notifications
        notif_list=$(get_notifications)

        if [[ -z "$notif_list" ]]; then
            notify-send "Mako" "No notifications available"
            exit 0
        fi

        # Show notification picker
        selected_notif=$(echo "$notif_list" | fuzzel --dmenu --width 60 --placeholder "Select Notification")

        [[ -z "$selected_notif" ]] && exit 0

        # Extract notification ID (first field before colon)
        notif_id=$(echo "$selected_notif" | cut -d: -f1)

        # Use makoctl menu to let user select and invoke action
        if ! makoctl menu -n "$notif_id" -- fuzzel --dmenu --width 50 --placeholder "Choose Action"; then
            # If no action was selected or notification has no actions
            notify-send "Mako" "No action selected or notification has no actions"
        fi
        ;;
    "󰵅 Invoke default action (latest)")
        makoctl invoke
        ;;
    "󰎟 Dismiss latest")
        makoctl dismiss
        ;;
    "󰎟 Dismiss all")
        makoctl dismiss --all
        ;;
    "󰁯 Restore last dismissed")
        makoctl restore
        ;;
esac
#+end_src

**** Bitwarden Fuzzel Menu
#+begin_src bash :tangle packages/matugen/.local/bin/bitwarden-fuzzel :shebang "#!/usr/bin/env bash"
# Simple Bitwarden password manager with fuzzel
# Requires: bitwarden-cli, jq, wl-clipboard, wtype, fuzzel

set -euo pipefail

# Session and cache files (persistent across script invocations)
SESSION_FILE="${XDG_RUNTIME_DIR:-/tmp}/bw_session"
CACHE_FILE="${XDG_RUNTIME_DIR:-/tmp}/bw_cache"

# Don't cleanup session file on exit - keep it for next run
# Session will be cleared by hypridle on screen lock

# Check if logged in
if ! bw login --check &>/dev/null; then
    notify-send "Bitwarden" "Not logged in. Run: bw login in terminal" -u critical
    exit 1
fi

# Get or create session
get_session() {
    # Try to load existing session from file
    if [ -f "$SESSION_FILE" ]; then
        cat "$SESSION_FILE"
        return 0
    fi

    # Need to unlock - prompt for password
    password=$(echo "" | fuzzel --dmenu --password --lines 0 --placeholder "Enter Bitwarden Master Password..." --width 50)
    [ -z "$password" ] && exit 0

    # Unlock and get session key
    session=$(echo "$password" | bw unlock --raw 2>/dev/null)

    # Check if unlock was successful
    if [ -z "$session" ]; then
        notify-send "Bitwarden" "Failed to unlock vault - invalid password?" -u critical
        exit 1
    fi

    # Save session to file
    echo "$session" > "$SESSION_FILE"
    chmod 600 "$SESSION_FILE"

    echo "$session"
}

# Get session
BW_SESSION=$(get_session)
export BW_SESSION

# Try to use cached items first (cache persists until lock/suspend)
use_cache=false
if [ -f "$CACHE_FILE" ]; then
    items=$(cat "$CACHE_FILE")
    use_cache=true
fi

# If no cache, fetch from vault
if [ "$use_cache" = false ]; then
    # Show loading notification
    notify-send "Bitwarden" "Loading vault..." -t 2000 -u low &
    NOTIFY_PID=$!

    # Get all items (with error handling for invalid session)
    items=$(bw list items --session "$BW_SESSION" 2>/dev/null)

    # Close loading notification
    kill $NOTIFY_PID 2>/dev/null || true

    # If items fetch failed, session is invalid - remove it and retry once
    if [ -z "$items" ] || [ "$items" = "null" ]; then
        rm -f "$SESSION_FILE" "$CACHE_FILE"
        notify-send "Bitwarden" "Session expired, please unlock again" -u normal
        exec "$0"  # Restart the script
    fi

    # Save to cache for next time
    echo "$items" > "$CACHE_FILE"
    chmod 600 "$CACHE_FILE"
fi

# Build selection menu with "New Entry" and "Sync Vault" options
selection="➕ New Entry\n🔄 Sync Vault"
if [ -n "$items" ] && [ "$items" != "[]" ]; then
    login_items=$(echo "$items" | jq -r '
        .[] |
        select(.login != null) |
        .name + " | " + (.login.username // "no username")
    ')
    [ -n "$login_items" ] && selection="$selection\n$login_items"
fi

# Select item
chosen=$(echo -e "$selection" | fuzzel --dmenu --placeholder "Type to search..." --width 70 --lines 15)
[ -z "$chosen" ] && exit 0

# Handle sync vault
if [ "$chosen" = "🔄 Sync Vault" ]; then
    # Sync with server
    notify-send "Bitwarden" "Syncing with server..." -t 2000 -u low &
    NOTIFY_PID=$!

    bw sync --session "$BW_SESSION" >/dev/null 2>&1
    sync_result=$?

    kill $NOTIFY_PID 2>/dev/null || true

    if [ $sync_result -eq 0 ]; then
        # Clear cache and re-fetch
        rm -f "$CACHE_FILE"

        notify-send "Bitwarden" "Fetching updated vault..." -t 2000 -u low &
        NOTIFY_PID=$!

        items=$(bw list items --session "$BW_SESSION" 2>/dev/null)

        kill $NOTIFY_PID 2>/dev/null || true

        if [ -n "$items" ] && [ "$items" != "null" ]; then
            echo "$items" > "$CACHE_FILE"
            chmod 600 "$CACHE_FILE"
            notify-send "Bitwarden" "Vault synced successfully" -t 1500 -u low
            # Reopen the menu after successful sync
            exec "$0"
        else
            notify-send "Bitwarden" "Failed to fetch updated vault" -u critical
            exit 1
        fi
    else
        notify-send "Bitwarden" "Sync failed" -u critical
        exit 1
    fi
fi

# Handle new entry creation
if [ "$chosen" = "➕ New Entry" ]; then
    # Get entry details
    name=$(echo "" | fuzzel --dmenu --placeholder "Entry Name..." --width 50)
    [ -z "$name" ] && exit 0

    username=$(echo "" | fuzzel --dmenu --placeholder "Username..." --width 50)
    [ -z "$username" ] && exit 0

    password=$(echo "" | fuzzel --dmenu --password --placeholder "Password (leave empty to generate)..." --width 50)

    # Generate password if empty
    if [ -z "$password" ]; then
        password=$(bw generate --length 20 --uppercase --lowercase --number --special --session "$BW_SESSION" 2>/dev/null)
        if [ -n "$password" ]; then
            echo -n "$password" | wl-copy
            notify-send "Bitwarden" "Generated password copied to clipboard"
        else
            notify-send "Bitwarden" "Failed to generate password" -u critical
            exit 1
        fi
    fi

    uri=$(echo "" | fuzzel --dmenu --placeholder "Website URL (optional)..." --width 50)

    # Build JSON template using jq to properly escape values
    template=$(jq -n \
        --arg name "$name" \
        --arg username "$username" \
        --arg password "$password" \
        --arg uri "$uri" \
        '{
            organizationId: null,
            folderId: null,
            type: 1,
            name: $name,
            notes: null,
            favorite: false,
            fields: [],
            login: {
                uris: (if $uri != "" then [{"match": null, "uri": $uri}] else [] end),
                username: $username,
                password: $password,
                totp: null
            }
        }')

    # Create entry
    encoded=$(echo "$template" | bw encode)
    result=$(bw create item "$encoded" --session "$BW_SESSION" 2>&1)

    if echo "$result" | jq -e '.id' >/dev/null 2>&1; then
        notify-send "Bitwarden" "Entry '$name' created successfully"
        # Sync to server
        bw sync --session "$BW_SESSION" >/dev/null 2>&1
        # Clear cache so next run fetches updated vault
        rm -f "$CACHE_FILE"
    else
        # Show the actual error message
        error_msg=$(echo "$result" | head -1)
        notify-send "Bitwarden" "Failed: $error_msg" -u critical
    fi
    exit 0
fi

# Get item name from selection
item_name=$(echo "$chosen" | cut -d'|' -f1 | xargs)

# Get item details
item=$(echo "$items" | jq -r --arg name "$item_name" '.[] | select(.name == $name)')
item_id=$(echo "$item" | jq -r '.id')
username=$(echo "$item" | jq -r '.login.username // ""')
password=$(echo "$item" | jq -r '.login.password // ""')
totp=$(echo "$item" | jq -r '.login.totp // ""')

# Build actions menu
actions=""
[ -n "$username" ] && actions+="Copy Username\n"
[ -n "$password" ] && actions+="Copy Password\n"
[ -n "$username" ] && [ -n "$password" ] && actions+="Type Username + Tab + Password\n"
[ -n "$username" ] && actions+="Type Username\n"
[ -n "$password" ] && actions+="Type Password\n"
[ -n "$totp" ] && actions+="Copy TOTP Code\n"
actions+="🗑️ Delete Entry\n"

if [ -z "$actions" ]; then
    notify-send "Bitwarden" "No credentials found" -u normal
    exit 0
fi

# Show action menu
action=$(echo -e "${actions%\\n}" | fuzzel --dmenu --placeholder "Choose an action..." --width 50)
[ -z "$action" ] && exit 0

# Perform action
case "$action" in
    "Copy Username")
        echo -n "$username" | wl-copy
        notify-send "Bitwarden" "Username copied"
        ;;
    "Copy Password")
        echo -n "$password" | wl-copy
        notify-send "Bitwarden" "Password copied (clears in 45s)"
        (sleep 45 && wl-copy --clear) &
        ;;
    "Type Username + Tab + Password")
        sleep 0.3
        wtype "$username"
        wtype -k Tab
        sleep 0.1
        wtype "$password"
        notify-send "Bitwarden" "Credentials typed"
        ;;
    "Type Username")
        sleep 0.3
        wtype "$username"
        notify-send "Bitwarden" "Username typed"
        ;;
    "Type Password")
        sleep 0.3
        wtype "$password"
        notify-send "Bitwarden" "Password typed"
        ;;
    "Copy TOTP Code")
        totp_code=$(bw get totp "$item_name" --session "$BW_SESSION" 2>/dev/null)
        if [ -n "$totp_code" ]; then
            echo -n "$totp_code" | wl-copy
            notify-send "Bitwarden" "TOTP copied (clears in 30s)"
            (sleep 30 && wl-copy --clear) &
        else
            notify-send "Bitwarden" "Failed to get TOTP" -u normal
        fi
        ;;
    "🗑️ Delete Entry")
        # Verify we have a valid item ID
        if [ -z "$item_id" ] || [ "$item_id" = "null" ]; then
            notify-send "Bitwarden" "Error: Could not find item ID" -u critical
            exit 1
        fi

        # Confirm deletion
        confirm=$(echo -e "Cancel\nDelete" | fuzzel --dmenu --placeholder "Delete '$item_name'?" --width 50)
        if [ "$confirm" = "Delete" ]; then
            # Show deleting notification
            notify-send "Bitwarden" "Deleting '$item_name'..." -t 2000 -u low &
            NOTIFY_PID=$!

            result=$(bw delete item "$item_id" --session "$BW_SESSION" 2>&1)
            delete_status=$?

            kill $NOTIFY_PID 2>/dev/null || true

            if [ $delete_status -eq 0 ]; then
                # Sync to server
                bw sync --session "$BW_SESSION" >/dev/null 2>&1
                # Clear cache so next run fetches updated vault
                rm -f "$CACHE_FILE"
                # Success notification
                notify-send "Bitwarden" "✓ Successfully deleted '$item_name'" -u normal
            else
                error_msg=$(echo "$result" | head -1)
                notify-send "Bitwarden" "Failed to delete: $error_msg" -u critical
            fi
        else
            notify-send "Bitwarden" "Deletion cancelled" -u low
        fi
        ;;
esac
#+end_src

**** Wallpapaer Selector
***** Hyprland
#+begin_src bash :tangle packages/matugen/.local/bin/select-wallpaper.sh :shebang "#!/usr/bin/env bash"
set -euo pipefail

# Wallpaper directory
WALLPAPER_DIR="$HOME/dotfile/wallpapers"

# Check if directory exists
if [ ! -d "$WALLPAPER_DIR" ]; then
    notify-send "Error" "Wallpaper directory not found: $WALLPAPER_DIR" -u critical
    exit 1
fi

# Get list of wallpapers (excluding README)
wallpapers=$(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" \) -exec basename {} \; | sort)

# Check if any wallpapers found
if [ -z "$wallpapers" ]; then
    notify-send "Error" "No wallpapers found in $WALLPAPER_DIR" -u critical
    exit 1
fi

# Select wallpaper using fuzzel
selected_wallpaper=$(echo "$wallpapers" | fuzzel --dmenu --placeholder "Select wallpaper...")

# Exit if cancelled
if [ -z "$selected_wallpaper" ]; then
    exit 0
fi

# Select theme mode
mode=$(printf "dark\nlight" | fuzzel --dmenu --placeholder "Select theme...")

# Exit if cancelled
if [ -z "$mode" ]; then
    exit 0
fi

# Select color scheme type
scheme=$(printf "scheme-tonal-spot\nscheme-content\nscheme-monochrome\nscheme-expressive\nscheme-fidelity\nscheme-neutral\nscheme-fruit-salad\nscheme-rainbow" | fuzzel --dmenu --placeholder "Select color scheme...")

# Exit if cancelled (default to scheme-tonal-spot if cancelled)
if [ -z "$scheme" ]; then
    scheme="scheme-tonal-spot"
fi

# Full path to selected wallpaper
wallpaper_path="$WALLPAPER_DIR/$selected_wallpaper"

# Generate colors with matugen
notify-send "Matugen" "Generating $mode theme ($scheme) from $selected_wallpaper..." -u low

if matugen image "$wallpaper_path" -m "$mode" -t "$scheme"; then
    # Update default.jpg symlink to persist wallpaper selection across reboots
    ln -sf "$selected_wallpaper" "$WALLPAPER_DIR/default.jpg"

    # Recolor Papirus folders to match primary color
    # Extract RGB values from matugen colors
    primary_hex=$(grep '^\$primary = ' ~/.cache/matugen/colors-hyprland.conf | sed 's/.*rgb(\([0-9a-f]\{6\}\)).*/\1/' || echo "8ecff2")

    # Convert hex to RGB and map to nearest papirus color
    r=$((16#${primary_hex:0:2}))
    g=$((16#${primary_hex:2:2}))
    b=$((16#${primary_hex:4:2}))

    # Simple hue-based mapping to papirus colors
    if [ $r -gt $g ] && [ $r -gt $b ]; then
        if [ $g -gt $b ]; then
            papirus_color="orange"  # Red-yellow
        else
            papirus_color="red"     # Red-blue
        fi
    elif [ $g -gt $r ] && [ $g -gt $b ]; then
        if [ $r -gt $b ]; then
            papirus_color="yellow"  # Green-yellow
        else
            papirus_color="green"   # Green-blue
        fi
    else
        if [ $r -gt $g ]; then
            papirus_color="violet"  # Blue-red
        else
            papirus_color="cyan"    # Blue-green
        fi
    fi

    sudo papirus-folders -C "$papirus_color" --theme Papirus-Dark 2>/dev/null || true

    # Set wallpaper with hyprpaper
    hyprctl hyprpaper unload all
    hyprctl hyprpaper preload "$wallpaper_path"
    hyprctl hyprpaper wallpaper ",$wallpaper_path"

    # Reload hyprland
    hyprctl reload

    # Reload waybar and mako explicitly
    pkill waybar || true
    pkill mako || true
    sleep 0.2
    waybar &
    mako &

    # Reload qutebrowser config (for all running instances)
    for socket in ~/.local/share/qutebrowser/runtime/ipc-*; do
        if [ -S "$socket" ]; then
            qutebrowser --target window --untrusted-args ":config-source" 2>/dev/null || true
        fi
    done

    notify-send "Theme Applied" "Wallpaper: $selected_wallpaper\nMode: $mode\nScheme: $scheme" -u normal
else
    notify-send "Error" "Failed to generate theme" -u critical
    exit 1
fi
#+end_src

***** Sway
#+begin_src bash :tangle no
set -euo pipefail

# Wallpaper directory
WALLPAPER_DIR="$HOME/dotfile/wallpapers"

# Check if directory exists
if [ ! -d "$WALLPAPER_DIR" ]; then
    notify-send "Error" "Wallpaper directory not found: $WALLPAPER_DIR" -u critical
    exit 1
fi

# Get list of wallpapers (excluding README)
wallpapers=$(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" \) -exec basename {} \; | sort)

# Check if any wallpapers found
if [ -z "$wallpapers" ]; then
    notify-send "Error" "No wallpapers found in $WALLPAPER_DIR" -u critical
    exit 1
fi

# Select wallpaper using fuzzel
selected_wallpaper=$(echo "$wallpapers" | fuzzel --dmenu --placeholder "Select wallpaper...")

# Exit if cancelled
if [ -z "$selected_wallpaper" ]; then
    exit 0
fi

# Select theme mode
mode=$(printf "dark\nlight" | fuzzel --dmenu --placeholder "Select theme...")

# Exit if cancelled
if [ -z "$mode" ]; then
    exit 0
fi

# Full path to selected wallpaper
wallpaper_path="$WALLPAPER_DIR/$selected_wallpaper"

# Generate colors with matugen
notify-send "Matugen" "Generating $mode theme from $selected_wallpaper..." -u low

if matugen image "$wallpaper_path" -m "$mode"; then
    # Set wallpaper with swaybg
    pkill swaybg || true
    swaybg -i "$wallpaper_path" -m fill &

    # Reload sway
    swaymsg reload

    # Reload waybar and mako explicitly
    pkill waybar || true
    pkill mako || true
    sleep 0.2
    waybar &
    mako &

    # Reload qutebrowser config (for all running instances)
    for socket in ~/.local/share/qutebrowser/runtime/ipc-*; do
        if [ -S "$socket" ]; then
            qutebrowser --target window --untrusted-args ":config-source" 2>/dev/null || true
        fi
    done

    notify-send "Theme Applied" "Wallpaper: $selected_wallpaper\nMode: $mode\nScheme: $scheme" -u normal
else
    notify-send "Error" "Failed to generate theme" -u critical
    exit 1
fi
#+end_src

**** Screenshot Selector
***** Sway
#+begin_src bash :tangle packages/sway/.local/bin/screenshot.sh :shebang "#!/usr/bin/env bash"
set -euo pipefail

# Screenshot directory
SCREENSHOT_DIR="$HOME/Pictures/Screenshots"
mkdir -p "$SCREENSHOT_DIR"

# Screenshot filename with timestamp
FILENAME="$SCREENSHOT_DIR/screenshot_$(date +%Y%m%d_%H%M%S).png"

# Function to take screenshot, copy, and save
take_screenshot() {
    local mode=$1

    # Take screenshot based on mode
    if grimshot save "$mode" "$FILENAME"; then
        # Copy to clipboard
        wl-copy < "$FILENAME"

        # Show notification with preview
        notify-send "Screenshot Saved" \
            "Mode: $mode\nFile: $(basename "$FILENAME")\nCopied to clipboard" \
            -i "$FILENAME" \
            -u normal
    else
        notify-send "Screenshot Failed" \
            "Failed to capture $mode" \
            -u critical
    fi
}

# If argument provided, take screenshot directly
if [ $# -gt 0 ]; then
    take_screenshot "$1"
    exit 0
fi

# Show fuzzel menu to select mode
MODE=$(printf "Screen (full)\nArea (selection)\nWindow (active)\nOutput (monitor)" | \
    fuzzel --dmenu --placeholder "What to screenshot...")

# Exit if cancelled
if [ -z "$MODE" ]; then
    exit 0
fi

# Map selection to grimshot mode
case "$MODE" in
    "Screen (full)")
        take_screenshot "screen"
        ;;
    "Area (selection)")
        take_screenshot "area"
        ;;
    "Window (active)")
        take_screenshot "active"
        ;;
    "Output (monitor)")
        take_screenshot "output"
        ;;
esac
#+end_src

***** Hyprland
#+begin_src bash :tangle packages/hyprland/.local/bin/screenshot.sh :shebang "#!/usr/bin/env bash"
set -euo pipefail

# Screenshot directory
SCREENSHOT_DIR="$HOME/Pictures/Screenshots"
mkdir -p "$SCREENSHOT_DIR"

# Screenshot filename with timestamp
FILENAME="$SCREENSHOT_DIR/screenshot_$(date +%Y%m%d_%H%M%S).png"

# Function to take screenshot, copy, and save
take_screenshot() {
    local mode=$1

    # Take screenshot based on mode using hyprshot
    case "$mode" in
        "screen")
            hyprshot -m output -o "$SCREENSHOT_DIR" -f "$(basename "$FILENAME")" --clipboard-only
            ;;
        "area")
            hyprshot -m region -o "$SCREENSHOT_DIR" -f "$(basename "$FILENAME")" --clipboard-only
            ;;
        "window")
            hyprshot -m window -o "$SCREENSHOT_DIR" -f "$(basename "$FILENAME")" --clipboard-only
            ;;
    esac

    # Check if screenshot was created
    if [ -f "$FILENAME" ]; then
        notify-send "Screenshot Saved" \
            "Mode: $mode\nFile: $(basename "$FILENAME")\nCopied to clipboard" \
            -i "$FILENAME" \
            -u normal
    else
        notify-send "Screenshot Failed" \
            "Failed to capture $mode" \
            -u critical
    fi
}

# If argument provided, take screenshot directly
if [ $# -gt 0 ]; then
    take_screenshot "$1"
    exit 0
fi

# Show fuzzel menu to select mode
MODE=$(printf "Screen (full)\nArea (selection)\nWindow (active)" | \
    fuzzel --dmenu --placeholder "Screenshot...")

# Exit if cancelled
if [ -z "$MODE" ]; then
    exit 0
fi

# Map selection to screenshot mode
case "$MODE" in
    "Screen (full)")
        take_screenshot "screen"
        ;;
    "Area (selection)")
        take_screenshot "area"
        ;;
    "Window (active)")
        take_screenshot "window"
        ;;
esac
#+end_src

**** Layout Indicator Script
#+begin_src bash :tangle packages/sway/.local/bin/get-layout.sh :shebang "#!/usr/bin/env bash"
# Get the layout of the parent container of the focused window
# Focused windows themselves have layout "none", so we need to check the parent

TREE=$(swaymsg -t get_tree)

# Find the focused window and get its ID
FOCUSED_ID=$(echo "$TREE" | jq -r '.. | select(.focused? == true) | .id')

# Find the parent container of the focused window
PARENT_LAYOUT=$(echo "$TREE" | jq -r --arg id "$FOCUSED_ID" '
  .. |
  objects |
  select(.nodes[]?.id == ($id | tonumber) or .floating_nodes[]?.id == ($id | tonumber)) |
  .layout
' | grep -v "^null$" | head -1)

# If no parent found, try getting workspace layout
if [ -z "$PARENT_LAYOUT" ] || [ "$PARENT_LAYOUT" = "none" ]; then
    PARENT_LAYOUT=$(echo "$TREE" | jq -r '.. | select(.type? == "workspace" and .focused? == true) | .layout' | head -1)
fi

# Map layout names to symbols
case "$PARENT_LAYOUT" in
    splith) echo "⬌" ;;
    splitv) echo "⬍" ;;
    tabbed) echo "☰" ;;
    stacked) echo "☷" ;;
    *) echo "▪" ;;  # Default symbol for unknown/single window
esac
#+end_src

**** Help Menu Script
#+begin_src bash :tangle packages/matugen/.local/bin/help-menu :shebang "#!/usr/bin/env bash"
# Interactive help menu for dotfiles configuration
# Shows keybindings and system information using fuzzel

set -euo pipefail

# Detect which WM is running
detect_wm() {
    if pgrep -x Hyprland >/dev/null; then
        echo "hyprland"
    elif pgrep -x sway >/dev/null; then
        echo "sway"
    else
        echo "unknown"
    fi
}

WM=$(detect_wm)

# Show keybindings for a category
show_keybindings() {
    local category="$1"
    local bindings=""

    case "$category" in
        "Applications")
            if [ "$WM" = "hyprland" ]; then
                bindings="SUPER + Return → Terminal
SUPER + SHIFT + Return → Floating terminal (scratchpad)
SUPER + CTRL + Return → Floating terminal
SUPER + D → Application launcher (fuzzel)
SUPER + B → Browser (qutebrowser)
SUPER + SHIFT + B → Bitwarden password manager
SUPER + E → File manager (yazi)
SUPER + N → Emacs (client)
SUPER + SHIFT + N → Emacs (new instance)
SUPER + SHIFT + P → Wallpaper selector"
            else # sway
                bindings="SUPER + Return → Terminal
SUPER + SHIFT + Return → Floating terminal
SUPER + D → Application launcher (fuzzel)
SUPER + B → Browser (qutebrowser)
SUPER + SHIFT + B → Bitwarden password manager
SUPER + Y → File manager (yazi)
SUPER + N → Emacs (client)
SUPER + SHIFT + N → Emacs (new instance)
SUPER + P → Wallpaper selector"
            fi
            ;;
        "Window Management")
            if [ "$WM" = "hyprland" ]; then
                bindings="SUPER + Q → Close window
SUPER + CTRL + F → Fullscreen
SUPER + SHIFT + F → Maximize (fullscreen mode 1)
SUPER + F → Toggle floating
SUPER + Tab → Focus last window
SUPER + ALT + S → Pin window
SUPER + G → Toggle group/tabs
SUPER + SHIFT + G → Move out of group
SUPER + CTRL + G → Lock group
SUPER + S → Change group tab (forward)
SUPER + T → Cycle through windows
SUPER + P → Pseudo-tiling mode"
            else # sway
                bindings="SUPER + Q → Close window
SUPER + SHIFT + CTRL + F → Fullscreen toggle
SUPER + SHIFT + F → Global fullscreen
SUPER + F → Toggle floating
SUPER + Tab → Focus mode toggle
SUPER + ALT + S → Sticky toggle
SUPER + W → Tabbed layout
SUPER + S → Stacking layout
SUPER + E → Toggle split layout
SUPER + T → Toggle all layouts
SUPER + V → Vertical split
SUPER + - → Horizontal split"
            fi
            ;;
        "Navigation")
            bindings="SUPER + H/J/K/L → Focus left/down/up/right
SUPER + Arrow keys → Focus in direction
(VIM-style navigation)"
            ;;
        "Moving Windows")
            if [ "$WM" = "hyprland" ]; then
                bindings="SUPER + SHIFT + H/J/K/L → Move window
SUPER + SHIFT + Arrows → Move window
SUPER + CTRL + H/J/K/L → Move window or group
SUPER + CTRL + SHIFT + H/J/K/L → Move to monitor"
            else # sway
                bindings="SUPER + SHIFT + H/J/K/L → Move window
SUPER + SHIFT + Arrows → Move window
SUPER + CTRL + SHIFT + H/J/K/L → Move to output"
            fi
            ;;
        "Workspaces")
            if [ "$WM" = "hyprland" ]; then
                bindings="SUPER + 1-9 → Switch to workspace
SUPER + SHIFT + 1-9 → Move window (silent)
SUPER + CTRL + 1-9 → Move window and switch
SUPER + W → Toggle scratchpad
SUPER + SHIFT + W → Move to scratchpad"
            else # sway
                bindings="SUPER + 1-9 → Switch to workspace
SUPER + SHIFT + 1-9 → Move window to workspace
SUPER + CTRL + 1-9 → Move and switch
SUPER + \` → Show scratchpad
SUPER + SHIFT + \` → Move to scratchpad"
            fi
            ;;
        "Hardware Controls")
            bindings="XF86AudioRaiseVolume → Volume up (+5%)
XF86AudioLowerVolume → Volume down (-5%)
XF86AudioMute → Toggle mute
XF86AudioMicMute → Toggle mic mute
XF86MonBrightnessUp → Brightness up (+5%)
XF86MonBrightnessDown → Brightness down (-5%)
Print → Screenshot menu
SUPER + SHIFT + S → Screenshot menu
SHIFT + Print → Full screen screenshot
SUPER + SHIFT + CTRL + S → Full screen screenshot"
            ;;
        "Utilities")
            if [ "$WM" = "hyprland" ]; then
                bindings="SUPER + Escape → Lock screen
SUPER + M → Restore notification
SUPER + CTRL + M → Dismiss notification
SUPER + SHIFT + M → Notification actions menu
SUPER + CTRL + SHIFT + M → List all notifications
SUPER + SHIFT + I → Network manager
SUPER + C → Color picker
SUPER + SHIFT + T → Color temperature
SUPER + SHIFT + V → Clipboard history
SUPER + CTRL + SHIFT + V → Clear clipboard"
            else # sway
                bindings="SUPER + Escape → Lock screen
SUPER + M → Invoke notification action
SUPER + CTRL + M → Dismiss notification
SUPER + SHIFT + M → Notification menu
SUPER + SHIFT + V → Clipboard history"
            fi
            ;;
        "Resizing Windows")
            bindings="SUPER + R → Enter resize mode
Then use:
  H/J/K/L → Resize window
  Arrow keys → Resize window
  Return/Escape → Exit resize mode"
            ;;
        "System Controls")
            if [ "$WM" = "hyprland" ]; then
                bindings="SUPER + SHIFT + C → Reload config
SUPER + SHIFT + Q → Exit Hyprland
SUPER + SHIFT + R → Re-tangle dotfiles"
            else # sway
                bindings="SUPER + SHIFT + C → Reload config
SUPER + SHIFT + Q → Exit Sway
SUPER + SHIFT + R → Re-tangle dotfiles"
            fi
            ;;
        "Mouse & Gestures")
            if [ "$WM" = "hyprland" ]; then
                bindings="SUPER + Left click → Move window
SUPER + Right click → Resize window
SUPER + Z → Resize window (keyboard)
3-finger horizontal swipe → Navigate workspaces
3-finger swipe down → Toggle special workspace"
            else # sway
                bindings="SUPER + Left click → Move window
SUPER + Right click → Resize window
3-finger swipe right/left → Workspace prev/next
3-finger swipe down → Show scratchpad"
            fi
            ;;
    esac

    echo "$bindings"
}

# Show system information
show_system_info() {
    local info=""

    info="═══ System Information ═══

Window Manager: ${WM^}
Shell: zsh with zinit
Terminal: foot
Launcher: fuzzel
Browser: qutebrowser
File Manager: yazi
Editor: emacs/emacsclient
Notifications: mako
Wallpaper: $([ "$WM" = "hyprland" ] && echo "hyprpaper" || echo "swaybg")
Theme: matugen (Material You)
Bar: waybar

═══ Dotfiles Structure ═══

. * All configs in: ~/dotfile/dotfiles.org
. * Generate configs: ./scripts/tangle.sh
. * Deploy configs: ./scripts/stow-pkg.sh [packages]
. * Packages dir: ~/dotfile/packages/

═══ Quick Commands ═══

Tangle dotfiles:
  ./scripts/tangle.sh

Deploy all (Hyprland):
  ./scripts/stow-pkg.sh hyprland mako fuzzel foot yazi qutebrowser zsh matugen

Deploy all (Sway):
  ./scripts/stow-pkg.sh sway mako fuzzel foot yazi qutebrowser swaylock swayidle zsh matugen

Remove package:
  stow -d packages -t ~ -D [package]

═══ User Scripts ═══

~/.local/bin/bitwarden-fuzzel → Password manager
~/.local/bin/select-wallpaper.sh → Wallpaper selector
~/.local/bin/screenshot.sh → Screenshot tool
~/.local/bin/mako-actions → Notification actions
~/.local/bin/waybar-pomodoro → Pomodoro timer
~/.local/bin/waybar-updates → Update checker
~/.local/bin/waybar-battery → Battery monitor
~/.local/bin/help-menu → This help menu"

    echo "$info"
}

# Main menu
show_main_menu() {
    local menu="󰌌  Applications
󱂬  Window Management
󰹹  Navigation
󰜬  Moving Windows
󰍹  Workspaces
󱤓  Hardware Controls
󰒓  Utilities
󰩨  Resizing Windows
󱂵  Mouse & Gestures
󰒲  System Controls
───────────────────────
  System Information
  Quick Reference
───────────────────────
󰩈  Exit"

    echo "$menu"
}

# Quick reference showing most common keybindings
show_quick_reference() {
    local ref=""

    if [ "$WM" = "hyprland" ]; then
        ref="═══ Most Used Keybindings ═══

SUPER + Return → Terminal
SUPER + D → Launcher
SUPER + B → Browser
SUPER + Q → Close window
SUPER + F → Toggle floating
SUPER + H/J/K/L → Navigate windows
SUPER + SHIFT + H/J/K/L → Move window
SUPER + 1-9 → Switch workspace
SUPER + R → Resize mode
SUPER + M → Notifications
SUPER + Escape → Lock screen
SUPER + SHIFT + P → Wallpaper selector
SUPER + SHIFT + B → Bitwarden
SUPER + SHIFT + C → Reload config"
    else # sway
        ref="═══ Most Used Keybindings ═══

SUPER + Return → Terminal
SUPER + D → Launcher
SUPER + B → Browser
SUPER + Q → Close window
SUPER + F → Toggle floating
SUPER + H/J/K/L → Navigate windows
SUPER + SHIFT + H/J/K/L → Move window
SUPER + 1-9 → Switch workspace
SUPER + R → Resize mode
SUPER + M → Notifications
SUPER + Escape → Lock screen
SUPER + P → Wallpaper selector
SUPER + SHIFT + B → Bitwarden
SUPER + SHIFT + C → Reload config"
    fi

    echo "$ref"
}

# Check WM detection
if [ "$WM" = "unknown" ]; then
    notify-send "Help Menu" "Could not detect window manager (Hyprland/Sway)" -u critical
    exit 1
fi

# Show main menu
selected=$(show_main_menu | fuzzel --dmenu --width 22 --placeholder "Help Menu - ${WM^}" --lines 20)

# Exit if nothing selected or separator selected
[[ -z "$selected" ]] && exit 0
[[ "$selected" == "───────────────────────" ]] && exit 0

# Handle selection
case "$selected" in
    "󰩈  Exit")
        exit 0
        ;;
    "  System Information")
        show_system_info | fuzzel --dmenu --width 80 --placeholder "System Information" --lines 30
        ;;
    "  Quick Reference")
        show_quick_reference | column -t -s '→' | fuzzel --dmenu --width 60 --placeholder "Quick Reference" --lines 20
        ;;
    ,*)
        # Extract category name (remove icon and extra spaces)
        category=$(echo "$selected" | sed 's/^[^ ]*  //')
        keybindings=$(show_keybindings "$category" | column -t -s '→')
        echo "$keybindings" | fuzzel --dmenu --width 70 --placeholder "$category - ${WM^}" --lines 20
        ;;
esac
#+end_src

**** Hyprland Reload Script
#+begin_src bash :tangle packages/matugen/.local/bin/hyprland-reload :shebang "#!/usr/bin/env bash"
# Reload Hyprland and restart all services properly

# Kill old services
pkill waybar
pkill mako

# Wait for processes to terminate
sleep 0.5

# Reload Hyprland configuration
hyprctl reload

# Start services
waybar &
mako &

# Wait a moment for services to start
sleep 0.3

# Send success notification
notify-send "Hyprland" "Configuration reloaded successfully" -u low
#+end_src
* Shell & Terminal
** Zsh
Feature-rich interactive shell with completions, syntax highlighting, and custom scripts.

*** Performance
Enable profiling (optional)
#+begin_src sh :tangle packages/zsh/.zshrc
# Uncomment to profile zsh startup time
# zmodload zsh/zprof
#+end_src

*** Core Configuration
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# ZSH Core Configuration
# ============================================================================

# Auto-start WM on TTY1 (before anything else)
if [ -z "$WAYLAND_DISPLAY" ] && [ "$XDG_VTNR" -eq 1 ]; then
  exec ~/.local/bin/select-wm.sh hyprland
fi

# History configuration
HISTFILE=~/.cache/zsh/history
HISTSIZE=50000
SAVEHIST=50000

# Create cache directory if it doesn't exist
[[ -d ~/.cache/zsh ]] || mkdir -p ~/.cache/zsh
#+end_src

*** ZSH Options
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# ZSH Options
# ============================================================================

# History options
setopt EXTENDED_HISTORY          # Write timestamp to history
setopt HIST_EXPIRE_DUPS_FIRST    # Expire duplicate entries first
setopt HIST_IGNORE_DUPS          # Don't record duplicates
setopt HIST_IGNORE_SPACE         # Don't record commands starting with space
setopt HIST_VERIFY               # Show command with history expansion before running
setopt SHARE_HISTORY             # Share history between sessions
setopt HIST_REDUCE_BLANKS        # Remove superfluous blanks
setopt INC_APPEND_HISTORY        # Write to history immediately

# Directory options
setopt AUTO_CD                   # cd by typing directory name
setopt AUTO_PUSHD                # Push directories onto stack
setopt PUSHD_IGNORE_DUPS         # Don't push duplicates
setopt PUSHD_SILENT              # Don't print directory stack

# Completion options
setopt ALWAYS_TO_END             # Move cursor to end after completion
setopt AUTO_MENU                 # Show completion menu on tab
setopt COMPLETE_IN_WORD          # Complete from both ends of word
# setopt MENU_COMPLETE             # Autoselect first completion entry (DISABLED: conflicts with cd)

# Correction and expansion
setopt CORRECT                   # Correct command spelling
setopt EXTENDED_GLOB             # Extended globbing patterns

# Other options
setopt INTERACTIVE_COMMENTS      # Allow comments in interactive shell
setopt MULTIOS                   # Enable multiple redirections
#+end_src

*** Zinit Plugin Manager
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Zinit Plugin Manager
# ============================================================================

# Install zinit if not present
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
if [[ ! -d "$ZINIT_HOME" ]]; then
   mkdir -p "$(dirname $ZINIT_HOME)"
   git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi

# Load zinit
source "${ZINIT_HOME}/zinit.zsh"
#+end_src

*** Essential Plugins
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Essential Plugins
# ============================================================================

# Syntax highlighting (must be loaded before other plugins)
zinit light zdharma-continuum/fast-syntax-highlighting

# Fish-like autosuggestions
zinit light zsh-users/zsh-autosuggestions

# Additional completions (load before compinit)
zinit light zsh-users/zsh-completions

# Initialize completion system AFTER loading completion plugins
autoload -Uz compinit
compinit -d ~/.cache/zsh/zcompdump-$ZSH_VERSION

# History substring search (bind keys after loading)
zinit light zsh-users/zsh-history-substring-search

# FZF integration
zinit ice lucid wait
zinit snippet OMZP::fzf

# Git aliases and functions
zinit ice lucid wait
zinit snippet OMZL::git.zsh

# Docker completions
zinit ice lucid wait as"completion"
zinit snippet OMZP::docker

# npm completions
zinit ice lucid wait as"completion"
zinit snippet OMZP::npm

# Auto-pair brackets/quotes
zinit light hlissner/zsh-autopair

# Better cd with interactive menu
# DISABLED: Conflicts with cd completion
# zinit light skywind3000/z.lua

# Colorize man pages
zinit light ael-code/zsh-colored-man-pages
#+end_src

*** Completion System Configuration
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Enhanced Completion System
# ============================================================================

# Completion styling
zstyle ':completion:*' menu select                                    # Interactive menu
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'            # Case insensitive
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"              # Colored completion
zstyle ':completion:*' group-name ''                                  # Group results
zstyle ':completion:*:descriptions' format '%F{yellow}%B%d%b%f'      # Group descriptions
zstyle ':completion:*:warnings' format '%F{red}No matches found%f'   # No match warning
zstyle ':completion:*' verbose yes                                    # Verbose output
zstyle ':completion:*' use-cache yes                                  # Use cache
zstyle ':completion:*' cache-path ~/.cache/zsh/zcompcache            # Cache location

# Partial completion
zstyle ':completion:*' list-suffixes
zstyle ':completion:*' expand prefix suffix

# Process completion
zstyle ':completion:*:*:*:*:processes' command "ps -u $USER -o pid,user,comm -w -w"
zstyle ':completion:*:*:kill:*' menu yes select
zstyle ':completion:*:kill:*' force-list always

# Completion for custom commands
compdef _gnu_generic bat
compdef _gnu_generic eza
compdef _gnu_generic fd
compdef _gnu_generic rg
#+end_src

*** Key Bindings
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Key Bindings
# ============================================================================

# Use VIM keybindings
bindkey -v

# History substring search (bind to up/down arrows)
bindkey '^[[A' history-substring-search-up      # Up arrow
bindkey '^[[B' history-substring-search-down    # Down arrow
bindkey '^P' history-substring-search-up        # Ctrl+P
bindkey '^N' history-substring-search-down      # Ctrl+N

# Enhanced history search
bindkey '^R' history-incremental-search-backward
bindkey '^S' history-incremental-search-forward

# Word movement
bindkey '^[[1;5C' forward-word      # Ctrl+Right
bindkey '^[[1;5D' backward-word     # Ctrl+Left

# Line editing
bindkey '^A' beginning-of-line
bindkey '^E' end-of-line
bindkey '^K' kill-line
bindkey '^U' backward-kill-line
bindkey '^W' backward-kill-word
bindkey '^Y' yank

# Alt+. to insert last argument
bindkey '\e.' insert-last-word

# Delete key
bindkey '^[[3~' delete-char

# Home/End keys
bindkey '^[[H' beginning-of-line
bindkey '^[[F' end-of-line

# Accept autosuggestion
bindkey '^ ' autosuggest-accept              # Ctrl+Space
bindkey '^[[Z' autosuggest-accept            # Shift+Tab
#+end_src

*** PATH Configuration
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# PATH Configuration
# ============================================================================

# User binaries
export PATH="$HOME/.local/bin:$PATH"

# Doom Emacs
export PATH="$HOME/.config/emacs/bin:$PATH"

# NPM global packages
export PATH="$HOME/.npm/bin:$PATH"

# Rust cargo
[[ -d "$HOME/.cargo/bin" ]] && export PATH="$HOME/.cargo/bin:$PATH"
#+end_src

*** Tool Initialization
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Tool Initialization
# ============================================================================

# Zoxide - smart directory jumping
eval "$(zoxide init zsh)"

# FZF configuration
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --inline-info"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'

# Starship prompt (must be at end)
eval "$(starship init zsh)"
#+end_src

*** Functions
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Custom Functions
# ============================================================================

# Yazi - cd on quit
function yy() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
    yazi "$@" --cwd-file="$tmp"
    if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
        cd -- "$cwd"
    fi
    rm -f -- "$tmp"
}

# Create directory and cd into it
function mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Extract any archive
function extract() {
    if [ -f "$1" ]; then
        case "$1" in
            *.tar.bz2)   tar xjf "$1"     ;;
            *.tar.gz)    tar xzf "$1"     ;;
            *.bz2)       bunzip2 "$1"     ;;
            *.rar)       unrar x "$1"     ;;
            *.gz)        gunzip "$1"      ;;
            *.tar)       tar xf "$1"      ;;
            *.tbz2)      tar xjf "$1"     ;;
            *.tgz)       tar xzf "$1"     ;;
            *.zip)       unzip "$1"       ;;
            *.Z)         uncompress "$1"  ;;
            *.7z)        7z x "$1"        ;;
            *)           echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

# Quick backup of a file
function bak() {
    cp "$1" "$1.bak"
}

# Show directory stack
function d() {
    dirs -v | head -n 10
}

# Jump to directory in stack (e.g., "2" to jump to item 2)
for index in {1..9}; do
    alias "$index"="cd +${index}"
done
#+end_src

*** Aliases
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Aliases
# ============================================================================

# Navigation
alias cd="z"
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias ~="cd ~"
alias -- -="cd -"

# ls alternatives
if command -v eza &> /dev/null; then
    alias ls="eza --icons --group-directories-first"
    alias ll="eza --icons --group-directories-first -l"
    alias la="eza --icons --group-directories-first -la"
    alias lt="eza --icons --group-directories-first --tree"
    alias tree="eza --icons --tree"
else
    alias ls="ls --color=auto --group-directories-first"
    alias ll="ls -lh"
    alias la="ls -lah"
fi

# Safe file operations
alias rm="trash -i"
alias cp="cp -i"
alias mv="mv -i"
alias mkdir="mkdir -p"

# Better defaults
alias cat="bat"
alias grep="rg"
alias find="fd"
alias du="dust"
alias df="duf"
alias top="btop"
alias htop="btop"
alias neofetch="fastfetch"
alias fetch="fastfetch"

# Git aliases (in addition to OMZ git plugin)
alias g="git"
alias gs="git status"
alias ga="git add"
alias gc="git commit"
alias gp="git push"
alias gl="git pull"
alias gd="git diff"
alias gco="git checkout"
alias gb="git branch"
alias glog="git log --oneline --graph --decorate"

# Quick access
alias zshrc="nvim ~/.zshrc"
alias zshconfig="nvim ~/dotfile/dotfiles.org"
alias r="source ~/.zshrc"
alias reload="source ~/.zshrc"

# Package management
alias paci="sudo pacman --noconfirm -S"
alias pacr="sudo pacman -Rns"
alias pacs="pacman -Ss"
alias pacu="sudo pacman -Syu"
alias yayi="yay -S"
alias yays="yay -Ss"
alias update="sudo pacman --noconfirm -Syyuu && yay --noconfirm -Syyuua"
alias clean="yay -Sc && yay -Yc"

# System
alias shutdown="shutdown now"
alias reboot="reboot"
alias suspend="systemctl suspend"
alias hibernate="systemctl hibernate"

# Development
alias py="python3"
alias pip="pip3"
alias v="nvim"
alias vim="nvim"

# Misc
alias c="clear"
alias h="history"
alias j="jobs"
alias ports="netstat -tulanp"
alias wget="wget -c"
alias myip="curl ifconfig.me"
#+end_src

*** Fastfetch
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Fastfetch
# ============================================================================

# Show fastfetch on new terminal
if [[ -o interactive ]] && [[ -z "$TMUX" ]]; then
  fastfetch
fi
#+end_src

*** Performance: End Profiling
#+begin_src sh :tangle packages/zsh/.zshrc
# ============================================================================
# Performance Profiling (Optional)
# ============================================================================

# Uncomment to see profiling results
# zprof
#+end_src

*** Starship Prompt Configuration
#+begin_src toml :tangle packages/zsh/.config/starship.toml
# Starship Prompt Configuration
# Pure preset - Minimal, clean, single-line prompt

format = """
$username\
$hostname\
$directory\
$git_branch\
$git_state\
$git_status\
$cmd_duration\
$line_break\
$python\
$character"""

[directory]
style = "blue"

[character]
success_symbol = "[❯](purple)"
error_symbol = "[❯](red)"
vimcmd_symbol = "[❮](green)"

[git_branch]
format = "[$branch]($style)"
style = "bright-black"

[git_status]
format = "[[(*$conflicted$untracked$modified$staged$renamed$deleted)](218) ($ahead_behind$stashed)]($style)"
style = "cyan"
conflicted = "​"
untracked = "​"
modified = "​"
staged = "​"
renamed = "​"
deleted = "​"
stashed = "≡"

[git_state]
format = '\([$state( $progress_current/$progress_total)]($style)\) '
style = "bright-black"

[cmd_duration]
format = "[$duration]($style) "
style = "yellow"

[python]
format = "[$virtualenv]($style) "
style = "bright-black"
#+end_src

*** WM Selector Script
#+begin_src sh :tangle packages/zsh/.local/bin/select-wm.sh :shebang "#!/usr/bin/env sh"
WM="${1:-hyprland}"

case "$WM" in
  hyprland|sway|river|niri)
    # Special handling for hyprland executable
    if [ "$WM" = "hyprland" ]; then
      exec Hyprland
    else
      exec "$WM"
    fi
    ;;
  *)
    echo "Unknown WM: $WM"
    exit 1
    ;;
esac
#+end_src

* Doom Emacs
Extensible text editor and integrated development environment built on Emacs.

** init.el
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/init.el
;;; init.el -*- lexical-binding: t; -*-

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;  DO NOT EDIT DIRECTLY, THIS FILE IS AUTO-GENERATED WITH ORG-BABEL-TANGLE!  ;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; This file controls what Doom modules are enabled and what order they load
;; in. Remember to run 'doom sync' after modifying it!

;; NOTE Press 'SPC h d h' (or 'C-h d h' for non-vim users) to access Doom's
;;      documentation. There you'll find a "Module Index" link where you'll find
;;      a comprehensive list of Doom's modules and what flags they support.

;; NOTE Move your cursor over a module's name (or its flags) and press 'K' (or
;;      'C-c c k' for non-vim users) to view its documentation. This works on
;;      flags as well (those symbols that start with a plus).
;;
;;      Alternatively, press 'gd' (or 'C-c c d') on a module to browse its
;;      directory (for easy access to its source code).

(doom! :input
       ;;bidi              ; (tfel ot) thgir etirw uoy gnipleh
       chinese
       ;;japanese
       ;;layout            ; auie,ctsrnm is the superior home row

       :completion
       ;; company           ; the ultimate code completion backend
       ;; (helm              ; the *other* search engine for love and life
       ;;  +icons
       ;;  +fuzzy)
       ;;ido               ; the other *other* search engine...
       ;; (ivy              ; a search engine for love and life
       ;;  +fuzzy
       ;;  +icons
       ;;  +childframe)
       (vertico           ; the search engine of the future
        +icons)

       :ui
       ;;deft              ; notational velocity for Emacs
       doom              ; what makes DOOM look the way it does
       doom-dashboard    ; a nifty splash screen for Emacs
       doom-quit         ; DOOM quit-message prompts when you quit Emacs
       (emoji +unicode)  ; 🙂
       hl-todo           ; highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW
       hydra
       indent-guides     ; highlighted indent columns
       ligatures         ; ligatures and symbols to make your code pretty again
       ;;minimap           ; show a map of the code on the side
       modeline          ; snazzy, Atom-inspired modeline, plus API
       nav-flash         ; blink cursor line after big motions
       ;; neotree           ; a project drawer, like NERDTree for vim
       ophints           ; highlight the region an operation acts on
       (popup +defaults)   ; tame sudden yet inevitable temporary windows
       ;; tabs              ; a tab bar for Emacs
       treemacs          ; a project drawer, like neotree but cooler
       unicode           ; extended unicode support for various languages
       ;; (vc-gutter +pretty) ; vcs diff in the fringe
       ;; vi-tilde-fringe   ; fringe tildes to mark beyond EOB
       window-select     ; visually switch windows
       ;; workspaces        ; tab emulation, persistence & separate workspaces
       zen               ; distraction-free coding or writing

       :editor
       (evil +everywhere); come to the dark side, we have cookies
       file-templates    ; auto-snippets for empty files
       fold              ; (nigh) universal code folding
       (format  ; automated prettiness
        +onsave
        +lsp)
       ;; god               ; run Emacs commands without modifier keys
       ;; lispy             ; vim for lisp, for people who don't like vim
       ;; multiple-cursors  ; editing in many places at once
       ;; objed             ; text object editing for the innocent
       ;; parinfer          ; turn lisp into python, sort of
       ;; rotate-text       ; cycle region at point between text candidates
       snippets          ; my elves. They type so I don't have to
       word-wrap         ; soft wrapping with language-aware indent

       :emacs
       (dired             ; making dired pretty [functional]
        +icon
        +dirvish)
       electric          ; smarter, keyword-based electric-indent
       (ibuffer         ; interactive buffer management
        +icons)
       tramp
       undo              ; persistent, smarter undo for your inevitable mistakes
       vc                ; version-control and Emacs, sitting in a tree

       :term
       ;; eshell            ; the elisp shell that works everywhere
       ;; shell             ; simple shell REPL for Emacs
       ;; term              ; basic terminal emulator for Emacs
       vterm             ; the best terminal emulation in Emacs

       :checkers
       syntax              ; tasing you for every semicolon you forget
       (spell +aspell) ; tasing you for misspelling mispelling
       ;;grammar           ; tasing grammar mistake every you make

       :tools
       ;;ansible
       ;;biblio            ; Writes a PhD for you (citation needed)
       ;;collab            ; buffers with friends
       ;;debugger          ; FIXME stepping through code, to help you add bugs
       ;;direnv
       ;;docker
       ;;editorconfig      ; let someone else argue about tabs vs spaces
       ;;ein               ; tame Jupyter notebooks with emacs
       (eval +overlay)     ; run code, run (also, repls)
       ;; gist              ; interacting with github gists
       lookup              ; navigate your code and its documentation
       (lsp               ; M-x vscode
        +peek)
       magit             ; a git porcelain for Emacs
       make              ; run make tasks from Emacs
       ;;pass              ; password manager for nerds
       pdf               ; pdf enhancements
       ;;prodigy           ; FIXME managing external services & code builders
       rgb               ; creating color strings
       ;;taskrunner        ; taskrunner for all your projects
       ;;terraform         ; infrastructure as code
       ;;tmux              ; an API for interacting with tmux
       tree-sitter       ; syntax and parsing, sitting in a tree...
       ;;upload            ; map local to remote projects via ssh/ftp

       :os
       (:if IS-MAC macos)  ; improve compatibility with macOS
       tty               ; improve the terminal Emacs experience

       :lang
       ;;agda              ; types of types of types of types...
       ;;beancount         ; mind the GAAP
       ;;(cc +lsp)         ; C > C++ == 1
       ;;clojure           ; java with a lisp
       ;; common-lisp       ; if you've seen one lisp, you've seen them all
       ;;coq               ; proofs-as-programs
       ;;crystal           ; ruby at the speed of c
       ;;csharp            ; unity, .NET, and mono shenanigans
       ;;data              ; config/data formats
       ;;(dart +flutter)   ; paint ui and not much else
       ;;dhall
       ;;elixir            ; erlang done right
       ;;elm               ; care for a cup of TEA?
       emacs-lisp        ; drown in parentheses
       ;;erlang            ; an elegant language for a more civilized age
       ;;ess               ; emacs speaks statistics
       ;;factor
       ;;faust             ; dsp, but you get to keep your soul
       ;;fortran           ; in FORTRAN, GOD is REAL (unless declared INTEGER)
       ;;fsharp            ; ML stands for Microsoft's Language
       ;;fstar             ; (dependent) types and (monadic) effects and Z3
       ;;gdscript          ; the language you waited for
       ;;(go +lsp)         ; the hipster dialect
       ;;(graphql +lsp)    ; Give queries a REST
       ;;(haskell +lsp)    ; a language that's lazier than I am
       ;;hy                ; readability of scheme w/ speed of python
       ;;idris             ; a language you can depend on
       (json              ; At least it ain't XML
        +lsp)
       ;;(java +lsp)       ; the poster child for carpal tunnel syndrome
       (javascript        ; all(hope(abandon(ye(who(enter(here))))))
        +lsp
        +tree-sitter)
       ;;julia             ; a better, faster MATLAB
       ;;kotlin            ; a better, slicker Java(Script)
       (latex             ; writing papers in Emacs has never been so fun
        +cdlatex
        +lsp)
       ;;lean              ; for folks with too much to prove
       ;;ledger            ; be audit you can be
       (lua               ; one-based indices? one-based indices
        +lsp
        +tree-sitter
        +fennel)
       (markdown          ; writing docs for people to ignore
        +grip
        +tree-sitter)
       ;;nim               ; python + lisp at the speed of c
       ;; nix               ; I hereby declare "nix geht mehr!"
       ;;ocaml             ; an objective camel
       (org              ; organize your plain life in plain text
        +dragndrop
        +hugo
        +noter
        +pandoc
        +pomodoro
        +present
        +pretty)
       ;;php               ; perl's insecure younger brother
       ;;plantuml          ; diagrams for confusing people more
       ;;purescript        ; javascript, but functional
       (python            ; beautiful is better than ugly
        +lsp
        +tree-sitter)
       ;; qt                ; the 'cutest' gui framework ever
       ;;racket            ; a DSL for DSLs
       ;;raku              ; the artist formerly known as perl6
       ;;rest              ; Emacs as a REST client
       ;;rst               ; ReST in peace
       ;;(ruby +rails)     ; 1.step {|i| p "Ruby is #{i.even? ? 'love' : 'life'}"}
       (rust
        +lsp
        +tree-sitter)       ; Fe2O3.unwrap().unwrap().unwrap().unwrap()
       ;;scala             ; java, but good
       ;;(scheme +guile)   ; a fully conniving family of lisps
       (sh                ; she sells {ba,z,fi}sh shells on the C xor
        +lsp)
       ;;sml
       ;;solidity          ; do you need a blockchain? No.
       ;;swift             ; who asked for emoji variables?
       ;;terra             ; Earth and Moon in alignment for performance.
       (web               ; the tubes
        +lsp
        +tree-sitter)
       (yaml              ; JSON, but readable
        +lsp
        +tree-sitter)
       ;;zig               ; C, but simpler

       :email
       ;; (mu4e +org +gmail)
       ;;notmuch
       ;;(wanderlust +gmail)

       :app
       calendar
       ;;emms
       everywhere        ; *leave* Emacs!? You must be joking
       ;;irc               ; how neckbeards socialize
       ;;(rss +org)        ; emacs as an RSS reader
       ;;twitter           ; twitter client https://twitter.com/vnought

       :config
       ;; literate
       (default +bindings +smartparens))
#+end_src

** packages.el
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/packages.el
;; no-byte-compile: t; -*-
;;; $DOOMDIR/packages.el

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;  DO NOT EDIT DIRECTLY, THIS FILE IS AUTO-GENERATED WITH ORG-BABEL-TANGLE!  ;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; To install a package with Doom you must declare them here and run 'doom sync'
;; on the command line, then restart Emacs for the changes to take effect -- or
;; use 'M-x doom/reload'.

;; Orgmode
(package! org-autolist)
(package! org-appear)
(package! org-auto-tangle)

;; Denote
(package! denote)
(package! denote-menu)
(package! denote-org)
(package! denote-explore)
(package! consult-denote)
(package! denote-journal)

;; Claude Code
(package! inheritenv
  :recipe (:host github :repo "purcell/inheritenv"))
(package! claude-code
  :recipe (:host github :repo "stevemolitor/claude-code.el"))

;; Pulsar
(package! pulsar)
#+end_src

** config.el
*** Header
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;  DO NOT EDIT DIRECTLY, THIS FILE IS AUTO-GENERATED WITH ORG-BABEL-TANGLE!  ;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; Place your private configuration here! Remember, you do not need to run 'doom
;; sync' after modifying this file!
#+end_src

*** User Information
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(setq user-full-name "James"
      user-mail-address "jamesyuli@outlook.com")
#+end_src

*** UI
**** Font
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(setq doom-font (font-spec :family "Sarasa Term SC Nerd" :size 16 :weight 'Semibold)
      doom-variable-pitch-font (font-spec :family "Noto Sans CJK SC" :size 16)
      doom-unicode-font (font-spec :family "Symbols Nerd Font Mono" :size 16))
#+end_src

**** Theme
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(setq doom-theme 'modus-vivendi-tritanopia)
#+end_src

**** Line Numbers
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(setq display-line-numbers-type 'relative)
#+end_src
*** Misc
**** Touchpad Scrolling Fix
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; enable pixel-precise scrolling
(when (fboundp 'pixel-scroll-precision-mode)
  (pixel-scroll-precision-mode 1))
;; optional: reduce jumpiness from mouse-wheel settings
;; (setq mouse-wheel-scroll-amount '(0.01)   ; fraction of window (or use pixel values)
;;       mouse-wheel-progressive-speed nil
;;       mouse-wheel-follow-mouse t)
#+end_src
*** Key Binds
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; (map! "C-h" 'switch-to-prev-buffer)
;; (map! "C-l" 'switch-to-next-buffer)
;; (map! "C-S-l" 'recenter-top-bottom)
#+end_src

*** Which Key
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; (setq which-key-idle-delay 0.2)
(setq auto-save-visited-interval 15)
(auto-save-visited-mode +1)
#+end_src

*** Org Mode

**** Basic

***** Directory
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(setq org-directory "~/denote")
#+end_src

***** Capture Template
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! org
  (setq org-capture-templates
        `(("t" "Todo" entry (file "~/denote/meta/todo.org")
           ". * TODO %U %?" :empty-lines-after 1)
          ("i" "Inbox" entry (file "~/denote/meta/inbox.org")
           ". * %t %?" :empty-lines-after 1)
          ;; ("w" "Work" entry (file "~/org/work.org")
          ;;  ". * %t %?  %(org-set-tags \"work\")" :empty-lines-after 1)
          ;; ("j" "Journal" entry (file+datetree "~/org/journal.org")
          ;;  ". * %?" :jump-to-captured t :time-prompt t)
          )))
#+end_src

***** Babel
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! org
  (org-babel-do-load-languages
   'org-babel-load-languages
   '(
     (emacs-lisp . t)
     (python . t)
     (conf-toml . t)
     (rust . t)
     )))
#+end_src

***** Appearance
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! org
  (setq org-hide-emphasis-markers t)
  (setq org-pretty-entities t))
#+end_src

***** Pomodoro
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(setq org-pomodoro-length 30)
#+end_src

**** Agenda

***** Directory
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! org
  (setq org-agenda-files '("~/denote" "~/denote/journal")))
#+end_src

**** Extension Packages

***** Auto List
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(add-hook 'org-mode-hook
          (lambda () (org-autolist-mode)))
#+end_src

***** Org Appear
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! org
  (add-hook 'org-mode-hook 'org-appear-mode))
#+end_src

***** Org Auto Tangle
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! org
  (add-hook 'org-mode-hook 'org-auto-tangle-mode))
#+end_src

***** Safe List
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(setq org-auto-tangle-babel-safelist '(
                                       "~/example.org"
                                       "~/example2.org"
                                       ))
#+end_src

*** Denote

**** Core

***** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(use-package! denote
  :hook
  (dired-mode . denote-dired-mode)
  :config
  (denote-rename-buffer-mode 1)
  (setq denote-buffer-name-prefix "<NOTE> ")
  (setq denote-rename-buffer-format "[%k] %t")
  (setq denote-directory "~/denote")
  (setq denote-known-keywords nil)
  (setq denote-date-prompt-use-org-read-date t))
#+end_src

***** Key Binds
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(map! :leader
      (:prefix-map ("d" . "denote")
       :desc "new note" "n" #'denote
       :desc "new note + date" "N" #'denote-date
       ;; :desc "new note in subdir" "s" #'denote-subdirectory
       :desc "list all notes" "D" #'denote-menu-list-notes
       :desc "open/create note" "d" #'denote-open-or-create
       :desc "find link" "l" #'denote-find-link
       :desc "backlinks" "b" #'denote-backlinks
       :desc "backlink for heading" "B" #'denote-org-link-to-heading
       :desc "template" "t" #'denote-template
       :desc "capture region" "c" #'denote-region
       (:prefix ("i" . "insert")
        :desc "insert/create link" "l" #'denote-link-or-create
        :desc "insert/create link in bg" "L" #'denote-link-after-creating
        :desc "insert front matter" "f" #'denote-add-front-matter
        :desc "insert heading link" "h" #'denote-org-link-to-heading
        :desc "insert link matching REGEXP" "r" #'denote-add-links
        (:prefix ("d" . "dynamic blocks")
         :desc "links" "l" #'denote-org-dblock-insert-links
         :desc "backlinks" "b" #'denote-org-dblock-insert-backlinks
         :desc "files" "f" #'denote-org-dblock-insert-files
         :desc "missing links" "m" #'denote-org-dblock-insert-missing-links))
       (:prefix ("r" . "rename")
        :desc "rename note" "r" #'denote-rename-file
        :desc "rename keyword" "k" #'denote-rename-file-keywords
        :desc "rename signature" "s" #'denote-rename-file-signature
        :desc "rename front matter" "f" #'denote-rename-file-using-front-matter
        :desc "rename title" "t" #'denote-rename-file-title)))
#+end_src

**** Org

***** Key Binds
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(map! :leader
      (:prefix-map ("d" . "denote")
       :desc "backlink for heading" "B" #'denote-org-link-to-heading
       (:prefix ("i" . "insert")
        :desc "insert heading link" "h" #'denote-org-link-to-heading
        (:prefix ("d" . "dynamic blocks")
         :desc "links" "l" #'denote-org-dblock-insert-links
         :desc "backlinks" "b" #'denote-org-dblock-insert-backlinks
         :desc "files" "f" #'denote-org-dblock-insert-files
         :desc "missing links" "m" #'denote-org-dblock-insert-missing-links))))
#+end_src

**** Explore

***** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(use-package! denote-explore
  :after denote
  :config
  (require 'denote))
#+end_src

***** Key Binds
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! denote-explore
  (map! :leader
        (:prefix ("d" . "denote")
                 (:prefix ("e" . "explore")
                  :desc "network" "n" #'denote-explore-network
                  :desc "network regenerate" "N" #'denote-explore-network-regenerate

                  (:prefix ("c" . "count")
                   :desc "notes" "n" #'denote-explore-count-notes
                   :desc "keywords" "k" #'denote-explore-count-keywords)

                  (:prefix ("b" . "bar chart")
                   :desc "file types" "f" #'denote-explore-barchart-filetypes
                   :desc "keywords" "k" #'denote-explore-barchart-keywords
                   :desc "timeline" "t" #'denote-explore-barchart-timeline
                   :desc "degree" "d" #'denote-explore-barchart-degree
                   :desc "backlinks" "b" #'denote-explore-barchart-backlinks)

                  (:prefix ("r" . "random walks")
                   :desc "note" "n" #'denote-explore-random-note
                   :desc "regex" "r" #'denote-explore-random-regex
                   :desc "link" "l" #'denote-explore-random-link
                   :desc "keyword" "k" #'denote-explore-random-keyword)

                  (:prefix ("j" . "janitor")
                   :desc "duplicate notes" "d" #'denote-explore-duplicate-notes
                   :desc "duplicate notes(dired)" "D" #'denote-explore-duplicate-notes-dired
                   :desc "missing links" "l" #'denote-explore-missing-links
                   :desc "zero keywords" "z" #'denote-explore-zero-keywords
                   :desc "single keywords" "k" #'denote-explore-single-keywords
                   :desc "rename keywords" "r" #'denote-explore-rename-keywords
                   :desc "sync metadata" "s" #'denote-explore-sync-metadata
                   :desc "isolated files" "i" #'denote-explore-isolated-files)))))
#+end_src

***** Temporary Solution
Temporary solution for "denote-id-regexp" being obsolete in the new version of Denote.
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(after! denote
  (unless (boundp 'denote-id-regexp)
    ;; Try to find the actual variable name in your denote version
    (setq denote-id-regexp
          (or (and (boundp 'denote-identifier-regexp) denote-identifier-regexp)
              "[0-9]\\{8\\}T[0-9]\\{6\\}"))))  ; fallback pattern
#+end_src

**** Consult

***** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(use-package! consult-denote
  :config
  (consult-denote-mode 1))
#+end_src

***** Key Binds
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(map! :leader
      (:prefix-map ("d" . "denote")
       :desc "Search notes" "s" #'consult-denote-find
       :desc "Search notes w/grep" "S"
       #'consult-denote-grep))
#+end_src

**** Journal

***** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(use-package! denote-journal
  :after denote
  :config
  (setq denote-journal-title-format "%Y-%m-%d"))
#+end_src

***** Key Binds
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(map! :leader
      (:prefix-map ("d" . "denote")
       :desc "find/create journal" "j" #'denote-journal-new-or-existing-entry
       :desc "find/create journal w/date" "J" #'(lambda ()
                                                  (interactive)
                                                  (let ((current-prefix-arg '(4)))
                                                    (call-interactively #'denote-journal-new-or-existing-entry)))
       (:prefix ("i" . "insert")
        :desc "insert journal link" "j" #'denote-journal-link-or-create-entry
        :desc "insert journal link w/date" "J" #'(lambda ()
                                                   (interactive)
                                                   (let ((current-prefix-arg '(4)))
                                                     (call-interactively #'denote-journal-link-or-create-entry))))))
#+end_src

**** Git Sync
Automatic git sync for denote notes directory. Commits and pushes changes on save with smart commit messages, conflict handling, and offline support.

***** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Denote Git Sync Configuration
(defvar denote-git-auto-sync-enabled t
  "Enable automatic git sync on save for denote files.")

(defvar denote-git-directory (expand-file-name "~/denote")
  "Path to the denote notes directory.")

(defvar denote-git-remote-name "origin"
  "Git remote name to sync with.")

(defvar denote-git-branch "main"
  "Git branch name to sync with.")

(defvar denote-git-sync-in-progress nil
  "Lock to prevent concurrent sync operations.")

(defvar denote-git-periodic-sync-interval (* 15 60)
  "Interval in seconds for periodic sync (default: 15 minutes).")

(defvar denote-git-idle-sync-delay (* 5 60)
  "Idle time in seconds before triggering sync (default: 5 minutes).")

(defvar denote-git-periodic-timer nil
  "Timer object for periodic sync.")

(defvar denote-git-idle-timer nil
  "Timer object for idle sync.")
#+end_src

***** Helper Functions
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Helper: Check if file is in denote directory
(defun denote-in-denote-directory-p ()
  "Return t if current buffer file is in denote directory."
  (when buffer-file-name
    (string-prefix-p (expand-file-name denote-git-directory)
                     (expand-file-name buffer-file-name))))

;; Helper: Check if git repository exists
(defun denote-git-check-repo ()
  "Check if denote directory is a git repository."
  (let ((default-directory denote-git-directory))
    (= 0 (call-process "git" nil nil nil "rev-parse" "--git-dir"))))

;; Helper: Check internet connectivity
(defun denote-git-check-connectivity ()
  "Check if we can reach the git remote (basic connectivity test)."
  (let ((default-directory denote-git-directory))
    (= 0 (call-process "git" nil nil nil "ls-remote" "--exit-code" "-h" denote-git-remote-name))))

;; Helper: Generate smart commit message
(defun denote-git-format-commit-message ()
  "Generate a commit message based on changed files and timestamp."
  (let* ((default-directory denote-git-directory)
         (timestamp (format-time-string "%Y-%m-%d %H:%M:%S"))
         (status-output (shell-command-to-string "git status --short"))
         (lines (split-string status-output "\n" t))
         (changed-files (mapcar (lambda (line)
                                  (if (string-match "^[AMD?]+ +\\(.+\\)$" line)
                                      (file-name-nondirectory (match-string 1 line))
                                    nil))
                                lines))
         (changed-files (delq nil changed-files))
         (file-count (length changed-files)))
    (cond
     ((= file-count 0)
      (format "Update notes: %s" timestamp))
     ((= file-count 1)
      (format "Update %s\n\n%s" (car changed-files) timestamp))
     ((<= file-count 3)
      (format "Update %s\n\n%s"
              (mapconcat 'identity changed-files ", ")
              timestamp))
     (t
      (format "Update %d notes\n\n%s" file-count timestamp)))))
#+end_src

***** Core Sync Function
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Core sync function with offline support
(defun denote-git-sync (&optional quiet)
  "Safely sync denote directory with git: pull, commit, and push.
Handles conflicts and offline scenarios gracefully. If QUIET is non-nil, suppress messages."
  (interactive)
  (if denote-git-sync-in-progress
      (unless quiet (message "Denote sync already in progress, skipping..."))
    (setq denote-git-sync-in-progress t)
    (let ((default-directory denote-git-directory))
      (unless (denote-git-check-repo)
        (setq denote-git-sync-in-progress nil)
        (error "Denote directory is not a git repository: %s" denote-git-directory))

      ;; Run sync asynchronously
      (make-process
       :name "denote-git-sync"
       :buffer "*denote-git-sync*"
       :command (list "sh" "-c"
                      (format "cd '%s' && \
# Safety check: ensure no merge/rebase in progress
if [ -f .git/MERGE_HEAD ] || [ -d .git/rebase-merge ] || [ -d .git/rebase-apply ]; then \
  echo 'GIT_OPERATION_IN_PROGRESS'; \
  exit 1; \
fi && \
# Try to fetch (test connectivity)
if git fetch %s %s 2>&1; then \
  echo 'ONLINE'; \
  # Check for remote changes and merge
  if ! git diff --quiet HEAD..%s/%s 2>&1; then \
    if ! git merge --no-edit %s/%s 2>&1; then \
      git merge --abort 2>&1; \
      echo 'CONFLICT_DETECTED'; \
      exit 1; \
    fi; \
  fi; \
  # Check for local changes (modifications, deletions, additions)
  if [ -z \"$(git status --porcelain)\" ]; then \
    # No local changes, check for unpushed commits
    if git log %s/%s..HEAD 2>&1 | grep -q 'commit'; then \
      git push %s %s 2>&1 && echo 'PUSH_SUCCESS'; \
    else \
      echo 'NO_CHANGES'; \
    fi; \
  else \
    # Has local changes (including deletions), commit and push
    git add -A 2>&1 && \
    git commit -m \"$(cat <<'COMMIT_MSG_EOF'\n%s\nCOMMIT_MSG_EOF\n)\" 2>&1 && \
    git push %s %s 2>&1 && echo 'SYNC_SUCCESS'; \
  fi; \
else \
  # Offline mode - commit locally only
  echo 'OFFLINE'; \
  if [ -n \"$(git status --porcelain)\" ]; then \
    git add -A 2>&1 && \
    git commit -m \"$(cat <<'COMMIT_MSG_EOF'\n%s\nCOMMIT_MSG_EOF\n)\" 2>&1 && \
    echo 'OFFLINE_COMMIT_SUCCESS'; \
  else \
    echo 'OFFLINE_NO_CHANGES'; \
  fi; \
fi"
                              denote-git-directory
                              denote-git-remote-name
                              denote-git-branch
                              denote-git-remote-name
                              denote-git-branch
                              denote-git-remote-name
                              denote-git-branch
                              denote-git-remote-name
                              denote-git-branch
                              denote-git-remote-name
                              denote-git-branch
                              (denote-git-format-commit-message)
                              denote-git-remote-name
                              denote-git-branch
                              (denote-git-format-commit-message)))
       :sentinel
       (lambda (process event)
         (setq denote-git-sync-in-progress nil)
         (let ((output (with-current-buffer (process-buffer process)
                         (buffer-string))))
           (cond
            ((string-match-p "GIT_OPERATION_IN_PROGRESS" output)
             (unless quiet
               (message "⚠ Denote sync: Git operation in progress, skipping...")))
            ((string-match-p "CONFLICT_DETECTED" output)
             (message "⚠ Denote sync: Merge conflict detected! Please resolve manually in %s"
                      denote-git-directory)
             (when (fboundp 'alert)
               (alert (format "Merge conflict in denote notes!\n\nPlease open %s and resolve conflicts manually."
                              denote-git-directory)
                      :title "Denote Git Sync - Conflict"
                      :severity 'high)))
            ((string-match-p "SYNC_SUCCESS" output)
             (unless quiet (message "✓ Denote notes synced successfully")))
            ((string-match-p "PUSH_SUCCESS" output)
             (unless quiet (message "✓ Denote notes pushed successfully")))
            ((string-match-p "OFFLINE_COMMIT_SUCCESS" output)
             (unless quiet (message "📴 Offline: Changes committed locally (will push when online)")))
            ((string-match-p "OFFLINE_NO_CHANGES" output)
             (unless quiet (message "📴 Offline: No changes to commit")))
            ((string-match-p "NO_CHANGES" output)
             (unless quiet (message "✓ Denote notes already in sync")))
            ((string-match-p "fatal\\|error" output)
             (unless quiet
               (message "✗ Denote sync failed: %s"
                        (car (split-string output "\n" t)))))
            (t
             (unless quiet (message "✗ Denote sync completed with unknown status"))))))))))
#+end_src

***** Auto-Save Hook
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Auto-sync on save hook
(defun denote-git-auto-sync-on-save ()
  "Automatically sync denote notes after saving if enabled."
  (when (and denote-git-auto-sync-enabled
             (denote-in-denote-directory-p))
    (denote-git-sync t)))  ; t = quiet mode

;; Add to after-save-hook
(add-hook 'after-save-hook #'denote-git-auto-sync-on-save)
#+end_src

***** Startup Sync
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Sync on daemon startup
(defun denote-git-startup-sync ()
  "Sync denote notes when Emacs daemon starts."
  (when (and (daemonp) denote-git-auto-sync-enabled)
    (run-with-timer 2 nil (lambda () (denote-git-sync t)))))

;; Add to after-init-hook for daemon startup
(add-hook 'after-init-hook #'denote-git-startup-sync)
#+end_src

***** Periodic Sync Timer
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Start periodic sync timer
(defun denote-git-start-periodic-sync ()
  "Start periodic sync timer for denote notes."
  (interactive)
  (when denote-git-periodic-timer
    (cancel-timer denote-git-periodic-timer))
  (setq denote-git-periodic-timer
        (run-at-time denote-git-periodic-sync-interval
                     denote-git-periodic-sync-interval
                     (lambda () (denote-git-sync t))))
  (message "Denote periodic sync started (every %d minutes)"
           (/ denote-git-periodic-sync-interval 60)))

;; Stop periodic sync timer
(defun denote-git-stop-periodic-sync ()
  "Stop periodic sync timer for denote notes."
  (interactive)
  (when denote-git-periodic-timer
    (cancel-timer denote-git-periodic-timer)
    (setq denote-git-periodic-timer nil)
    (message "Denote periodic sync stopped")))

;; Start periodic sync automatically
(denote-git-start-periodic-sync)
#+end_src

***** Idle Sync Timer
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Start idle sync timer
(defun denote-git-start-idle-sync ()
  "Start idle sync timer for denote notes."
  (interactive)
  (when denote-git-idle-timer
    (cancel-timer denote-git-idle-timer))
  (setq denote-git-idle-timer
        (run-with-idle-timer denote-git-idle-sync-delay t
                             (lambda () (denote-git-sync t))))
  (message "Denote idle sync started (after %d minutes idle)"
           (/ denote-git-idle-sync-delay 60)))

;; Stop idle sync timer
(defun denote-git-stop-idle-sync ()
  "Stop idle sync timer for denote notes."
  (interactive)
  (when denote-git-idle-timer
    (cancel-timer denote-git-idle-timer)
    (setq denote-git-idle-timer nil)
    (message "Denote idle sync stopped")))

;; Start idle sync automatically
(denote-git-start-idle-sync)
#+end_src

***** Keybindings and Toggle
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Toggle auto-sync
(defun denote-git-toggle-auto-sync ()
  "Toggle automatic git sync for denote notes."
  (interactive)
  (setq denote-git-auto-sync-enabled (not denote-git-auto-sync-enabled))
  (if denote-git-auto-sync-enabled
      (progn
        (denote-git-start-periodic-sync)
        (denote-git-start-idle-sync))
    (progn
      (denote-git-stop-periodic-sync)
      (denote-git-stop-idle-sync)))
  (message "Denote auto-sync %s"
           (if denote-git-auto-sync-enabled "enabled" "disabled")))

;; Keybindings
(map! :leader
      (:prefix-map ("d" . "denote")
       (:prefix ("g" . "git")
        :desc "Sync notes" "s" #'denote-git-sync
        :desc "Toggle auto-sync" "t" #'denote-git-toggle-auto-sync)))
#+end_src

**** Blog / ox-hugo
Simple ox-hugo integration for publishing denote notes as blog posts. Blog posts are exported to a separate directory to avoid conflicts with org files.

***** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; ox-hugo blog configuration for Hugo site at ~/denote/blog/
;; Posts will be exported to ~/denote/blog/content/posts/
(defvar denote-blog-hugo-base-dir (expand-file-name "~/denote/blog/")
  "Hugo site base directory.")

(defvar denote-blog-hugo-section "posts"
  "Hugo section where blog posts are exported (creates content/posts/).")

;; Ensure Hugo content directory exists
(let ((content-dir (expand-file-name "content" denote-blog-hugo-base-dir)))
  (unless (file-directory-p content-dir)
    (make-directory content-dir t)))

;; Configure ox-hugo
(after! ox-hugo
  (setq org-hugo-base-dir denote-blog-hugo-base-dir
        org-hugo-section denote-blog-hugo-section))
#+end_src

***** Blog Post Creation
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(defun denote-blog-new-post ()
  "Create a new denote note with 'blog' keyword and ox-hugo properties."
  (interactive)
  (let* ((title (read-string "Blog post title: "))
         (keywords '("blog")))
    ;; Create denote note with blog keyword
    (denote title keywords nil nil)
    ;; Insert ox-hugo properties
    (save-excursion
      (goto-char (point-min))
      ;; Find the #+title line and add properties after it
      (when (re-search-forward "^#\\+title:" nil t)
        (end-of-line)
        (insert "\n#+hugo_base_dir: ~/denote/blog/")
        (insert "\n#+hugo_section: posts")
        (insert "\n#+export_file_name: " (file-name-base (buffer-file-name)))
        (insert "\n\n. * Blog Post Content\n")))))
#+end_src

***** Export Functions
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(defun denote-blog-export-current ()
  "Export current denote note to markdown using ox-hugo if it has 'blog' keyword."
  (interactive)
  (if (not buffer-file-name)
      (message "Not visiting a file")
    (let* ((keywords (denote-retrieve-keywords-value buffer-file-name (denote-filetype-heuristics buffer-file-name))))
      (if (member "blog" keywords)
          (progn
            (require 'ox-hugo)
            ;; Export to markdown
            (org-hugo-export-to-md)
            (message "Blog post exported to %s/content/%s/"
                     denote-blog-hugo-base-dir denote-blog-hugo-section))
        (message "Current note doesn't have 'blog' keyword")))))

(defun denote-blog-export-all ()
  "Export all denote notes with 'blog' keyword to markdown."
  (interactive)
  (let ((blog-files (denote-directory-files-matching-regexp "_blog"))
        (count 0))
    (if (not blog-files)
        (message "No blog posts found")
      (dolist (file blog-files)
        (with-current-buffer (find-file-noselect file)
          (condition-case err
              (progn
                (require 'ox-hugo)
                (org-hugo-export-to-md)
                (setq count (1+ count)))
            (error (message "Error exporting %s: %s" file err)))))
      (message "Exported %d blog post(s) to %s/content/%s/"
               count denote-blog-hugo-base-dir denote-blog-hugo-section))))
#+end_src

***** Fix: Ensure denote only opens .org files
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Ensure denote only considers .org files, not .md files
(after! denote
  (setq denote-file-type 'org)
  ;; Filter out markdown files from denote directory listings
  (advice-add 'denote-directory-files :filter-return
              (lambda (files)
                (seq-filter (lambda (file) (string-suffix-p ".org" file))
                            files))))
#+end_src

***** Keybindings
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(map! :leader
      (:prefix-map ("d" . "denote")
       (:prefix ("b" . "blog")
        :desc "New blog post" "n" #'denote-blog-new-post
        :desc "Export current" "e" #'denote-blog-export-current
        :desc "Export all blogs" "E" #'denote-blog-export-all)))
#+end_src

**** Completion Formatting
Custom functions to make the formatting of calling =denote-open-or-create= to be cleaner.
It would show up something like this instead:
|-----------------------------------------------------------------------------|
| Find file: note t_                                                          |
|-----------------------------------------------------------------------------|
| [ 2003-09-01 ] note title                                 keyword1 keyword2 |
|                                                                             |
|-----------------------------------------------------------------------------|
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; Simple denote completion formatting
(defun my-format-denote-candidate (file)
  "Format denote file for completion display with right-aligned keywords."
  (when (string-match-p "[0-9]\\{8\\}T[0-9]\\{6\\}" file)
    (let* ((full-path (expand-file-name file (denote-directory)))
           (date-str (ignore-errors (denote-retrieve-filename-identifier full-path)))
           (title (ignore-errors (denote-retrieve-filename-title full-path)))
           (keywords (ignore-errors (denote-retrieve-filename-keywords full-path))))
      (when date-str
        (let* ((formatted-date (format "[ %s-%s-%s ]"
                                       (substring date-str 0 4)
                                       (substring date-str 4 6)
                                       (substring date-str 6 8)))
               (formatted-title (if title
                                    (replace-regexp-in-string "-" " " title)
                                  ""))
               (formatted-keywords (cond
                                    ((listp keywords)
                                     (mapconcat (lambda (k) (replace-regexp-in-string "_" " " k)) keywords " "))
                                    ((stringp keywords)
                                     (replace-regexp-in-string "_" " " keywords))
                                    (t "")))
               ;; Calculate padding to right-align keywords dynamically
               (left-part (format "%s %s" formatted-date formatted-title))
               (window-width (window-width (minibuffer-window)))
               (padding-needed (max 1 (- window-width (length left-part) (length formatted-keywords) 2)))
               (padding (make-string padding-needed ?\s)))

          (if (and formatted-keywords (not (string-empty-p formatted-keywords)))
              (format "%s%s%s" left-part padding formatted-keywords)
            left-part))))))

;; Override the denote file prompt function
(defun my-denote-file-prompt (&optional files-matching-regexp prompt-text no-require-match &rest _ignore)
  "Custom denote file prompt with formatted display."
  (let* ((files (denote-directory-files files-matching-regexp))
         (file-alist (mapcar (lambda (file)
                               (let* ((relative-file (denote-get-file-name-relative-to-denote-directory file))
                                      (formatted (my-format-denote-candidate relative-file)))
                                 (cons (or formatted relative-file) file)))
                             files))
         (choice (completing-read
                  (or prompt-text "Select file: ")
                  file-alist nil
                  (unless no-require-match :require-match))))
    (cdr (assoc choice file-alist))))

;; Apply the override
(advice-add 'denote-file-prompt :override #'my-denote-file-prompt)
#+end_src

*** Projectile
**** Add Projects
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
;; (projectile-add-known-project "~/org")
(projectile-add-known-project "~/denote")
;; (projectile-add-known-project "~/roam")
(projectile-add-known-project "~/stow")
#+end_src
*** Claude Code
***** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(use-package! claude-code
  :after inheritenv
  :config
  (setq claude-code-terminal-backend 'vterm)
  (claude-code-mode)
  :bind
  (:repeat-map my-claude-code-map ("M" . claude-code-cycle-mode)))
#+end_src

***** Key Binds
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(map! :leader :desc "Claude Code" "e" #'claude-code-transient)
      ;; (:prefix-map ("e" . "Claude")
      ;;  :desc "Start" "e" #'claude-code-transient))
#+end_src
*** Pulsar
Pulse highlight line on demand or after running select functions
**** Configuration
#+begin_src emacs-lisp :tangle packages/doom/.config/doom/config.el
(use-package! pulsar
  :config
  (require 'pulsar)

  ;; Check the default value of `pulsar-pulse-functions'.  That is where
  ;; you add more commands that should cause a pulse after they are
  ;; invoked

  (setq pulsar-pulse t)
  (setq pulsar-delay 0.055)
  (setq pulsar-iterations 10)
  (setq pulsar-face 'pulsar-magenta)
  (setq pulsar-highlight-face 'pulsar-yellow)

  (pulsar-global-mode 1)

  ;; OR use the local mode for select mode hooks

  (dolist (hook '(org-mode-hook emacs-lisp-mode-hook))
    (add-hook hook #'pulsar-mode))

  ;; pulsar does not define any key bindings.  This is just a sample that
  ;; respects the key binding conventions.  Evaluate:
  ;;
  ;;     (info "(elisp) Key Binding Conventions")
  ;;
  ;; The author uses C-x l for `pulsar-pulse-line' and C-x L for
  ;; `pulsar-highlight-line'.
  ;;
  ;; You can replace `pulsar-highlight-line' with the command
  ;; `pulsar-highlight-dwim'.
  ;; (let ((map global-map))
  ;;   (define-key map (kbd "C-c h p") #'pulsar-pulse-line)
  ;;   (define-key map (kbd "C-c h h") #'pulsar-highlight-line))

  ;; Use pulsar with next-error
  (add-hook 'next-error-hook #'pulsar-pulse-line)

  ;; Use pulsar in the minibuffer
  (add-hook 'minibuffer-setup-hook #'pulsar-pulse-line-blue)

  ;; Use pulsar with other packages

  ;;; integration with the `consult' package:
  (add-hook 'consult-after-jump-hook #'pulsar-recenter-top)
  (add-hook 'consult-after-jump-hook #'pulsar-reveal-entry))
#+end_src
